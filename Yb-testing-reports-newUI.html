<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        #table-container {
            height: 90vh; /* Adjust this value as needed */
            overflow-y: auto;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            top: 100%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.6rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="container">
        <div id="brd">
            <!-- The content will be inserted here -->
        </div>
    </div>
    <div class="px-4 sm:px-6 lg:px-8">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-base font-semibold leading-6 text-white"></h1>
                <p class="mt-2 text-sm text-gray-300"></p>
            </div>
            <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                <select id="timeframe" class="rounded-md bg-gray-800 text-white">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="2 days ago">2 Days Ago</option>
                    <option value="3 days ago">3 Days Ago</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-1 gap-px bg-white/5 sm:grid-cols-2 lg:grid-cols-4" id="test-data">
            <!-- Test data will be inserted here -->
        </div>
        <div id="table-container">
            <table class="mt-6 w-full whitespace-nowrap text-left">
                <colgroup>
                    <col class="lg:w-2/12">
                    <col class="lg:w-1/12">
                    <col class="lg:w-1/12">
                </colgroup>
                <thead class="border-b border-white/10 text-sm leading-6 text-white">
                    <tr>
                        <th scope="col" class="relative px-7 sm:w-12 sm:px-6">
                            <input type="checkbox" id="select-all" class="absolute left-4 top-1/2 -mt-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
                        </th>
                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-0" id="test-name-header">Test Name</th>
                        <th scope="col" class="py-2 pl-0 pr-4 text-right font-semibold sm:pr-8 sm:text-left lg:pr-20">Status</th>
                        <th scope="col" class="hidden py-2 pl-0 pr-4 text-right font-semibold sm:table-cell sm:pr-6 lg:pr-8">Last Run</th>
                    </tr>
                </thead>
<tbody class="border-t border-gray-800 divide-y divide-gray-800 bg-gray-900" id="table-body">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        window.onload = function() {
            const timeframeDropdown = document.getElementById('timeframe');
            timeframeDropdown.addEventListener('change', function() {
                const timeframe = this.value;
                fetchData(timeframe);
            });
            fetchData('today');

            const selectAllCheckbox = document.getElementById('select-all');
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                toggleBulkActions(this.checked);
            });

            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('row-checkbox')) {
                    const checkboxes = document.querySelectorAll('.row-checkbox');
                    const isChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
                    toggleBulkActions(isChecked);
                }
            });
        };

        function toggleBulkActions(isChecked) {
            const testNameHeader = document.getElementById('test-name-header');
            if (isChecked) {
                testNameHeader.innerHTML = `
                    <button type="button" id="run-tests-btn" class="inline-flex items-center rounded bg-white px-2 py-1 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Run Tests</button>
                `;
                const runTestsBtn = document.getElementById('run-tests-btn');
                runTestsBtn.addEventListener('click', function() {
                    const checkboxes = Array.from(document.querySelectorAll('.row-checkbox:checked'));
                    const filePaths = Array.from(new Set(checkboxes.map(checkbox => checkbox.getAttribute('data-file-path'))));
                    runTestsBtn.textContent = 'Running...';
                    filePaths.forEach(filePath => {
                        axios.post('https://xhy5at2dbpxeys62rsx4f6lfay0yigqt.lambda-url.us-west-2.on.aws/', { filePath: filePath })
                        .then(function (response) {
                            alert(JSON.stringify(response.data));
                            runTestsBtn.textContent = 'Run Tests';
                            checkboxes.forEach(checkbox => {
                                checkbox.checked = false;
                            });
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                    });
                });
            } else {
                testNameHeader.textContent = 'Test Name';
            }
        }

        function fetchData(timeframe) {
            axios.post('https://ikl44fvfsuqv2rmy7el3lwxq5a0eihwc.lambda-url.us-west-2.on.aws/', {timeframe: timeframe})
            .then(function (response) {
                const test_data = response.data;
                const tbody = document.querySelector('tbody');
                const container = document.getElementById('test-data');
                let total = 0;
                tbody.innerHTML = '';
                container.innerHTML = '';
                for (const [key, value] of Object.entries(test_data)) {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-900 px-4 py-6 sm:px-6 lg:px-8';

                    const p1 = document.createElement('p');
                    p1.className = 'text-sm font-medium leading-6 text-gray-400';
                    p1.textContent = key;

                    const p2 = document.createElement('p');
                    p2.className = 'mt-2 flex items-baseline gap-x-2';

                    const span = document.createElement('span');
                    span.className = 'text-4xl font-semibold tracking-tight text-white';
                    span.textContent = value.total;

                    p2.appendChild(span);
                    div.appendChild(p1);
                    div.appendChild(p2);
                    container.appendChild(div);

                    total += value.total;
                }

                const totalDiv = document.createElement('div');
                totalDiv.className = 'bg-gray-900 px-4 py-6 sm:px-6 lg:px-8';

                const totalP1 = document.createElement('p');
                totalP1.className = 'text-sm font-medium leading-6 text-gray-400';
                totalP1.textContent = 'Total';

                const totalP2 = document.createElement('p');
                totalP2.className = 'mt-2 flex items-baseline gap-x-2';

                const totalSpan = document.createElement('span');
                totalSpan.className = 'text-4xl font-semibold tracking-tight text-white';
                totalSpan.textContent = total;

                totalP2.appendChild(totalSpan);
                totalDiv.appendChild(totalP1);
                totalDiv.appendChild(totalP2);
                container.appendChild(totalDiv);

                Object.keys(test_data).sort((a, b) => {
                    if (a === 'Passed') return -1;
                    if (b === 'Passed') return 1;
                    if (a === 'Failed') return -1;
                    if (b === 'Failed') return 1;
                    return 0;
                }).forEach(status => {
                    test_data[status].tests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(data => {
                        const tr = document.createElement('tr');
                        let statusClass = '';
                        if (status === 'Passed') {
                            statusClass = 'bg-green-400/10';
                        } else if (status === 'Failed') {
                            statusClass = 'bg-red-400/10';
                        } else if (status === 'Untested') {
                            statusClass = 'bg-yellow-400/10';
                        }
                        tr.innerHTML = `
                            <td class="relative px-7 sm:w-12 sm:px-6">
                                <input type="checkbox" class="row-checkbox absolute left-4 top-1/2 -mt-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600" data-file-path="${data.file_path}">
                            </td>
                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-300">
                                <div class="ml-4">
                                    <div class="tooltip font-medium text-white">${data.formatted_test_name}<span class="tooltiptext">${data.file_path}</span></div>
                                    <div class="flex space-x-2 mt-1">
                                        <div class="inline-flex items-center rounded-md px-1 py-0.5 text-xs font-medium ring-1 ring-inset bg-blue-50 text-blue-700 ring-blue-600">${data.team}</div>
                                        <div class="inline-flex items-center rounded-md px-1 py-0.5 text-xs font-medium ring-1 ring-inset bg-purple-50 text-purple-700 ring-purple-600">${data.test_type}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-4 pl-0 pr-4 text-sm leading-6 sm:pr-8 lg:pr-20">
                                <div class="flex items-center justify-end gap-x-2 sm:justify-start">
                                    <time class="text-gray-400 sm:hidden" datetime="${data.timestamp}">${data.timestamp}</time>
                                    <div class="flex-none rounded-full p-1 ${statusClass}">
                                        <div class="h-2.5 w-2.5 rounded-full bg-${status === 'Passed' ? 'green' : status === 'Failed' ? 'red' : 'yellow'}-600" style="border: 2px solid rgba(152, 251, 152, 0.1);"></div>
                                    </div>
                                    <div class="hidden text-white sm:block">${status}</div>
                                </div>
                            </td>
                            <td class="hidden py-4 pl-0 pr-4 text-right text-sm leading-6 text-gray-400 sm:table-cell sm:pr-6 lg:pr-8">
                                <time datetime="${data.timestamp}">${data.timestamp}</time>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            })
            .catch(function (error) {
                console.log(error);
            });

        }
    </script>
</body>
</html>
