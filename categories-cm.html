<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories Management</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Inter font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900">
    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200" role="navigation" aria-label="main navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center">
                <span class="text-xl font-semibold">Your Brand</span>
            </div>
            <div>
                <button id="newCategoryBtn" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-label="Create new category">
                    New Category
                </button>
            </div>
        </div>
    </nav>

    <!-- Success and Error Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" tabindex="-1">
        <!-- Categories Section -->
        <div id="categoriesSection">
            <h2 class="text-2xl font-semibold mb-6">Categories</h2>
            <div id="categoriesList" class="bg-white rounded-md shadow divide-y divide-gray-200">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Subcategories Section -->
        <div id="subcategoriesSection" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 id="subcategoryTitle" class="text-2xl font-semibold">Subcategories</h2>
                <div class="flex items-center space-x-4">
                    <button id="newSubcategoryBtn" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-label="Create new subcategory">
                        New Subcategory
                    </button>
                    <button id="backButton" class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" aria-label="Back to categories">
                        Back to Categories
                    </button>
                </div>
            </div>
            <div id="subcategoriesList" class="bg-white rounded-md shadow divide-y divide-gray-200">
                <!-- Subcategories will be loaded here -->
            </div>
        </div>

        <!-- New Category Modal -->
        <div id="newCategoryModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-40" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="newCategoryModalTitle">
                <div class="px-6 py-4">
                    <h3 id="newCategoryModalTitle" class="text-lg leading-6 font-medium">Create New Category</h3>
                    <div class="mt-4">
                        <label for="categoryName" class="block text-sm font-medium">Category Name</label>
                        <input type="text" id="categoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelNewCategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveNewCategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Category Modal -->
        <div id="editCategoryModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-40" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="editCategoryModalTitle">
                <div class="px-6 py-4">
                    <h3 id="editCategoryModalTitle" class="text-lg leading-6 font-medium">Edit Category</h3>
                    <div class="mt-4">
                        <label for="editCategoryName" class="block text-sm font-medium">Category Name</label>
                        <input type="text" id="editCategoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelEditCategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveEditCategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- New Subcategory Modal -->
        <div id="newSubcategoryModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-40" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="newSubcategoryModalTitle">
                <div class="px-6 py-4">
                    <h3 id="newSubcategoryModalTitle" class="text-lg leading-6 font-medium">Create New Subcategory</h3>
                    <div class="mt-4">
                        <label for="subcategoryName" class="block text-sm font-medium">Subcategory Name</label>
                        <input type="text" id="subcategoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelNewSubcategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveNewSubcategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Subcategory Modal -->
        <div id="editSubcategoryModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-40" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="editSubcategoryModalTitle">
                <div class="px-6 py-4">
                    <h3 id="editSubcategoryModalTitle" class="text-lg leading-6 font-medium">Edit Subcategory</h3>
                    <div class="mt-4">
                        <label for="editSubcategoryName" class="block text-sm font-medium">Subcategory Name</label>
                        <input type="text" id="editSubcategoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelEditSubcategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveEditSubcategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        (function() {
            'use strict';
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Page loaded.');

                // Constants
                const API_URL = 'https://soa6mp6e2rilqgb7xz675agzeq0stbff.lambda-url.us-west-2.on.aws/';

                // DOM Elements
                const categoriesList = document.getElementById('categoriesList');
                const categoriesSection = document.getElementById('categoriesSection');
                const subcategoriesSection = document.getElementById('subcategoriesSection');
                const subcategoriesList = document.getElementById('subcategoriesList');
                const backButton = document.getElementById('backButton');
                const subcategoryTitle = document.getElementById('subcategoryTitle');
                const newCategoryBtn = document.getElementById('newCategoryBtn');
                const newCategoryModal = document.getElementById('newCategoryModal');
                const editCategoryModal = document.getElementById('editCategoryModal');
                const categoryNameInput = document.getElementById('categoryName');
                const saveNewCategoryBtn = document.getElementById('saveNewCategory');
                const cancelNewCategoryBtn = document.getElementById('cancelNewCategory');
                const editCategoryNameInput = document.getElementById('editCategoryName');
                const saveEditCategoryBtn = document.getElementById('saveEditCategory');
                const cancelEditCategoryBtn = document.getElementById('cancelEditCategory');
                const newSubcategoryBtn = document.getElementById('newSubcategoryBtn');
                const newSubcategoryModal = document.getElementById('newSubcategoryModal');
                const subcategoryNameInput = document.getElementById('subcategoryName');
                const saveNewSubcategoryBtn = document.getElementById('saveNewSubcategory');
                const cancelNewSubcategoryBtn = document.getElementById('cancelNewSubcategory');
                const editSubcategoryModal = document.getElementById('editSubcategoryModal');
                const editSubcategoryNameInput = document.getElementById('editSubcategoryName');
                const saveEditSubcategoryBtn = document.getElementById('saveEditSubcategory');
                const cancelEditSubcategoryBtn = document.getElementById('cancelEditSubcategory');
                const messageContainer = document.getElementById('messageContainer');

                // Application State
                let categoriesData = [];
                let currentCategory = null;
                let editingCategory = null;
                let editingSubcategory = null;

                // Helper Functions
                const apiRequest = async (data) => {
                    console.log('API Request:', data);
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ body: JSON.stringify(data) })
                        });
                        if (!response.ok) {
                            throw new Error(`Network response was not ok. Status code: ${response.status}`);
                        }
                        const result = await response.json();
                        console.log('API Response:', result);
                        return result;
                    } catch (error) {
                        console.error('API Error:', error);
                        throw error;
                    }
                };

                const showMessage = (type, text) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `max-w-sm w-full ${type === 'error' ? 'bg-red-50 border border-red-500' : 'bg-green-50 border border-green-500'} text-sm rounded-md shadow-md p-4 flex items-center`;
                    messageDiv.innerHTML = `
                        <svg class="h-5 w-5 ${type === 'error' ? 'text-red-500' : 'text-green-500'} mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'}
                        </svg>
                        <span>${text}</span>
                    `;
                    messageContainer.appendChild(messageDiv);

                    setTimeout(() => {
                        messageDiv.classList.add('opacity-0');
                        setTimeout(() => {
                            messageDiv.remove();
                        }, 500);
                    }, 3000);
                };

                // Category Manager Class
                class CategoryManager {
                    async fetchCategories() {
                        console.log('Fetching all categories.');
                        categoriesList.innerHTML = '<div class="p-4 text-center text-gray-500">Loading categories...</div>';

                        const data = {
                            entity: 'category',
                            operation: 'read_all'
                        };

                        try {
                            const response = await apiRequest(data);
                            categoriesData = response;
                            this.displayCategories(response);
                        } catch (error) {
                            showMessage('error', 'Error fetching categories: ' + error.message);
                            categoriesList.innerHTML = '<div class="p-4 text-red-500">Error fetching categories.</div>';
                        }
                    }

                    displayCategories(categories) {
                        console.log('Displaying categories.');
                        categoriesList.innerHTML = '';

                        if (categories.length === 0) {
                            categoriesList.innerHTML = '<div class="p-4 text-center text-gray-500">No categories available.</div>';
                            return;
                        }

                        categories.forEach(category => {
                            const div = document.createElement('div');
                            div.classList.add('flex', 'items-center', 'justify-between', 'px-4', 'py-4', 'hover:bg-gray-50');

                            const info = document.createElement('div');
                            info.classList.add('flex', 'items-center', 'space-x-3');

                            const title = document.createElement('a');
                            title.classList.add('text-lg', 'font-medium', 'text-indigo-600', 'hover:text-indigo-500', 'cursor-pointer');
                            title.innerText = category.CategoryName;
                            title.setAttribute('href', '#');
                            title.addEventListener('click', (event) => {
                                event.preventDefault();
                                console.log('Category clicked:', category.CategoryID);
                                currentCategory = category;
                                subcategoryManager.displaySubcategories(category);
                            });

                            info.appendChild(title);
                            div.appendChild(info);

                            const actions = document.createElement('div');
                            actions.classList.add('flex', 'items-center', 'space-x-2');

                            // Edit Button
                            const editBtn = document.createElement('button');
                            editBtn.classList.add('text-gray-600', 'hover:text-gray-800', 'focus:outline-none');
                            editBtn.setAttribute('aria-label', 'Edit category');
                            editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Edit" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 17.5A1.5 1.5 0 003.5 19h13a1.5 1.5 0 001.5-1.5V9a1 1 0 112 0v8.5A3.5 3.5 0 0116.5 21h-13A3.5 3.5 0 010 17.5v-13A3.5 3.5 0 013.5 1h8.5a1 1 0 110 2H3.5A1.5 1.5 0 002 4.5v13z" clip-rule="evenodd"/></svg>';
                            editBtn.addEventListener('click', () => {
                                console.log('Edit category clicked:', category.CategoryID);
                                editingCategory = category;
                                editCategoryNameInput.value = category.CategoryName;
                                editCategoryModal.classList.remove('hidden');
                                editCategoryModal.setAttribute('aria-hidden', 'false');
                            });

                            // Delete Button
                            const deleteBtn = document.createElement('button');
                            deleteBtn.classList.add('text-red-600', 'hover:text-red-800', 'focus:outline-none');
                            deleteBtn.setAttribute('aria-label', 'Delete category');
                            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Delete" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.366-.36.858-.576 1.39-.576h.707c.531 0 1.023.216 1.389.576l1.036 1.036H15.5a1 1 0 110 2h-.097l-.867 12.172a2 2 0 01-1.996 1.828H7.46a2 2 0 01-1.996-1.828L4.596 6.135a1 1 0 01-.096-2h1.485l1.036-1.036zM6.5 7a1 1 0 000 2h7a1 1 0 100-2h-7z" clip-rule="evenodd"/></svg>';
                            deleteBtn.addEventListener('click', () => {
                                console.log('Delete category clicked:', category.CategoryID);
                                if (confirm('Are you sure you want to delete this category?')) {
                                    this.deleteCategory(category.CategoryID);
                                }
                            });

                            actions.appendChild(editBtn);
                            actions.appendChild(deleteBtn);
                            div.appendChild(actions);

                            categoriesList.appendChild(div);
                        });
                    }

                    async createCategory() {
                        const categoryName = categoryNameInput.value.trim();
                        if (!categoryName) {
                            alert('Please enter a category name.');
                            return;
                        }

                        saveNewCategoryBtn.disabled = true;
                        saveNewCategoryBtn.innerText = 'Saving...';

                        const data = {
                            entity: 'category',
                            operation: 'create',
                            item: {
                                CategoryID: Date.now().toString(),
                                CategoryName: categoryName
                            }
                        };

                        try {
                            await apiRequest(data);
                            saveNewCategoryBtn.disabled = false;
                            saveNewCategoryBtn.innerText = 'Save';
                            newCategoryModal.classList.add('hidden');
                            newCategoryModal.setAttribute('aria-hidden', 'true');
                            categoryNameInput.value = '';
                            showMessage('success', 'Category created successfully.');
                            this.fetchCategories();
                        } catch (error) {
                            saveNewCategoryBtn.disabled = false;
                            saveNewCategoryBtn.innerText = 'Save';
                            showMessage('error', 'Error creating category.');
                        }
                    }

                    async updateCategory() {
                        const categoryName = editCategoryNameInput.value.trim();
                        if (!categoryName) {
                            alert('Please enter a category name.');
                            return;
                        }

                        saveEditCategoryBtn.disabled = true;
                        saveEditCategoryBtn.innerText = 'Saving...';

                        const data = {
                            entity: 'category',
                            operation: 'update',
                            CategoryID: editingCategory.CategoryID,
                            update_fields: {
                                CategoryName: categoryName
                            }
                        };

                        try {
                            await apiRequest(data);
                            saveEditCategoryBtn.disabled = false;
                            saveEditCategoryBtn.innerText = 'Save Changes';
                            editCategoryModal.classList.add('hidden');
                            editCategoryModal.setAttribute('aria-hidden', 'true');
                            editingCategory = null;
                            showMessage('success', 'Category updated successfully.');
                            this.fetchCategories();
                        } catch (error) {
                            saveEditCategoryBtn.disabled = false;
                            saveEditCategoryBtn.innerText = 'Save Changes';
                            showMessage('error', 'Error updating category.');
                        }
                    }

                    async deleteCategory(categoryID) {
                        console.log('Deleting category:', categoryID);
                        const data = {
                            entity: 'category',
                            operation: 'delete',
                            CategoryID: categoryID
                        };

                        try {
                            await apiRequest(data);
                            showMessage('success', 'Category deleted successfully.');
                            this.fetchCategories();
                        } catch (error) {
                            showMessage('error', 'Error deleting category.');
                        }
                    }
                }

                // Subcategory Manager Class
                class SubcategoryManager {
                    displaySubcategories(category) {
                        console.log('Displaying subcategories for category:', category.CategoryName);
                        categoriesSection.classList.add('hidden');
                        subcategoriesSection.classList.remove('hidden');
                        subcategoriesList.innerHTML = '';
                        subcategoryTitle.innerText = 'Subcategories of ' + category.CategoryName;

                        if (Array.isArray(category.SubCategories) && category.SubCategories.length > 0) {
                            category.SubCategories.forEach(subcategory => {
                                const div = document.createElement('div');
                                div.classList.add('flex', 'items-center', 'justify-between', 'px-4', 'py-4', 'hover:bg-gray-50');

                                const name = document.createElement('div');
                                name.classList.add('text-sm', 'font-medium');
                                name.innerText = subcategory.SubCategoryName;

                                div.appendChild(name);

                                const actions = document.createElement('div');
                                actions.classList.add('flex', 'items-center', 'space-x-2');

                                // Edit Button
                                const editBtn = document.createElement('button');
                                editBtn.classList.add('text-gray-600', 'hover:text-gray-800', 'focus:outline-none');
                                editBtn.setAttribute('aria-label', 'Edit subcategory');
                                editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Edit" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 17.5A1.5 1.5 0 003.5 19h13a1.5 1.5 0 001.5-1.5V9a1 1 0 112 0v8.5A3.5 3.5 0 0116.5 21h-13A3.5 3.5 0 010 17.5v-13A3.5 3.5 0 013.5 1h8.5a1 1 0 110 2H3.5A1.5 1.5 0 002 4.5v13z" clip-rule="evenodd"/></svg>';
                                editBtn.addEventListener('click', () => {
                                    console.log('Edit subcategory clicked:', subcategory.SubCategoryID);
                                    editingSubcategory = subcategory;
                                    editSubcategoryNameInput.value = subcategory.SubCategoryName;
                                    editSubcategoryModal.classList.remove('hidden');
                                    editSubcategoryModal.setAttribute('aria-hidden', 'false');
                                });

                                // Delete Button
                                const deleteBtn = document.createElement('button');
                                deleteBtn.classList.add('text-red-600', 'hover:text-red-800', 'focus:outline-none');
                                deleteBtn.setAttribute('aria-label', 'Delete subcategory');
                                deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Delete" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.366-.36.858-.576 1.39-.576h.707c.531 0 1.023.216 1.389.576l1.036 1.036H15.5a1 1 0 110 2h-.097l-.867 12.172a2 2 0 01-1.996 1.828H7.46a2 2 0 01-1.996-1.828L4.596 6.135a1 1 0 01-.096-2h1.485l1.036-1.036zM6.5 7a1 1 0 000 2h7a1 1 0 100-2h-7z" clip-rule="evenodd"/></svg>';
                                deleteBtn.addEventListener('click', () => {
                                    console.log('Delete subcategory clicked:', subcategory.SubCategoryID);
                                    if (confirm('Are you sure you want to delete this subcategory?')) {
                                        this.deleteSubcategory(subcategory.SubCategoryID);
                                    }
                                });

                                actions.appendChild(editBtn);
                                actions.appendChild(deleteBtn);
                                div.appendChild(actions);

                                subcategoriesList.appendChild(div);
                            });
                        } else {
                            subcategoriesList.innerHTML = '<div class="p-4 text-center text-gray-500">No subcategories available.</div>';
                        }
                    }

                    async createSubcategory() {
                        const subcategoryName = subcategoryNameInput.value.trim();
                        if (!subcategoryName) {
                            alert('Please enter a subcategory name.');
                            return;
                        }

                        saveNewSubcategoryBtn.disabled = true;
                        saveNewSubcategoryBtn.innerText = 'Saving...';

                        const newSubcategory = {
                            SubCategoryID: Date.now().toString(),
                            SubCategoryName: subcategoryName
                        };

                        const updatedSubCategories = currentCategory.SubCategories ? currentCategory.SubCategories.slice() : [];
                        updatedSubCategories.push(newSubcategory);

                        const data = {
                            entity: 'category',
                            operation: 'update',
                            CategoryID: currentCategory.CategoryID,
                            update_fields: {
                                SubCategories: updatedSubCategories
                            }
                        };

                        try {
                            await apiRequest(data);
                            saveNewSubcategoryBtn.disabled = false;
                            saveNewSubcategoryBtn.innerText = 'Save';
                            newSubcategoryModal.classList.add('hidden');
                            newSubcategoryModal.setAttribute('aria-hidden', 'true');
                            subcategoryNameInput.value = '';
                            showMessage('success', 'Subcategory created successfully.');
                            categoryManager.fetchCategories();
                            // Refresh current category data
                            currentCategory.SubCategories = updatedSubCategories;
                            this.displaySubcategories(currentCategory);
                        } catch (error) {
                            saveNewSubcategoryBtn.disabled = false;
                            saveNewSubcategoryBtn.innerText = 'Save';
                            showMessage('error', 'Error creating subcategory.');
                        }
                    }

                    async updateSubcategory() {
                        const subcategoryName = editSubcategoryNameInput.value.trim();
                        if (!subcategoryName) {
                            alert('Please enter a subcategory name.');
                            return;
                        }

                        saveEditSubcategoryBtn.disabled = true;
                        saveEditSubcategoryBtn.innerText = 'Saving...';

                        const updatedSubCategories = currentCategory.SubCategories.map(subcat => {
                            if (subcat.SubCategoryID === editingSubcategory.SubCategoryID) {
                                return { ...subcat, SubCategoryName: subcategoryName };
                            }
                            return subcat;
                        });

                        const data = {
                            entity: 'category',
                            operation: 'update',
                            CategoryID: currentCategory.CategoryID,
                            update_fields: {
                                SubCategories: updatedSubCategories
                            }
                        };

                        try {
                            await apiRequest(data);
                            saveEditSubcategoryBtn.disabled = false;
                            saveEditSubcategoryBtn.innerText = 'Save Changes';
                            editSubcategoryModal.classList.add('hidden');
                            editSubcategoryModal.setAttribute('aria-hidden', 'true');
                            editingSubcategory = null;
                            showMessage('success', 'Subcategory updated successfully.');
                            categoryManager.fetchCategories();
                            // Refresh current category data
                            currentCategory.SubCategories = updatedSubCategories;
                            this.displaySubcategories(currentCategory);
                        } catch (error) {
                            saveEditSubcategoryBtn.disabled = false;
                            saveEditSubcategoryBtn.innerText = 'Save Changes';
                            showMessage('error', 'Error updating subcategory.');
                        }
                    }

                    async deleteSubcategory(subcategoryID) {
                        console.log('Deleting subcategory:', subcategoryID);

                        const updatedSubCategories = currentCategory.SubCategories.filter(subcat => subcat.SubCategoryID !== subcategoryID);

                        const data = {
                            entity: 'category',
                            operation: 'update',
                            CategoryID: currentCategory.CategoryID,
                            update_fields: {
                                SubCategories: updatedSubCategories
                            }
                        };

                        try {
                            await apiRequest(data);
                            showMessage('success', 'Subcategory deleted successfully.');
                            categoryManager.fetchCategories();
                            // Refresh current category data
                            currentCategory.SubCategories = updatedSubCategories;
                            this.displaySubcategories(currentCategory);
                        } catch (error) {
                            showMessage('error', 'Error deleting subcategory.');
                        }
                    }
                }

                // Instantiate Managers
                const categoryManager = new CategoryManager();
                const subcategoryManager = new SubcategoryManager();

                // Event Listeners
                newCategoryBtn.addEventListener('click', () => {
                    console.log('New Category button clicked.');
                    newCategoryModal.classList.remove('hidden');
                    newCategoryModal.setAttribute('aria-hidden', 'false');
                    categoryNameInput.focus();
                });

                cancelNewCategoryBtn.addEventListener('click', () => {
                    newCategoryModal.classList.add('hidden');
                    newCategoryModal.setAttribute('aria-hidden', 'true');
                    categoryNameInput.value = '';
                });

                saveNewCategoryBtn.addEventListener('click', () => {
                    categoryManager.createCategory();
                });

                cancelEditCategoryBtn.addEventListener('click', () => {
                    editCategoryModal.classList.add('hidden');
                    editCategoryModal.setAttribute('aria-hidden', 'true');
                    editingCategory = null;
                });

                saveEditCategoryBtn.addEventListener('click', () => {
                    categoryManager.updateCategory();
                });

                newSubcategoryBtn.addEventListener('click', () => {
                    console.log('New Subcategory button clicked.');
                    newSubcategoryModal.classList.remove('hidden');
                    newSubcategoryModal.setAttribute('aria-hidden', 'false');
                    subcategoryNameInput.focus();
                });

                cancelNewSubcategoryBtn.addEventListener('click', () => {
                    newSubcategoryModal.classList.add('hidden');
                    newSubcategoryModal.setAttribute('aria-hidden', 'true');
                    subcategoryNameInput.value = '';
                });

                saveNewSubcategoryBtn.addEventListener('click', () => {
                    subcategoryManager.createSubcategory();
                });

                cancelEditSubcategoryBtn.addEventListener('click', () => {
                    editSubcategoryModal.classList.add('hidden');
                    editSubcategoryModal.setAttribute('aria-hidden', 'true');
                    editingSubcategory = null;
                });

                saveEditSubcategoryBtn.addEventListener('click', () => {
                    subcategoryManager.updateSubcategory();
                });

                backButton.addEventListener('click', () => {
                    console.log('Back button clicked.');
                    subcategoriesSection.classList.add('hidden');
                    categoriesSection.classList.remove('hidden');
                    currentCategory = null;
                });

                // Fetch initial categories
                categoryManager.fetchCategories();

                // Keyboard accessibility
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!newCategoryModal.classList.contains('hidden')) {
                            cancelNewCategoryBtn.click();
                        } else if (!editCategoryModal.classList.contains('hidden')) {
                            cancelEditCategoryBtn.click();
                        } else if (!newSubcategoryModal.classList.contains('hidden')) {
                            cancelNewSubcategoryBtn.click();
                        } else if (!editSubcategoryModal.classList.contains('hidden')) {
                            cancelEditSubcategoryBtn.click();
                        }
                    }
                });

                // Focus management when modals are opened
                const modals = [newCategoryModal, editCategoryModal, newSubcategoryModal, editSubcategoryModal];
                modals.forEach(modal => {
                    modal.addEventListener('transitionend', () => {
                        if (!modal.classList.contains('hidden')) {
                            const input = modal.querySelector('input');
                            if (input) {
                                input.focus();
                            }
                        }
                    });
                });

            });
        })();
    </script>
</body>
</html>