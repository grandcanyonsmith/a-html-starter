<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories Management</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Inter font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
        }
        /* Custom Styles for better UI/UX */
        /* Add any additional styles here */
        /* Adjusted styles for desktop view */
        @media (min-width: 1024px) {
            #contentSection {
                grid-template-columns: 1fr 3fr;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-900">
    <!-- Navbar -->
    <nav class="bg-white shadow" role="navigation" aria-label="main navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <img src="your-logo.png" alt="Your Brand" class="h-8 w-auto">
                <span class="text-2xl font-bold">Your Brand</span>
            </div>
            <div>
                <button id="newCategoryBtn" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-label="Create new category">
                    New Category
                </button>
            </div>
        </div>
    </nav>

    <!-- Success and Error Messages -->
    <div id="messageContainer" class="fixed bottom-4 right-4 z-50 space-y-2" aria-live="polite"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Categories and Subcategories Section -->
        <div id="contentSection" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Sidebar -->
            <aside class="lg:col-span-1 bg-white rounded-lg shadow p-4">
                <h3 class="text-xl font-semibold mb-4">Categories</h3>
                <ul id="categoriesList" class="space-y-2">
                    <!-- Categories will be loaded here -->
                </ul>
                <button id="newCategoryBtnSidebar" class="mt-4 w-full py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-label="Create new category">
                    New Category
                </button>
            </aside>

            <!-- Main Content Area -->
            <section class="lg:col-span-1">
                <!-- Subcategories Section -->
                <div id="subcategoriesSection" class="hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="subcategoryTitle" class="text-2xl font-semibold">Subcategories</h2>
                        <div class="flex items-center space-x-4">
                            <button id="newSubcategoryBtn" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-label="Create new subcategory">
                                New Subcategory
                            </button>
                            <button id="backButton" class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" aria-label="Back to categories">
                                Back to Categories
                            </button>
                        </div>
                    </div>
                    <div id="subcategoriesList" class="grid grid-cols-1 gap-4">
                        <!-- Subcategories will be loaded here -->
                    </div>
                </div>

                <!-- Placeholder Section -->
                <div id="placeholderSection" class="h-full flex items-center justify-center text-gray-500">
                    <p>Select a category to view subcategories.</p>
                </div>
            </section>
        </div>

        <!-- New Category Modal -->
        <div id="newCategoryModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="px-6 py-4">
                    <h3 class="text-lg leading-6 font-medium">Create New Category</h3>
                    <div class="mt-4">
                        <label for="categoryName" class="block text-sm font-medium">Category Name</label>
                        <input type="text" id="categoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelNewCategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveNewCategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 disabled:opacity-50 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Category Modal -->
        <div id="editCategoryModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="px-6 py-4">
                    <h3 class="text-lg leading-6 font-medium">Edit Category</h3>
                    <div class="mt-4">
                        <label for="editCategoryName" class="block text-sm font-medium">Category Name</label>
                        <input type="text" id="editCategoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelEditCategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveEditCategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 disabled:opacity-50 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- New Subcategory Modal -->
        <div id="newSubcategoryModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="px-6 py-4">
                    <h3 class="text-lg leading-6 font-medium">Create New Subcategory</h3>
                    <div class="mt-4">
                        <label for="subcategoryName" class="block text-sm font-medium">Subcategory Name</label>
                        <input type="text" id="subcategoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">

                        <label for="subcategoryInstructions" class="block text-sm font-medium mt-4">Instructions</label>
                        <textarea id="subcategoryInstructions" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" rows="3"></textarea>

                        <label for="subcategoryExamples" class="block text-sm font-medium mt-4">Examples</label>
                        <textarea id="subcategoryExamples" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" rows="3"></textarea>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelNewSubcategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveNewSubcategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 disabled:opacity-50 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Subcategory Modal -->
        <div id="editSubcategoryModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="px-6 py-4">
                    <h3 class="text-lg leading-6 font-medium">Edit Subcategory</h3>
                    <div class="mt-4">
                        <label for="editSubcategoryName" class="block text-sm font-medium">Subcategory Name</label>
                        <input type="text" id="editSubcategoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" aria-required="true">

                        <label for="editSubcategoryInstructions" class="block text-sm font-medium mt-4">Instructions</label>
                        <textarea id="editSubcategoryInstructions" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" rows="3"></textarea>

                        <label for="editSubcategoryExamples" class="block text-sm font-medium mt-4">Examples</label>
                        <textarea id="editSubcategoryExamples" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" rows="3"></textarea>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelEditSubcategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </button>
                    <button id="saveEditSubcategory" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 disabled:opacity-50 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Subcategory Details Modal -->
        <div id="subcategoryDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden" aria-hidden="true">
            <div class="bg-white rounded-md overflow-hidden shadow-xl transform transition-all sm:max-w-xl sm:w-full">
                <div class="px-6 py-4">
                    <h3 id="detailsSubcategoryName" class="text-lg leading-6 font-medium">Subcategory Details</h3>
                    <div class="mt-4">
                        <h4 class="text-sm font-semibold">Instructions:</h4>
                        <p id="detailsSubcategoryInstructions" class="mt-1 text-sm text-gray-700"></p>

                        <h4 class="text-sm font-semibold mt-4">Examples:</h4>
                        <p id="detailsSubcategoryExamples" class="mt-1 text-sm text-gray-700"></p>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="closeSubcategoryDetails" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Close
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- JavaScript -->
    <script>
        (function() {
            'use strict';
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Page loaded.');

                // Constants
                const API_URL = 'https://soa6mp6e2rilqgb7xz675agzeq0stbff.lambda-url.us-west-2.on.aws/';
                const DDB_TABLE_NAME = 'Categories';

                // DOM Elements
                const categoriesList = document.getElementById('categoriesList');
                const subcategoriesSection = document.getElementById('subcategoriesSection');
                const subcategoriesList = document.getElementById('subcategoriesList');
                const backButton = document.getElementById('backButton');
                const subcategoryTitle = document.getElementById('subcategoryTitle');
                const newCategoryBtn = document.getElementById('newCategoryBtn');
                const newCategoryBtnSidebar = document.getElementById('newCategoryBtnSidebar');
                const newCategoryModal = document.getElementById('newCategoryModal');
                const editCategoryModal = document.getElementById('editCategoryModal');
                const categoryNameInput = document.getElementById('categoryName');
                const saveNewCategoryBtn = document.getElementById('saveNewCategory');
                const cancelNewCategoryBtn = document.getElementById('cancelNewCategory');
                const editCategoryNameInput = document.getElementById('editCategoryName');
                const saveEditCategoryBtn = document.getElementById('saveEditCategory');
                const cancelEditCategoryBtn = document.getElementById('cancelEditCategory');
                const newSubcategoryBtn = document.getElementById('newSubcategoryBtn');
                const newSubcategoryModal = document.getElementById('newSubcategoryModal');
                const subcategoryNameInput = document.getElementById('subcategoryName');
                const subcategoryInstructionsInput = document.getElementById('subcategoryInstructions');
                const subcategoryExamplesInput = document.getElementById('subcategoryExamples');
                const saveNewSubcategoryBtn = document.getElementById('saveNewSubcategory');
                const cancelNewSubcategoryBtn = document.getElementById('cancelNewSubcategory');
                const editSubcategoryModal = document.getElementById('editSubcategoryModal');
                const editSubcategoryNameInput = document.getElementById('editSubcategoryName');
                const editSubcategoryInstructionsInput = document.getElementById('editSubcategoryInstructions');
                const editSubcategoryExamplesInput = document.getElementById('editSubcategoryExamples');
                const saveEditSubcategoryBtn = document.getElementById('saveEditSubcategory');
                const cancelEditSubcategoryBtn = document.getElementById('cancelEditSubcategory');
                const messageContainer = document.getElementById('messageContainer');
                const placeholderSection = document.getElementById('placeholderSection');
                const subcategoryDetailsModal = document.getElementById('subcategoryDetailsModal');
                const detailsSubcategoryName = document.getElementById('detailsSubcategoryName');
                const detailsSubcategoryInstructions = document.getElementById('detailsSubcategoryInstructions');
                const detailsSubcategoryExamples = document.getElementById('detailsSubcategoryExamples');
                const closeSubcategoryDetailsBtn = document.getElementById('closeSubcategoryDetails');

                // Application State
                let categoriesData = [];
                let currentCategory = null;
                let editingCategory = null;
                let editingSubcategory = null;

                // Helper Functions
                const apiRequest = async (data) => {
                    console.log('API Request:', data);
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ body: JSON.stringify(data) })
                        });
                        if (!response.ok) {
                            throw new Error(`Network response was not ok. Status code: ${response.status}`);
                        }
                        const text = await response.text();
                        let result;
                        try {
                            result = JSON.parse(text);
                        } catch (e) {
                            console.error('Error parsing JSON response:', e, text);
                            throw new Error('Error parsing JSON response');
                        }
                        console.log('API Response:', result);
                        return result;
                    } catch (error) {
                        console.error('API Error:', error);
                        throw error;
                    }
                };

                const showMessage = (type, text) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `max-w-sm w-full ${type === 'error' ? 'bg-red-50 border border-red-500' : 'bg-green-50 border border-green-500'} text-sm rounded-md shadow-md p-4 flex items-center`;
                    messageDiv.innerHTML = `
                        <svg class="h-5 w-5 ${type === 'error' ? 'text-red-500' : 'text-green-500'} mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'}
                        </svg>
                        <span>${text}</span>
                    `;
                    messageContainer.appendChild(messageDiv);

                    setTimeout(() => {
                        messageDiv.classList.add('opacity-0');
                        setTimeout(() => {
                            messageDiv.remove();
                        }, 500);
                    }, 3000);
                };

                // Category Manager Class
                class CategoryManager {
                    async fetchCategories() {
                        console.log('Fetching all categories.');
                        categoriesList.innerHTML = `
                            <li class="text-center py-4">
                                <svg class="animate-spin h-5 w-5 text-gray-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M12 2a10 10 0 0110 10h-2a8 8 0 10-8 8v2a10 10 0 110-20z"></path>
                                </svg>
                            </li>
                        `;

                        const data = {
                            entity: 'category',
                            operation: 'read_all'
                        };

                        try {
                            const response = await apiRequest(data);
                            categoriesData = response;
                            this.displayCategories(response);
                        } catch (error) {
                            showMessage('error', 'Error fetching categories: ' + error.message);
                            categoriesList.innerHTML = '<li class="text-red-500 py-4 text-center">Error fetching categories.</li>';
                        }
                    }

                    displayCategories(categories) {
                        console.log('Displaying categories.');
                        categoriesList.innerHTML = '';

                        if (categories.length === 0) {
                            categoriesList.innerHTML = '<li class="py-4 text-center text-gray-500">No categories available.</li>';
                            return;
                        }

                        categories.forEach(category => {
                            const li = document.createElement('li');
                            li.className = 'flex items-center justify-between hover:bg-gray-100 rounded-md px-3 py-2';

                            const button = document.createElement('button');
                            button.className = 'flex items-center space-x-2 focus:outline-none w-full text-left';
                            button.addEventListener('click', (event) => {
                                event.preventDefault();
                                console.log('Category clicked:', category.CategoryID);
                                currentCategory = category;
                                subcategoryManager.displaySubcategories(category);
                            });

                            const icon = document.createElement('svg');
                            icon.className = 'h-5 w-5 text-indigo-500';
                            icon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                            icon.setAttribute('fill', 'currentColor');
                            icon.setAttribute('viewBox', '0 0 20 20');
                            icon.innerHTML = '<path d="M2 6a2 2 0 012-2h3.5a1 1 0 01.832.445l.668 1.11H14a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>';

                            const span = document.createElement('span');
                            span.className = 'text-sm font-medium text-gray-700';
                            span.innerText = category.CategoryName;

                            button.appendChild(icon);
                            button.appendChild(span);

                            const actions = document.createElement('div');
                            actions.classList.add('flex', 'items-center', 'space-x-2');

                            // Edit Button
                            const editBtn = document.createElement('button');
                            editBtn.classList.add('text-gray-600', 'hover:text-gray-800', 'focus:outline-none');
                            editBtn.setAttribute('aria-label', 'Edit category');
                            editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Edit" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 17.5A1.5 1.5 0 003.5 19h13a1.5 1.5 0 003.5-4H3.5A1.5 1.5 0 003.5 19H2z" clip-rule="evenodd"/></svg>';
                            editBtn.addEventListener('click', (event) => {
                                event.stopPropagation();
                                console.log('Edit category:', category.CategoryID);
                                this.openEditCategoryModal(category);
                            });

                            // Delete Button
                            const deleteBtn = document.createElement('button');
                            deleteBtn.classList.add('text-gray-600', 'hover:text-gray-800', 'focus:outline-none');
                            deleteBtn.setAttribute('aria-label', 'Delete category');
                            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Delete" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.292 4.292a1 1 0 011.416 0L10 8.584l4.292-4.292a1 1 0 011.416 1.416L11.416 10l4.292 4.292a1 1 0 01-1.416 1.416L10 11.416l-4.292 4.292a1 1 0 01-1.416-1.416L8.584 10 4.292 5.708a1 1 0 010-1.416z" clip-rule="evenodd"/></svg>';
                            deleteBtn.addEventListener('click', (event) => {
                                event.stopPropagation();
                                console.log('Delete category:', category.CategoryID);
                                this.deleteCategory(category);
                            });

                            actions.appendChild(editBtn);
                            actions.appendChild(deleteBtn);

                            li.appendChild(button);
                            li.appendChild(actions);

                            categoriesList.appendChild(li);
                        });
                    }

                    openNewCategoryModal() {
                        categoryNameInput.value = '';
                        newCategoryModal.classList.remove('hidden');
                    }

                    closeNewCategoryModal() {
                        newCategoryModal.classList.add('hidden');
                    }

                    async createCategory() {
                        const categoryName = categoryNameInput.value.trim();
                        if (categoryName === '') {
                            showMessage('error', 'Category name cannot be empty.');
                            return;
                        }
                        saveNewCategoryBtn.disabled = true;
                        saveNewCategoryBtn.textContent = 'Saving...';
                        const categoryID = this.generateUUID();
                        const data = {
                            entity: 'category',
                            operation: 'create',
                            item: {
                                CategoryID: categoryID,
                                CategoryName: categoryName,
                                SubCategories: []
                            }
                        };
                        try {
                            const response = await apiRequest(data);
                            showMessage('success', `Category "${categoryName}" created successfully.`);
                            this.closeNewCategoryModal();
                            saveNewCategoryBtn.disabled = false;
                            saveNewCategoryBtn.textContent = 'Save';
                            this.fetchCategories();
                        } catch (error) {
                            showMessage('error', 'Error creating category: ' + error.message);
                            console.error('Error creating category:', error);
                            saveNewCategoryBtn.disabled = false;
                            saveNewCategoryBtn.textContent = 'Save';
                        }
                    }

                    openEditCategoryModal(category) {
                        editingCategory = category;
                        editCategoryNameInput.value = category.CategoryName;
                        editCategoryModal.classList.remove('hidden');
                    }

                    closeEditCategoryModal() {
                        editCategoryModal.classList.add('hidden');
                        editingCategory = null;
                    }

                    async updateCategory() {
                        if (!editingCategory) return;
                        const newName = editCategoryNameInput.value.trim();
                        if (newName === '') {
                            showMessage('error', 'Category name cannot be empty.');
                            return;
                        }
                        saveEditCategoryBtn.disabled = true;
                        saveEditCategoryBtn.textContent = 'Saving...';
                        const data = {
                            entity: 'category',
                            operation: 'update',
                            CategoryID: editingCategory.CategoryID,
                            update_fields: {
                                CategoryName: newName
                            }
                        };
                        try {
                            const response = await apiRequest(data);
                            showMessage('success', `Category "${editingCategory.CategoryName}" updated successfully.`);
                            this.closeEditCategoryModal();
                            saveEditCategoryBtn.disabled = false;
                            saveEditCategoryBtn.textContent = 'Save Changes';
                            this.fetchCategories();
                            if (currentCategory && currentCategory.CategoryID === editingCategory.CategoryID) {
                                subcategoryTitle.textContent = newName;
                            }
                        } catch (error) {
                            showMessage('error', 'Error updating category: ' + error.message);
                            console.error('Error updating category:', error);
                            saveEditCategoryBtn.disabled = false;
                            saveEditCategoryBtn.textContent = 'Save Changes';
                        }
                    }

                    async deleteCategory(category) {
                        if (!confirm(`Are you sure you want to delete category "${category.CategoryName}"?`)) {
                            return;
                        }
                        const data = {
                            entity: 'category',
                            operation: 'delete',
                            CategoryID: category.CategoryID
                        };
                        try {
                            const response = await apiRequest(data);
                            showMessage('success', `Category "${category.CategoryName}" deleted successfully.`);
                            this.fetchCategories();
                            if (currentCategory && currentCategory.CategoryID === category.CategoryID) {
                                subcategoriesSection.classList.add('hidden');
                                placeholderSection.classList.remove('hidden');
                                currentCategory = null;
                            }
                        } catch (error) {
                            showMessage('error', 'Error deleting category: ' + error.message);
                            console.error('Error deleting category:', error);
                        }
                    }

                    generateUUID() {
                        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                            var r = Math.random() * 16 | 0,
                                v = c == 'x' ? r : (r & 0x3 | 0x8);
                            return v.toString(16);
                        });
                    }
                }

                // Subcategory Manager Class
                class SubcategoryManager {
                    displaySubcategories(category) {
                        console.log('Displaying subcategories for category:', category.CategoryName);
                        subcategoriesList.innerHTML = '';
                        subcategoryTitle.textContent = category.CategoryName;
                        subcategoriesSection.classList.remove('hidden');
                        placeholderSection.classList.add('hidden');

                        const subcategories = category.SubCategories || [];

                        if (subcategories.length === 0) {
                            subcategoriesList.innerHTML = '<p class="text-gray-500">No subcategories available.</p>';
                            return;
                        }

                        subcategories.forEach(subcategory => {
                            const div = document.createElement('div');
                            div.className = 'bg-white rounded-md shadow p-4 flex items-center justify-between';

                            const details = document.createElement('div');
                            details.className = 'flex items-center space-x-2';

                            const icon = document.createElement('svg');
                            icon.className = 'h-5 w-5 text-indigo-500';
                            icon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                            icon.setAttribute('fill', 'currentColor');
                            icon.setAttribute('viewBox', '0 0 20 20');
                            icon.innerHTML = '<path d="M4 2a2 2 0 012-2h8a2 2 0 012 2v16l-6-3-6 3V2z"/>';

                            const title = document.createElement('span');
                            title.className = 'text-sm font-medium text-gray-700';
                            title.innerText = subcategory.SubCategoryName;

                            details.appendChild(icon);
                            details.appendChild(title);

                            const actions = document.createElement('div');
                            actions.classList.add('flex', 'items-center', 'space-x-2');

                            // View Button
                            const viewBtn = document.createElement('button');
                            viewBtn.classList.add('text-gray-600', 'hover:text-gray-800', 'focus:outline-none');
                            viewBtn.setAttribute('aria-label', 'View details');
                            viewBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="View" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a7 7 0 017 7 7 7 0 01-7 7 7 7 0 01-7-7 7 7 0 017-7zm0 3a4 4 0 100 8 4 4 0 000-8z"/></svg>';
                            viewBtn.addEventListener('click', (event) => {
                                event.stopPropagation();
                                console.log('View subcategory:', subcategory.SubCategoryID);
                                this.openSubcategoryDetails(subcategory);
                            });

                            // Edit Button
                            const editBtn = document.createElement('button');
                            editBtn.classList.add('text-gray-600', 'hover:text-gray-800', 'focus:outline-none');
                            editBtn.setAttribute('aria-label', 'Edit subcategory');
                            editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Edit" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 17.5A1.5 1.5 0 003.5 19h13a1.5 1.5 0 003.5-4H3.5A1.5 1.5 0 003.5 19H2z" clip-rule="evenodd"/></svg>';
                            editBtn.addEventListener('click', (event) => {
                                event.stopPropagation();
                                console.log('Edit subcategory:', subcategory.SubCategoryID);
                                this.openEditSubcategoryModal(subcategory);
                            });

                            // Delete Button
                            const deleteBtn = document.createElement('button');
                            deleteBtn.classList.add('text-gray-600', 'hover:text-gray-800', 'focus:outline-none');
                            deleteBtn.setAttribute('aria-label', 'Delete subcategory');
                            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" role="img" aria-label="Delete" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.292 4.292a1 1 0 011.416 0L10 8.584l4.292-4.292a1 1 0 011.416 1.416L11.416 10l4.292 4.292a1 1 0 01-1.416 1.416L10 11.416l-4.292 4.292a1 1 0 01-1.416-1.416L8.584 10 4.292 5.708a1 1 0 010-1.416z" clip-rule="evenodd"/></svg>';
                            deleteBtn.addEventListener('click', (event) => {
                                event.stopPropagation();
                                console.log('Delete subcategory:', subcategory.SubCategoryID);
                                this.deleteSubcategory(subcategory);
                            });

                            actions.appendChild(viewBtn);
                            actions.appendChild(editBtn);
                            actions.appendChild(deleteBtn);

                            div.appendChild(details);
                            div.appendChild(actions);

                            subcategoriesList.appendChild(div);
                        });
                    }

                    openNewSubcategoryModal() {
                        subcategoryNameInput.value = '';
                        subcategoryInstructionsInput.value = '';
                        subcategoryExamplesInput.value = '';
                        newSubcategoryModal.classList.remove('hidden');
                    }

                    closeNewSubcategoryModal() {
                        newSubcategoryModal.classList.add('hidden');
                    }

                    async createSubcategory() {
                        if (!currentCategory) return;
                        const subcategoryName = subcategoryNameInput.value.trim();
                        const instructions = subcategoryInstructionsInput.value.trim();
                        const examples = subcategoryExamplesInput.value.trim();
                        if (subcategoryName === '') {
                            showMessage('error', 'Subcategory name cannot be empty.');
                            return;
                        }
                        saveNewSubcategoryBtn.disabled = true;
                        saveNewSubcategoryBtn.textContent = 'Saving...';
                        const subcategoryID = this.generateUUID();
                        const data = {
                            entity: 'subcategory',
                            operation: 'create',
                            CategoryID: currentCategory.CategoryID,
                            SubCategory: {
                                SubCategoryID: subcategoryID,
                                SubCategoryName: subcategoryName,
                                Instructions: instructions,
                                Examples: examples
                            }
                        };
                        try {
                            const response = await apiRequest(data);
                            showMessage('success', `Subcategory "${subcategoryName}" created successfully.`);
                            this.closeNewSubcategoryModal();
                            saveNewSubcategoryBtn.disabled = false;
                            saveNewSubcategoryBtn.textContent = 'Save';
                            await categoryManager.fetchCategories();
                            currentCategory = categoriesData.find(cat => cat.CategoryID === currentCategory.CategoryID);
                            this.displaySubcategories(currentCategory);
                        } catch (error) {
                            showMessage('error', 'Error creating subcategory: ' + error.message);
                            console.error('Error creating subcategory:', error);
                            saveNewSubcategoryBtn.disabled = false;
                            saveNewSubcategoryBtn.textContent = 'Save';
                        }
                    }

                    openEditSubcategoryModal(subcategory) {
                        editingSubcategory = subcategory;
                        editSubcategoryNameInput.value = subcategory.SubCategoryName;
                        editSubcategoryInstructionsInput.value = subcategory.Instructions || '';
                        editSubcategoryExamplesInput.value = subcategory.Examples || '';
                        editSubcategoryModal.classList.remove('hidden');
                    }

                    closeEditSubcategoryModal() {
                        editSubcategoryModal.classList.add('hidden');
                        editingSubcategory = null;
                    }

                    async updateSubcategory() {
                        if (!currentCategory || !editingSubcategory) return;
                        const newName = editSubcategoryNameInput.value.trim();
                        const instructions = editSubcategoryInstructionsInput.value.trim();
                        const examples = editSubcategoryExamplesInput.value.trim();
                        if (newName === '') {
                            showMessage('error', 'Subcategory name cannot be empty.');
                            return;
                        }
                        saveEditSubcategoryBtn.disabled = true;
                        saveEditSubcategoryBtn.textContent = 'Saving...';
                        const data = {
                            entity: 'subcategory',
                            operation: 'update',
                            CategoryID: currentCategory.CategoryID,
                            SubCategoryID: editingSubcategory.SubCategoryID,
                            update_fields: {
                                SubCategoryName: newName,
                                Instructions: instructions,
                                Examples: examples
                            }
                        };
                        try {
                            const response = await apiRequest(data);
                            showMessage('success', `Subcategory "${editingSubcategory.SubCategoryName}" updated successfully.`);
                            this.closeEditSubcategoryModal();
                            saveEditSubcategoryBtn.disabled = false;
                            saveEditSubcategoryBtn.textContent = 'Save Changes';
                            await categoryManager.fetchCategories();
                            currentCategory = categoriesData.find(cat => cat.CategoryID === currentCategory.CategoryID);
                            this.displaySubcategories(currentCategory);
                        } catch (error) {
                            showMessage('error', 'Error updating subcategory: ' + error.message);
                            console.error('Error updating subcategory:', error);
                            saveEditSubcategoryBtn.disabled = false;
                            saveEditSubcategoryBtn.textContent = 'Save Changes';
                        }
                    }

                    async deleteSubcategory(subcategory) {
                        if (!confirm(`Are you sure you want to delete subcategory "${subcategory.SubCategoryName}"?`)) {
                            return;
                        }
                        const data = {
                            entity: 'subcategory',
                            operation: 'delete',
                            CategoryID: currentCategory.CategoryID,
                            SubCategoryID: subcategory.SubCategoryID
                        };
                        try {
                            const response = await apiRequest(data);
                            showMessage('success', `Subcategory "${subcategory.SubCategoryName}" deleted successfully.`);
                            await categoryManager.fetchCategories();
                            currentCategory = categoriesData.find(cat => cat.CategoryID === currentCategory.CategoryID);
                            this.displaySubcategories(currentCategory);
                        } catch (error) {
                            showMessage('error', 'Error deleting subcategory: ' + error.message);
                            console.error('Error deleting subcategory:', error);
                        }
                    }

                    openSubcategoryDetails(subcategory) {
                        detailsSubcategoryName.textContent = subcategory.SubCategoryName;
                        detailsSubcategoryInstructions.textContent = subcategory.Instructions || 'No instructions provided.';
                        detailsSubcategoryExamples.textContent = subcategory.Examples || 'No examples provided.';
                        subcategoryDetailsModal.classList.remove('hidden');
                    }

                    closeSubcategoryDetails() {
                        subcategoryDetailsModal.classList.add('hidden');
                    }

                    generateUUID() {
                        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                            var r = Math.random() * 16 | 0,
                                v = c == 'x' ? r : (r & 0x3 | 0x8);
                            return v.toString(16);
                        });
                    }
                }

                // Instantiate managers
                const categoryManager = new CategoryManager();
                const subcategoryManager = new SubcategoryManager();

                // Event Listeners
                newCategoryBtn.addEventListener('click', () => {
                    categoryManager.openNewCategoryModal();
                });

                newCategoryBtnSidebar.addEventListener('click', () => {
                    categoryManager.openNewCategoryModal();
                });

                cancelNewCategoryBtn.addEventListener('click', () => {
                    categoryManager.closeNewCategoryModal();
                });

                saveNewCategoryBtn.addEventListener('click', () => {
                    categoryManager.createCategory();
                });

                cancelEditCategoryBtn.addEventListener('click', () => {
                    categoryManager.closeEditCategoryModal();
                });

                saveEditCategoryBtn.addEventListener('click', () => {
                    categoryManager.updateCategory();
                });

                backButton.addEventListener('click', () => {
                    subcategoriesSection.classList.add('hidden');
                    placeholderSection.classList.remove('hidden');
                    currentCategory = null;
                });

                newSubcategoryBtn.addEventListener('click', () => {
                    subcategoryManager.openNewSubcategoryModal();
                });

                cancelNewSubcategoryBtn.addEventListener('click', () => {
                    subcategoryManager.closeNewSubcategoryModal();
                });

                saveNewSubcategoryBtn.addEventListener('click', () => {
                    subcategoryManager.createSubcategory();
                });

                cancelEditSubcategoryBtn.addEventListener('click', () => {
                    subcategoryManager.closeEditSubcategoryModal();
                });

                saveEditSubcategoryBtn.addEventListener('click', () => {
                    subcategoryManager.updateSubcategory();
                });

                closeSubcategoryDetailsBtn.addEventListener('click', () => {
                    subcategoryManager.closeSubcategoryDetails();
                });

                // Initial fetch
                categoryManager.fetchCategories();

            });
        })();
    </script>
</body>
</html>