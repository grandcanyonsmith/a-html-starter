<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories Management</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen font-sans">
    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center">
                <span class="text-xl font-semibold text-gray-800">Your Brand</span>
            </div>
            <div>
                <button id="newCategoryBtn" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">
                    New Category
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Categories Section -->
        <div id="categoriesSection">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Categories</h2>
            <div id="categoriesList" class="bg-white shadow overflow-hidden sm:rounded-md">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Subcategories Section -->
        <div id="subcategoriesSection" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 id="subcategoryTitle" class="text-2xl font-semibold text-gray-800">Subcategories</h2>
                <button id="backButton" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                    Back to Categories
                </button>
            </div>
            <div id="subcategoriesList" class="bg-white shadow overflow-hidden sm:rounded-md">
                <!-- Subcategories will be loaded here -->
            </div>
        </div>

        <!-- New Category Modal -->
        <div id="newCategoryModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="px-6 py-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Create New Category</h3>
                    <div class="mt-4">
                        <label for="categoryName" class="block text-sm font-medium text-gray-700">Category Name</label>
                        <input type="text" id="categoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelNewCategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                        Cancel
                    </button>
                    <button id="saveNewCategory" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Category Modal -->
        <div id="editCategoryModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="px-6 py-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Category</h3>
                    <div class="mt-4">
                        <label for="editCategoryName" class="block text-sm font-medium text-gray-700">Category Name</label>
                        <input type="text" id="editCategoryName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end">
                    <button id="cancelEditCategory" class="mr-3 py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                        Cancel
                    </button>
                    <button id="saveEditCategory" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Page loaded.');

            const categoriesList = document.getElementById('categoriesList');
            const categoriesSection = document.getElementById('categoriesSection');
            const subcategoriesSection = document.getElementById('subcategoriesSection');
            const subcategoriesList = document.getElementById('subcategoriesList');
            const backButton = document.getElementById('backButton');
            const subcategoryTitle = document.getElementById('subcategoryTitle');
            const newCategoryBtn = document.getElementById('newCategoryBtn');
            const newCategoryModal = document.getElementById('newCategoryModal');
            const editCategoryModal = document.getElementById('editCategoryModal');
            const categoryNameInput = document.getElementById('categoryName');
            const saveNewCategoryBtn = document.getElementById('saveNewCategory');
            const cancelNewCategoryBtn = document.getElementById('cancelNewCategory');
            const editCategoryNameInput = document.getElementById('editCategoryName');
            const saveEditCategoryBtn = document.getElementById('saveEditCategory');
            const cancelEditCategoryBtn = document.getElementById('cancelEditCategory');

            let categoriesData = [];
            let editingCategory = null;

            // Function to fetch and display all categories
            function fetchCategories() {
                console.log('Fetching all categories.');
                const data = {
                    operation: 'read_all'
                };

                fetch('https://soa6mp6e2rilqgb7xz675agzeq0stbff.lambda-url.us-west-2.on.aws/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ body: JSON.stringify(data) })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok. Status code: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Categories data received:', data);
                        categoriesData = data;
                        displayCategories(data);
                    })
                    .catch(error => {
                        console.error('Error fetching categories:', error);
                        categoriesList.innerHTML = '<div class="p-4 text-red-500">Error fetching categories: ' + error.message + '</div>';
                    });
            }

            // Function to display categories
            function displayCategories(categories) {
                console.log('Displaying categories.');
                categoriesList.innerHTML = '';

                if (categories.length === 0) {
                    categoriesList.innerHTML = '<div class="p-4">No categories available.</div>';
                    return;
                }

                categories.forEach(category => {
                    const div = document.createElement('div');
                    div.classList.add('border-t', 'border-gray-200');

                    const item = document.createElement('div');
                    item.classList.add('flex', 'items-center', 'justify-between', 'px-4', 'py-4', 'sm:px-6');

                    const info = document.createElement('div');
                    info.classList.add('flex', 'items-center', 'space-x-3');

                    const title = document.createElement('a');
                    title.classList.add('text-lg', 'font-medium', 'text-blue-600', 'hover:text-blue-500', 'cursor-pointer');
                    title.innerText = category.CategoryName;
                    title.addEventListener('click', function () {
                        console.log('Category clicked:', category.CategoryID);
                        displaySubcategories(category);
                    });

                    info.appendChild(title);
                    item.appendChild(info);

                    const actions = document.createElement('div');
                    actions.classList.add('flex', 'items-center', 'space-x-2');

                    // Edit Button
                    const editBtn = document.createElement('button');
                    editBtn.classList.add('text-gray-600', 'hover:text-gray-800');
                    editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/><path fill-rule="evenodd" d="M2 17.5A1.5 1.5 0 003.5 19h13a1.5 1.5 0 001.5-1.5V9a1 1 0 112 0v8.5A3.5 3.5 0 0116.5 21h-13A3.5 3.5 0 010 17.5v-13A3.5 3.5 0 013.5 1h8.5a1 1 0 110 2H3.5A1.5 1.5 0 002 4.5v13z" clip-rule="evenodd"/></svg>';
                    editBtn.addEventListener('click', function () {
                        console.log('Edit category clicked:', category.CategoryID);
                        editingCategory = category;
                        editCategoryNameInput.value = category.CategoryName;
                        editCategoryModal.classList.remove('hidden');
                    });

                    // Delete Button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('text-red-600', 'hover:text-red-800');
                    deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.366-.36.858-.576 1.39-.576h.707c.531 0 1.023.216 1.389.576l1.036 1.036H15.5a1 1 0 110 2h-.097l-.867 12.172a2 2 0 01-1.996 1.828H7.46a2 2 0 01-1.996-1.828L4.596 6.135a1 1 0 01-.096-2h1.485l1.036-1.036zM6.5 7a1 1 0 000 2h7a1 1 0 100-2h-7z" clip-rule="evenodd"/></svg>';
                    deleteBtn.addEventListener('click', function () {
                        console.log('Delete category clicked:', category.CategoryID);
                        if (confirm('Are you sure you want to delete this category?')) {
                            deleteCategory(category.CategoryID);
                        }
                    });

                    actions.appendChild(editBtn);
                    actions.appendChild(deleteBtn);
                    item.appendChild(actions);

                    div.appendChild(item);
                    categoriesList.appendChild(div);
                });
            }

            // Function to create a new category
            function createCategory() {
                const categoryName = categoryNameInput.value.trim();
                if (!categoryName) {
                    alert('Please enter a category name.');
                    return;
                }

                saveNewCategoryBtn.disabled = true;
                saveNewCategoryBtn.innerText = 'Saving...';

                const data = {
                    operation: 'create',
                    item: {
                        CategoryID: Date.now().toString(),
                        CategoryName: categoryName,
                        SubCategories: []
                    }
                };

                fetch('https://soa6mp6e2rilqgb7xz675agzeq0stbff.lambda-url.us-west-2.on.aws/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ body: JSON.stringify(data) })
                })
                    .then(response => response.json())
                    .then(res => {
                        console.log('Category created:', res);
                        saveNewCategoryBtn.disabled = false;
                        saveNewCategoryBtn.innerText = 'Save';
                        newCategoryModal.classList.add('hidden');
                        categoryNameInput.value = '';
                        fetchCategories();
                    })
                    .catch(error => {
                        console.error('Error creating category:', error);
                        saveNewCategoryBtn.disabled = false;
                        saveNewCategoryBtn.innerText = 'Save';
                    });
            }

            // Function to update a category
            function updateCategory() {
                const categoryName = editCategoryNameInput.value.trim();
                if (!categoryName) {
                    alert('Please enter a category name.');
                    return;
                }

                saveEditCategoryBtn.disabled = true;
                saveEditCategoryBtn.innerText = 'Saving...';

                const data = {
                    operation: 'update',
                    CategoryID: editingCategory.CategoryID,
                    update_fields: {
                        CategoryName: categoryName
                    }
                };

                fetch('https://soa6mp6e2rilqgb7xz675agzeq0stbff.lambda-url.us-west-2.on.aws/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ body: JSON.stringify(data) })
                })
                    .then(response => response.json())
                    .then(res => {
                        console.log('Category updated:', res);
                        saveEditCategoryBtn.disabled = false;
                        saveEditCategoryBtn.innerText = 'Save Changes';
                        editCategoryModal.classList.add('hidden');
                        editingCategory = null;
                        fetchCategories();
                    })
                    .catch(error => {
                        console.error('Error updating category:', error);
                        saveEditCategoryBtn.disabled = false;
                        saveEditCategoryBtn.innerText = 'Save Changes';
                    });
            }

            // Function to delete a category
            function deleteCategory(categoryID) {
                console.log('Deleting category:', categoryID);
                const data = {
                    operation: 'delete',
                    CategoryID: categoryID
                };

                fetch('https://soa6mp6e2rilqgb7xz675agzeq0stbff.lambda-url.us-west-2.on.aws/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ body: JSON.stringify(data) })
                })
                    .then(response => response.json())
                    .then(res => {
                        console.log('Category deleted:', res);
                        fetchCategories();
                    })
                    .catch(error => {
                        console.error('Error deleting category:', error);
                    });
            }

            // Function to display subcategories of a category
            function displaySubcategories(category) {
                console.log('Displaying subcategories for category:', category.CategoryName);
                categoriesSection.classList.add('hidden');
                subcategoriesSection.classList.remove('hidden');
                subcategoriesList.innerHTML = '';
                subcategoryTitle.innerText = 'Subcategories of ' + category.CategoryName;

                if (Array.isArray(category.SubCategories) && category.SubCategories.length > 0) {
                    category.SubCategories.forEach(subcategory => {
                        const div = document.createElement('div');
                        div.classList.add('border-t', 'border-gray-200');

                        const item = document.createElement('div');
                        item.classList.add('px-4', 'py-4', 'sm:px-6');

                        const name = document.createElement('div');
                        name.classList.add('text-sm', 'font-medium', 'text-gray-900');
                        name.innerText = subcategory.SubCategoryName;

                        item.appendChild(name);
                        div.appendChild(item);
                        subcategoriesList.appendChild(div);
                    });
                } else {
                    subcategoriesList.innerHTML = '<div class="p-4">No subcategories available.</div>';
                }
            }

            // Event listeners
            newCategoryBtn.addEventListener('click', function () {
                console.log('New Category button clicked.');
                newCategoryModal.classList.remove('hidden');
            });

            cancelNewCategoryBtn.addEventListener('click', function () {
                newCategoryModal.classList.add('hidden');
                categoryNameInput.value = '';
            });

            saveNewCategoryBtn.addEventListener('click', function () {
                createCategory();
            });

            cancelEditCategoryBtn.addEventListener('click', function () {
                editCategoryModal.classList.add('hidden');
                editingCategory = null;
            });

            saveEditCategoryBtn.addEventListener('click', function () {
                updateCategory();
            });

            backButton.addEventListener('click', function () {
                console.log('Back button clicked.');
                subcategoriesSection.classList.add('hidden');
                categoriesSection.classList.remove('hidden');
            });

            // Fetch categories on page load
            fetchCategories();
        });
    </script>
</body>

</html>