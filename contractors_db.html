<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <title>Contractors Data - CRUD Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind CSS Configuration -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#635bff',
            },
            fontFamily: {
              sans: ['Inter var', 'sans-serif'],
            },
          }
        }
      }
    </script>
    <!-- Inter font for better typography -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Meta tags for responsiveness -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Meta tags for accessibility -->
    <meta name="description" content="Manage Contractors Data with CRUD Operations and improved UI/UX">
</head>
<body class="bg-gray-50 font-sans h-full">
    <div class="min-h-full">
        <!-- Navigation Bar -->
        <nav class="bg-white border-b border-gray-200 shadow-md">
            <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="https://cc360-publicbucketszoomrecord.s3.us-west-2.amazonaws.com/logo-bg-rm.png" alt="Logo" class="w-10 h-10">
                    <a href="#" class="text-2xl font-bold text-gray-900">Contractor Manager</a>
                </div>
            </div>
        </nav>

        <main class="container mx-auto p-6">
            <!-- Header -->
            <div class="mb-8 text-center">
                <h1 class="text-4xl font-extrabold text-gray-900">Contractors Data</h1>
                <p class="mt-4 text-lg text-gray-600">Manage your contractors efficiently with the improved interface.</p>
            </div>

            <!-- Notification Area -->
            <div aria-live="assertive" aria-atomic="true" class="mb-4" id="notification"></div>

            <!-- Search and Filter -->
            <div class="mb-8 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-6 text-gray-900">Search and Filter Contractors</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="search-name" class="block text-sm font-medium text-gray-700 mb-2">Search by Name</label>
                        <input type="text" id="search-name" placeholder="Name" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Search by Name">
                    </div>
                    <div>
                        <label for="filter-country" class="block text-sm font-medium text-gray-700 mb-2">Filter by Country</label>
                        <input type="text" id="filter-country" placeholder="Country" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Filter by Country">
                    </div>
                    <div>
                        <label for="filter-rates" class="block text-sm font-medium text-gray-700 mb-2">Filter by Rates</label>
                        <input type="text" id="filter-rates" placeholder="Rates" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Filter by Rates">
                    </div>
                </div>
            </div>

            <!-- Create Contractor Form -->
            <div class="mb-8 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-6 text-gray-900">Add New Contractor</h2>
                <form id="create-contractor-form" class="grid grid-cols-1 md:grid-cols-2 gap-6" aria-label="Add New Contractor">
                    <div>
                        <label for="create-name" class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" id="create-name" name="Name" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" required aria-required="true" aria-label="Name">
                    </div>
                    <div>
                        <label for="create-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="create-email" name="Email" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" required aria-required="true" aria-label="Email">
                    </div>
                    <div>
                        <label for="create-phone-number" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="text" id="create-phone-number" name="PhoneNumber" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Phone Number">
                    </div>
                    <div>
                        <label for="create-country" class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                        <input type="text" id="create-country" name="Country" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Country">
                    </div>
                    <div>
                        <label for="create-test-work" class="block text-sm font-medium text-gray-700 mb-2">Test Work URL</label>
                        <input type="url" id="create-test-work" name="TestWork" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Test Work URL">
                    </div>
                    <div>
                        <label for="create-loom-video" class="block text-sm font-medium text-gray-700 mb-2">Loom Video URL</label>
                        <input type="url" id="create-loom-video" name="LoomVideo" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Loom Video URL">
                    </div>
                    <div>
                        <label for="create-rates" class="block text-sm font-medium text-gray-700 mb-2">Rates</label>
                        <input type="text" id="create-rates" name="Rates" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Rates">
                    </div>
                    <div>
                        <label for="create-description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="create-description" name="Description" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Description"></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="inline-flex items-center bg-primary hover:bg-indigo-700 text-white px-6 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" aria-label="Add Contractor">
                            <span id="create-button-text">Add Contractor</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Contractors List -->
            <div id="contractors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" aria-label="Contractors List"></div>

            <!-- Pagination Controls -->
            <div id="pagination-controls" class="mt-8 flex items-center justify-between" aria-label="Pagination Controls">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing page <span id="current-page"></span> of <span id="total-pages"></span>
                    </p>
                </div>
                <nav class="inline-flex -space-x-px" aria-label="Pagination Navigation">
                    <button id="prev-page-btn" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:outline-none focus:ring-1 focus:ring-primary" disabled aria-label="Previous Page">
                        Previous
                    </button>
                    <button id="next-page-btn" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 focus:z-10 focus:outline-none focus:ring-1 focus:ring-primary" disabled aria-label="Next Page">
                        Next
                    </button>
                </nav>
            </div>
        </main>

        <!-- Update Contractor Modal -->
        <div id="update-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none transition-opacity duration-300 z-50" role="dialog" aria-modal="true" aria-labelledby="update-modal-title">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md" role="document">
                <h2 id="update-modal-title" class="text-2xl font-semibold mb-6 text-gray-900">Update Contractor</h2>
                <form id="update-contractor-form" class="grid grid-cols-1 gap-6" aria-label="Update Contractor">
                    <!-- Hidden field to store original email -->
                    <input type="hidden" name="OriginalEmail">
                    <div>
                        <label for="update-name" class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" id="update-name" name="Name" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Name">
                    </div>
                    <div>
                        <label for="update-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="update-email" name="Email" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" required aria-label="Email">
                    </div>
                    <div>
                        <label for="update-phone-number" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="text" id="update-phone-number" name="PhoneNumber" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Phone Number">
                    </div>
                    <div>
                        <label for="update-country" class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                        <input type="text" id="update-country" name="Country" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Country">
                    </div>
                    <div>
                        <label for="update-test-work" class="block text-sm font-medium text-gray-700 mb-2">Test Work URL</label>
                        <input type="url" id="update-test-work" name="TestWork" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Test Work URL">
                    </div>
                    <div>
                        <label for="update-loom-video" class="block text-sm font-medium text-gray-700 mb-2">Loom Video URL</label>
                        <input type="url" id="update-loom-video" name="LoomVideo" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Loom Video URL">
                    </div>
                    <div>
                        <label for="update-rates" class="block text-sm font-medium text-gray-700 mb-2">Rates</label>
                        <input type="text" id="update-rates" name="Rates" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Rates">
                    </div>
                    <div>
                        <label for="update-description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="update-description" name="Description" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Description"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-update-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" aria-label="Cancel Update">
                            Cancel
                        </button>
                        <button type="submit" class="inline-flex items-center bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" aria-label="Update Contractor">
                            <span id="update-button-text">Update Contractor</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add to Sub Account Modal -->
        <div id="add-subaccount-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none transition-opacity duration-300 z-50" role="dialog" aria-modal="true" aria-labelledby="add-subaccount-modal-title">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md" role="document">
                <h2 id="add-subaccount-modal-title" class="text-2xl font-semibold mb-6 text-gray-900">Add to Sub Account</h2>
                <form id="add-subaccount-form" class="grid grid-cols-1 gap-6" aria-label="Add to Sub Account">
                    <input type="hidden" name="Email">
                    <input type="hidden" name="FirstName">
                    <input type="hidden" name="LastName">
                    <input type="hidden" name="Phone">
                    <div>
                        <label for="location-id" class="block text-sm font-medium text-gray-700 mb-2">Location ID</label>
                        <input type="text" id="location-id" name="LocationId" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary" required aria-required="true" aria-label="Location ID">
                        <p class="text-sm text-gray-500 mt-2">
                            The test account Location ID is <span class="font-mono">6BPWWH0wZPBQ3RJOY1ki</span><br>
                            The Course Creator 360 Location ID is <span class="font-mono">c2DjRsOo4e13Od6ZTU6S</span>
                        </p>
                    </div>
                    <p class="mb-4 text-gray-600">Are you sure you want to add this contractor to a sub account?</p>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-add-subaccount-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" aria-label="Cancel">
                            Cancel
                        </button>
                        <button type="submit" id="confirm-add-subaccount-btn" class="inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-label="Add to Sub Account">
                            <span id="add-subaccount-button-text">Yes</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- JavaScript Code -->
    <script type="module">
        // ContractorsManager Module
        const ContractorsManager = (() => {

            const lambdaUrl = 'https://in3k57uvf5h3tdi4ntgdtvqrfi0ydvie.lambda-url.us-west-2.on.aws/';

            // Cache key for localStorage
            const cacheKey = 'contractorsData';

            // Holds the data fetched from the server
            let contractorsData = [];

            // Pagination variables
            const itemsPerPage = 6;
            let currentPage = 1;
            let totalPages = 1;

            // Current contractor being edited
            let currentEditingContractorEmail = null;

            // Initialize the module
            function init() {
                bindEventListeners();
                loadContractorsData();
            }

            // Bind event listeners
            function bindEventListeners() {
                // Event listener for Create Contractor form
                document.getElementById('create-contractor-form').addEventListener('submit', handleCreateContractor);

                // Event listener for Update Contractor form
                document.getElementById('update-contractor-form').addEventListener('submit', handleUpdateContractor);

                // Event listener for Cancel Update button
                document.getElementById('cancel-update-btn').addEventListener('click', closeUpdateModal);

                // Event listeners for search/filter inputs
                document.getElementById('search-name').addEventListener('input', () => {
                    resetPagination();
                    displayContractorsData();
                });
                document.getElementById('filter-country').addEventListener('input', () => {
                    resetPagination();
                    displayContractorsData();
                });
                document.getElementById('filter-rates').addEventListener('input', () => {
                    resetPagination();
                    displayContractorsData();
                });

                // Pagination buttons
                document.getElementById('prev-page-btn').addEventListener('click', goToPreviousPage);
                document.getElementById('next-page-btn').addEventListener('click', goToNextPage);

                // Event listener for Add to Sub Account form
                document.getElementById('add-subaccount-form').addEventListener('submit', handleAddSubAccountSubmit);

                // Event listener for Cancel Add to Sub Account button
                document.getElementById('cancel-add-subaccount-btn').addEventListener('click', closeAddSubAccountModal);
            }

            // Load contractors data
            function loadContractorsData() {
                // Check if data is in cache
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    contractorsData = JSON.parse(cachedData);
                    console.log('Loaded contractors data from cache.');
                    displayContractorsData();
                } else {
                    fetchContractorsData();
                }
            }

            // Fetch data from the server
            async function fetchContractorsData() {
                console.log('Fetching contractors data from server...');

                try {
                    const response = await fetch(lambdaUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            'request_type': 'read'
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    console.log('Data received:', data);

                    contractorsData = data;
                    // Save data to cache
                    localStorage.setItem(cacheKey, JSON.stringify(contractorsData));
                    displayContractorsData();

                } catch (error) {
                    console.error('Error fetching data:', error);
                    showNotification('Error fetching contractors data', 'error');
                }
            }

            // Display contractors data
            function displayContractorsData() {
                const container = document.getElementById('contractors-container');
                container.innerHTML = ''; // Clear previous data

                const filteredContractors = filterContractors(contractorsData);

                totalPages = Math.ceil(filteredContractors.length / itemsPerPage);
                updatePaginationControls();

                if (filteredContractors.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-600">No contractors found.</p>';
                    return;
                }

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = currentPage * itemsPerPage;

                const contractorsToDisplay = filteredContractors.slice(startIndex, endIndex);

                contractorsToDisplay.forEach(contractor => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 relative flex flex-col';
                    card.tabIndex = 0;
                    card.setAttribute('role', 'article');

                    card.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4 text-gray-900">${contractor.Name || 'No Name'}</h2>
                        <p class="text-sm text-gray-600 mb-2"><strong>Email:</strong> ${contractor.Email || 'N/A'}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Phone Number:</strong> ${contractor.PhoneNumber || 'N/A'}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Country:</strong> ${contractor.Country || 'N/A'}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Test Work:</strong> ${contractor.TestWork ? `<a href="${contractor.TestWork}" class="text-primary hover:underline" target="_blank" rel="noopener noreferrer">View</a>` : 'N/A'}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Loom Video:</strong> ${contractor.LoomVideo ? `<a href="${contractor.LoomVideo}" class="text-primary hover:underline" target="_blank" rel="noopener noreferrer">Watch</a>` : 'N/A'}</p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Rates:</strong> ${contractor.Rates || 'N/A'}</p>
                        <p class="text-sm text-gray-600 mb-4"><strong>Description:</strong> ${contractor.Description || 'N/A'}</p>
                        <div class="mt-auto flex space-x-4 pt-4">
                            <button class="edit-btn inline-flex items-center bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" data-email="${contractor.Email}" aria-label="Edit ${contractor.Name}">
                                Edit
                            </button>
                            <button class="delete-btn inline-flex items-center bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" data-email="${contractor.Email}" aria-label="Delete ${contractor.Name}">
                                Delete
                            </button>
                            <button class="add-subaccount-btn inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-email="${contractor.Email}" data-firstname="${contractor.Name || ''}" data-lastname="" data-phone="${contractor.PhoneNumber || ''}" aria-label="Add ${contractor.Name} to sub account">
                                + Add to Sub Account
                            </button>
                        </div>
                    `;

                    container.appendChild(card);
                });

                // Add event listeners for Edit, Delete, and Add to Sub Account buttons
                const editButtons = container.querySelectorAll('.edit-btn');
                const deleteButtons = container.querySelectorAll('.delete-btn');
                const addSubaccountButtons = container.querySelectorAll('.add-subaccount-btn');

                editButtons.forEach(button => {
                    button.addEventListener('click', handleEditContractor);
                });

                deleteButtons.forEach(button => {
                    button.addEventListener('click', handleDeleteContractor);
                });

                addSubaccountButtons.forEach(button => {
                    button.addEventListener('click', handleAddToSubAccount);
                });
            }

            // Filter contractors based on search/filter inputs
            function filterContractors(contractors) {
                const searchName = document.getElementById('search-name').value.toLowerCase();
                const filterCountry = document.getElementById('filter-country').value.toLowerCase();
                const filterRates = document.getElementById('filter-rates').value.toLowerCase();

                return contractors.filter(contractor => {
                    const matchesName = contractor.Name && contractor.Name.toLowerCase().includes(searchName);
                    const matchesCountry = !filterCountry || (contractor.Country && contractor.Country.toLowerCase().includes(filterCountry));
                    const matchesRates = !filterRates || (contractor.Rates && contractor.Rates.toLowerCase().includes(filterRates));

                    return matchesName && matchesCountry && matchesRates;
                });
            }

            // Validate form data
            function validateFormData(formData, isUpdate = false) {
                const errors = [];

                // Validate Name
                const name = formData.get('Name');
                if (!name) {
                    errors.push('Name is required.');
                }

                // Validate Email
                const email = formData.get('Email');
                if (!email) {
                    errors.push('Email is required.');
                } else if (!validateEmail(email)) {
                    errors.push('Invalid email format.');
                }

                // Validate Phone Number
                const phoneNumber = formData.get('PhoneNumber');
                if (phoneNumber && !validatePhoneNumber(phoneNumber)) {
                    errors.push('Invalid phone number format.');
                }

                // Validate URLs
                const testWork = formData.get('TestWork');
                if (testWork && !validateURL(testWork)) {
                    errors.push('Invalid Test Work URL.');
                }

                const loomVideo = formData.get('LoomVideo');
                if (loomVideo && !validateURL(loomVideo)) {
                    errors.push('Invalid Loom Video URL.');
                }

                return errors;
            }

            // Helper functions for validation
            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            function validatePhoneNumber(phoneNumber) {
                const re = /^\+?[0-9\s\-()]+$/;
                return re.test(phoneNumber);
            }

            function validateURL(url) {
                let urlObj;
                try {
                    urlObj = new URL(url);
                } catch (_) {
                    return false;
                }
                return urlObj.protocol === "http:" || urlObj.protocol === "https:";
            }

            // Handle Create Contractor
            async function handleCreateContractor(event) {
                event.preventDefault();
                console.log('Creating new contractor...');

                const form = event.target;
                const formData = new FormData(form);

                // Validate form data
                const errors = validateFormData(formData);
                if (errors.length > 0) {
                    showNotification(errors.join(' '), 'error');
                    return;
                }

                const contractor = {};

                formData.forEach((value, key) => {
                    contractor[key] = value;
                });

                console.log('Contractor data to create:', contractor);

                // Change button text to indicate loading
                const submitButton = form.querySelector('button[type="submit"]');
                const buttonText = document.getElementById('create-button-text');
                submitButton.disabled = true;
                buttonText.textContent = 'Adding...';

                try {
                    const response = await fetch(lambdaUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            'request_type': 'create',
                            'contractors': [contractor]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    console.log('Create result:', result);

                    // Show success message
                    showNotification('Contractor added successfully.', 'success');

                    // Reset the form
                    form.reset();

                    // Invalidate cache and reload data
                    localStorage.removeItem(cacheKey);
                    await fetchContractorsData();

                } catch (error) {
                    console.error('Error creating contractor:', error);
                    showNotification('Error creating contractor.', 'error');
                } finally {
                    submitButton.disabled = false;
                    buttonText.textContent = 'Add Contractor';
                }
            }

            // Handle Edit Contractor
            function handleEditContractor(event) {
                const email = event.target.getAttribute('data-email');
                console.log('Editing contractor with email:', email);

                currentEditingContractorEmail = email;

                // Find the contractor data from the stored data
                const contractorData = contractorsData.find(contractor => contractor.Email === email);

                if (!contractorData) {
                    console.error('Contractor data not found.');
                    showNotification('Contractor data not found.', 'error');
                    return;
                }

                console.log('Contractor data to edit:', contractorData);

                // Populate the update form with existing data
                const updateForm = document.getElementById('update-contractor-form');

                // Set OriginalEmail hidden input
                updateForm.elements['OriginalEmail'].value = contractorData.Email || '';

                // Populate form fields
                for (const key in contractorData) {
                    if (updateForm.elements[key]) {
                        updateForm.elements[key].value = contractorData[key] || '';
                    }
                }

                // Show the modal
                openUpdateModal();
            }

            // Handle Update Contractor
            async function handleUpdateContractor(event) {
                event.preventDefault();
                console.log('Updating contractor...');

                const form = event.target;
                const formData = new FormData(form);

                // Validate form data
                const errors = validateFormData(formData, true);
                if (errors.length > 0) {
                    showNotification(errors.join(' '), 'error');
                    return;
                }

                const originalEmail = form.elements['OriginalEmail'].value;
                const updatedEmail = formData.get('Email'); // New email from the form

                const updateAttributes = {};

                formData.forEach((value, key) => {
                    if (value !== '') {
                        updateAttributes[key] = value;
                    }
                });

                console.log('Original Email:', originalEmail);
                console.log('Update attributes:', updateAttributes);

                // Change button text to indicate loading
                const submitButton = form.querySelector('button[type="submit"]');
                const buttonText = document.getElementById('update-button-text');
                submitButton.disabled = true;
                buttonText.textContent = 'Updating...';

                try {
                    const response = await fetch(lambdaUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            'request_type': 'update',
                            'Email': originalEmail,
                            'update_attributes': updateAttributes
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    console.log('Update result:', result);

                    // Hide the modal
                    closeUpdateModal();

                    // Show success message
                    showNotification('Contractor updated successfully.', 'success');

                    // Invalidate cache and reload data
                    localStorage.removeItem(cacheKey);
                    await fetchContractorsData();

                } catch (error) {
                    console.error('Error updating contractor:', error);
                    showNotification('Error updating contractor.', 'error');
                } finally {
                    submitButton.disabled = false;
                    buttonText.textContent = 'Update Contractor';
                }
            }

            // Handle Delete Contractor
            async function handleDeleteContractor(event) {
                const email = event.target.getAttribute('data-email');
                console.log('Deleting contractor with email:', email);

                if (!confirm(`Are you sure you want to delete the contractor with email: ${email}?`)) {
                    return;
                }

                // Change button text to indicate loading
                event.target.disabled = true;
                const originalText = event.target.textContent;
                event.target.textContent = 'Deleting...';

                try {
                    const response = await fetch(lambdaUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            'request_type': 'delete',
                            'Email': email
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    console.log('Delete result:', result);

                    // Show success message
                    showNotification('Contractor deleted successfully.', 'success');

                    // Invalidate cache and reload data
                    localStorage.removeItem(cacheKey);
                    await fetchContractorsData();

                } catch (error) {
                    console.error('Error deleting contractor:', error);
                    showNotification('Error deleting contractor.', 'error');
                } finally {
                    event.target.disabled = false;
                    event.target.textContent = originalText;
                }
            }

            // Handle Add to Sub Account
            function handleAddToSubAccount(event) {
                const button = event.target;
                const email = button.getAttribute('data-email');
                const firstName = button.getAttribute('data-firstname') || '';
                const lastName = button.getAttribute('data-lastname') || '';
                const phone = button.getAttribute('data-phone') || '';

                console.log('Adding contractor to sub account:', email);

                // Set the form hidden inputs
                const form = document.getElementById('add-subaccount-form');
                form.elements['Email'].value = email;
                form.elements['FirstName'].value = firstName;
                form.elements['LastName'].value = lastName;
                form.elements['Phone'].value = phone;

                // Show the modal
                openAddSubAccountModal();
            }

            // Handle Add to Sub Account Form Submission
            async function handleAddSubAccountSubmit(event) {
                event.preventDefault();

                console.log('Submitting add to sub account...');

                const form = event.target;
                const formData = new FormData(form);

                const userData = {
                    requestType: 'create_user',
                    firstName: formData.get('FirstName'),
                    lastName: formData.get('LastName'),
                    email: formData.get('Email'),
                    password: 'Temporarypassword123!',
                    phone: formData.get('Phone'),
                    role: 'user', // Default role
                    locationId: formData.get('LocationId')
                };

                console.log('Sending user data:', userData);

                const submitButton = document.getElementById('confirm-add-subaccount-btn');
                const buttonText = document.getElementById('add-subaccount-button-text');
                submitButton.disabled = true;
                buttonText.textContent = 'Submitting...';

                try {
                    const response = await fetch('https://pk27rf2b6cl4mdof27koyj7zfu0reobl.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const result = await response.json();
                    console.log('Response:', result);

                    // Show success message
                    showNotification('Contractor added to sub account successfully.', 'success');

                    // Close the modal
                    closeAddSubAccountModal();

                } catch (error) {
                    console.error('Error adding contractor to sub account:', error);
                    showNotification('Error adding contractor to sub account.', 'error');
                } finally {
                    submitButton.disabled = false;
                    buttonText.textContent = 'Yes';
                }
            }

            // Open Update Modal
            function openUpdateModal() {
                const updateModal = document.getElementById('update-modal');
                updateModal.classList.remove('opacity-0', 'pointer-events-none');
                updateModal.classList.add('opacity-100');

                // Accessibility focus management
                updateModal.querySelector('[name="Name"]').focus();
            }

            // Close Update Modal
            function closeUpdateModal() {
                const updateModal = document.getElementById('update-modal');
                updateModal.classList.add('opacity-0', 'pointer-events-none');
                updateModal.classList.remove('opacity-100');

                // Reset the form
                document.getElementById('update-contractor-form').reset();
            }

            // Open Add Sub Account Modal
            function openAddSubAccountModal() {
                const modal = document.getElementById('add-subaccount-modal');
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-100');

                // Accessibility focus management
                modal.querySelector('[name="LocationId"]').focus();
            }

            // Close Add Sub Account Modal
            function closeAddSubAccountModal() {
                const modal = document.getElementById('add-subaccount-modal');
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-100');

                // Reset the form
                document.getElementById('add-subaccount-form').reset();
            }

            // Show Notification
            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                const bgColor = type === 'success' ? 'bg-green-100' : 'bg-red-100';
                const textColor = type === 'success' ? 'text-green-700' : 'text-red-700';
                notification.innerHTML = `
                    <div class="p-4 mb-4 text-sm ${textColor} ${bgColor} rounded-lg" role="alert">
                        <span class="font-medium">${message}</span>
                    </div>
                `;
                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.innerHTML = '';
                }, 3000);
            }

            // Pagination functions
            function resetPagination() {
                currentPage = 1;
            }

            function updatePaginationControls() {
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;

                const prevButton = document.getElementById('prev-page-btn');
                const nextButton = document.getElementById('next-page-btn');

                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages || totalPages === 0;
            }

            function goToPreviousPage() {
                if (currentPage > 1) {
                    currentPage--;
                    displayContractorsData();
                }
            }

            function goToNextPage() {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayContractorsData();
                }
            }

            // Expose public functions if needed
            return {
                init
            };

        })();

        // Initialize the ContractorsManager on page load
        window.addEventListener('DOMContentLoaded', () => {
            ContractorsManager.init();
        });
    </script>
</body>
</html>