<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contractors Data - CRUD Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Contractors Data</h1>

        <!-- Notification Area -->
        <div id="notification" class="mb-4"></div>

        <!-- Search and Filter -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Search and Filter Contractors</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <input type="text" id="search-name" placeholder="Search by Name" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <input type="text" id="filter-country" placeholder="Filter by Country" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <input type="text" id="filter-rates" placeholder="Filter by Rates" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
            </div>
        </div>

        <!-- Create Contractor Form -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Add New Contractor</h2>
            <form id="create-contractor-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Name</label>
                    <input type="text" name="Name" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" name="Email" class="w-full border border-gray-300 rounded px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Phone Number</label>
                    <input type="text" name="PhoneNumber" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Country</label>
                    <input type="text" name="Country" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Test Work URL</label>
                    <input type="url" name="TestWork" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Loom Video URL</label>
                    <input type="url" name="LoomVideo" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Rates</label>
                    <input type="text" name="Rates" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Add Contractor</button>
                </div>
            </form>
        </div>

        <!-- Contractors List -->
        <div id="contractors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- Update Contractor Modal -->
    <div id="update-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Update Contractor</h2>
            <form id="update-contractor-form" class="grid grid-cols-1 gap-4">
                <input type="hidden" name="Email">
                <div>
                    <label class="block text-sm font-medium mb-1">Name</label>
                    <input type="text" name="Name" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Phone Number</label>
                    <input type="text" name="PhoneNumber" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Country</label>
                    <input type="text" name="Country" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Test Work URL</label>
                    <input type="url" name="TestWork" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Loom Video URL</label>
                    <input type="url" name="LoomVideo" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Rates</label>
                    <input type="text" name="Rates" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-update-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Update Contractor</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const lambdaUrl = 'https://in3k57uvf5h3tdi4ntgdtvqrfi0ydvie.lambda-url.us-west-2.on.aws/';

        // Holds the data fetched from the server
        let contractorsData = [];

        // Current contractor being edited
        let currentEditingContractorEmail = null;

        // Function to display notifications
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.innerHTML = `
                <div class="p-4 mb-4 text-sm text-${type === 'success' ? 'green' : 'red'}-700 bg-${type === 'success' ? 'green' : 'red'}-100 rounded-lg" role="alert">
                    <span class="font-medium">${message}</span>
                </div>
            `;
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.innerHTML = '';
            }, 3000);
        }

        // Function to fetch data from the Lambda function
        async function fetchContractorsData() {
            console.log('Fetching contractors data...');

            try {
                const response = await fetch(lambdaUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'request_type': 'read'
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log('Data received:', data);

                contractorsData = data;
                displayContractorsData(data);

            } catch (error) {
                console.error('Error fetching data:', error);
                showNotification('Error fetching contractors data', 'error');
            }
        }

        // Function to display contractors data
        function displayContractorsData(contractors) {
            const container = document.getElementById('contractors-container');
            container.innerHTML = ''; // Clear previous data

            const filteredContractors = filterContractors(contractors);

            if (filteredContractors.length === 0) {
                container.innerHTML = '<p>No contractors found.</p>';
                return;
            }

            filteredContractors.forEach(contractor => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 shadow rounded relative';

                card.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">${contractor.Name || 'No Name'}</h2>
                    <p><strong>Email:</strong> ${contractor.Email || 'N/A'}</p>
                    <p><strong>Phone Number:</strong> ${contractor.PhoneNumber || 'N/A'}</p>
                    <p><strong>Country:</strong> ${contractor.Country || 'N/A'}</p>
                    <p><strong>Test Work:</strong> <a href="${contractor.TestWork || '#'}" class="text-blue-500" target="_blank">View</a></p>
                    <p><strong>Loom Video:</strong> <a href="${contractor.LoomVideo || '#'}" class="text-blue-500" target="_blank">Watch</a></p>
                    <p><strong>Rates:</strong> ${contractor.Rates || 'N/A'}</p>
                    <div class="mt-4 flex space-x-2">
                        <button class="edit-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded" data-email="${contractor.Email}">Edit</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" data-email="${contractor.Email}">Delete</button>
                    </div>
                `;

                container.appendChild(card);
            });

            // Add event listeners for Edit and Delete buttons
            const editButtons = document.querySelectorAll('.edit-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');

            editButtons.forEach(button => {
                button.addEventListener('click', handleEditContractor);
            });

            deleteButtons.forEach(button => {
                button.addEventListener('click', handleDeleteContractor);
            });
        }

        // Function to filter contractors based on search/filter inputs
        function filterContractors(contractors) {
            const searchName = document.getElementById('search-name').value.toLowerCase();
            const filterCountry = document.getElementById('filter-country').value.toLowerCase();
            const filterRates = document.getElementById('filter-rates').value.toLowerCase();

            return contractors.filter(contractor => {
                const matchesName = contractor.Name && contractor.Name.toLowerCase().includes(searchName);
                const matchesCountry = !filterCountry || (contractor.Country && contractor.Country.toLowerCase().includes(filterCountry));
                const matchesRates = !filterRates || (contractor.Rates && contractor.Rates.toLowerCase().includes(filterRates));

                return matchesName && matchesCountry && matchesRates;
            });
        }

        // Event listeners for search/filter inputs
        document.getElementById('search-name').addEventListener('input', () => displayContractorsData(contractorsData));
        document.getElementById('filter-country').addEventListener('input', () => displayContractorsData(contractorsData));
        document.getElementById('filter-rates').addEventListener('input', () => displayContractorsData(contractorsData));

        // Function to validate form inputs
        function validateFormData(formData, isUpdate = false) {
            const errors = [];

            // Validate Name
            const name = formData.get('Name');
            if (!name) {
                errors.push('Name is required.');
            }

            // Validate Email (only for create, not for update)
            const email = formData.get('Email');
            if (!isUpdate) {
                if (!email) {
                    errors.push('Email is required.');
                } else if (!validateEmail(email)) {
                    errors.push('Invalid email format.');
                }
            }

            // Validate Phone Number
            const phoneNumber = formData.get('PhoneNumber');
            if (phoneNumber && !validatePhoneNumber(phoneNumber)) {
                errors.push('Invalid phone number format.');
            }

            // Validate URLs
            const testWork = formData.get('TestWork');
            if (testWork && !validateURL(testWork)) {
                errors.push('Invalid Test Work URL.');
            }

            const loomVideo = formData.get('LoomVideo');
            if (loomVideo && !validateURL(loomVideo)) {
                errors.push('Invalid Loom Video URL.');
            }

            return errors;
        }

        // Helper functions for validation
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhoneNumber(phoneNumber) {
            const re = /^\+?[0-9\s\-()]+$/;
            return re.test(phoneNumber);
        }

        function validateURL(url) {
            let urlObj;
            try {
                urlObj = new URL(url);
            } catch (_) {
                return false;
            }
            return urlObj.protocol === "http:" || urlObj.protocol === "https:";
        }

        // Function to handle Create Contractor
        async function handleCreateContractor(event) {
            event.preventDefault();
            console.log('Creating new contractor...');

            const form = event.target;
            const formData = new FormData(form);

            // Validate form data
            const errors = validateFormData(formData);
            if (errors.length > 0) {
                showNotification(errors.join(' '), 'error');
                return;
            }

            const contractor = {};

            formData.forEach((value, key) => {
                contractor[key] = value;
            });

            console.log('Contractor data to create:', contractor);

            try {
                const response = await fetch(lambdaUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'request_type': 'create',
                        'contractors': [contractor]
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                console.log('Create result:', result);

                // Show success message
                showNotification('Contractor added successfully.', 'success');

                // Refresh the contractors list
                fetchContractorsData();

                // Reset the form
                form.reset();

            } catch (error) {
                console.error('Error creating contractor:', error);
                showNotification('Error creating contractor.', 'error');
            }
        }

        // Function to handle Edit Contractor
        function handleEditContractor(event) {
            const email = event.target.getAttribute('data-email');
            console.log('Editing contractor with email:', email);

            currentEditingContractorEmail = email;

            // Find the contractor data from the stored data
            const contractorData = contractorsData.find(contractor => contractor.Email === email);

            if (!contractorData) {
                console.error('Contractor data not found.');
                showNotification('Contractor data not found.', 'error');
                return;
            }

            console.log('Contractor data to edit:', contractorData);

            // Populate the update form with existing data
            const updateModal = document.getElementById('update-modal');
            const updateForm = document.getElementById('update-contractor-form');

            for (const key in contractorData) {
                if (updateForm.elements[key]) {
                    updateForm.elements[key].value = contractorData[key] || '';
                }
            }

            // Show the modal
            updateModal.classList.remove('hidden');
        }

        // Function to handle Update Contractor
        async function handleUpdateContractor(event) {
            event.preventDefault();
            console.log('Updating contractor...');

            const form = event.target;
            const formData = new FormData(form);

            // Validate form data
            const errors = validateFormData(formData, true);
            if (errors.length > 0) {
                showNotification(errors.join(' '), 'error');
                return;
            }

            const email = formData.get('Email');
            const updateAttributes = {};

            formData.forEach((value, key) => {
                if (key !== 'Email' && value !== '') {
                    updateAttributes[key] = value;
                }
            });

            console.log('Email:', email);
            console.log('Update attributes:', updateAttributes);

            try {
                const response = await fetch(lambdaUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'request_type': 'update',
                        'Email': email,
                        'update_attributes': updateAttributes
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                console.log('Update result:', result);

                // Hide the modal
                document.getElementById('update-modal').classList.add('hidden');

                // Show success message
                showNotification('Contractor updated successfully.', 'success');

                // Refresh the contractors list
                fetchContractorsData();

            } catch (error) {
                console.error('Error updating contractor:', error);
                showNotification('Error updating contractor.', 'error');
            }
        }

        // Function to handle Delete Contractor
        async function handleDeleteContractor(event) {
            const email = event.target.getAttribute('data-email');
            console.log('Deleting contractor with email:', email);

            if (!confirm('Are you sure you want to delete this contractor?')) {
                return;
            }

            try {
                const response = await fetch(lambdaUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'request_type': 'delete',
                        'Email': email
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                console.log('Delete result:', result);

                // Show success message
                showNotification('Contractor deleted successfully.', 'success');

                // Refresh the contractors list
                fetchContractorsData();

            } catch (error) {
                console.error('Error deleting contractor:', error);
                showNotification('Error deleting contractor.', 'error');
            }
        }

        // Event listener for Create Contractor form
        document.getElementById('create-contractor-form').addEventListener('submit', handleCreateContractor);

        // Event listener for Update Contractor form
        document.getElementById('update-contractor-form').addEventListener('submit', handleUpdateContractor);

        // Event listener for Cancel Update button
        document.getElementById('cancel-update-btn').addEventListener('click', () => {
            document.getElementById('update-modal').classList.add('hidden');
        });

        // Call the function when the page loads
        window.onload = fetchContractorsData;
    </script>
</body>
</html>
