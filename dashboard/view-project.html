<!DOCTYPE html>
<html>
<head>
    <title>File Contents</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" rel="stylesheet">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <style>
        #allTabs {
            display: flex;
            align-items: center;
        }
        .tab {
            margin-right: 10px;
            cursor: pointer;
        }
        .close {
            margin-left: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body class="flex flex-col h-screen m-0 pb-16">
    <div class="flex flex-col items-stretch w-full">
        <div class="mb-2">
            <select id="fileSelect" onchange="fetchFileContents(this.value)" class="w-full">
                <option>Select File</option>
            </select>
        </div>
        <button id="executeCodeButton" class="absolute right-0 hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
  <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
</svg>
</button>
        <div class="flex items-center mb-2">
            <button id="viewCodeButton" class="mr-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
</svg>
</button>
            <button id="previewCodeButton" class="mr-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
</svg>
</button>
            <button id="viewLogsButton" class="mr-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" />
</svg>
</button>
        </div>
        <div class="flex items-center mb-2">
            <div id="allTabs" class="mr-2"></div>
            <div class="inline-block px-2 border border-gray-300 cursor-pointer" id="addTab"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
  <path fill-rule="evenodd" d="M12 5.25a.75.75 0 01.75.75v5.25H18a.75.75 0 010 1.5h-5.25V18a.75.75 0 01-1.5 0v-5.25H6a.75.75 0 010-1.5h5.25V6a.75.75 0 01.75-.75z" clip-rule="evenodd" />
</svg>
</div>
        </div>
        <div class="mb-2">
            <button id="saveSelectedFileButton" class="w-full">Save File</button>
        </div>
        <button id="editCodeButton" class="mr-2">Edit Code</button>
        <button id="saveCodeEditsButton" class="hidden mr-2">Save</button>
        <button id="cancelCodeEditsButton" class="hidden mr-2">Cancel</button>
    </div>
    <div class="flex-grow w-full overflow-auto flex flex-col" id="viewCodeBox">
        <pre><code id="codeBox" class="w-full"></code></pre>
    </div>
    <div class="flex-grow w-full overflow-auto flex flex-col hidden" id="editCodeBox">
        <textarea id="editCodeTextArea" class="w-full h-full border-none box-border"></textarea>
    </div>
    <div class="flex-grow w-full overflow-auto flex flex-col" id="previewRenderCodeBox">
        <iframe id="previewCodeIframe" class="w-full h-full border-none"></iframe>
    </div>
    <div id="userRequestContainer" class="fixed bottom-0 left-0 right-0 z-50 bg-gray-100 border-t border-gray-300 p-2 shadow-md">
        <input type="text" id="userRequestInputBox" class="w-full placeholder-gray-500" placeholder="Enter your request here">
        <button id="submitUserRequestButton" class="mt-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
</svg>
</button>
        <button id="addReferenceButton" class="mt-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
  <path fill-rule="evenodd" d="M12 5.25a.75.75 0 01.75.75v5.25H18a.75.75 0 010 1.5h-5.25V18a.75.75 0 01-1.5 0v-5.25H6a.75.75 0 010-1.5h5.25V6a.75.75 0 01.75-.75z" clip-rule="evenodd" />
</svg>
</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-markup.min.js"></script>
<script>
// Constants
const LANGUAGE_MAP = {
    'py': 'python',
    'js': 'javascript',
    'css': 'css',
    'html': 'markup'
};

// File data
let fileDataArray = [
{
    "fileName": "index.html",
    "fileContents": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Explore Space</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #000; color: #fff; }\n        .container { width: 80%; margin: auto; }\n        header { text-align: center; padding: 2rem 0; }\n        h1 { margin: 0; }\n        .content { margin: 2rem 0; }\n        img { max-width: 100%; height: auto; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <header>\n            <h1>Welcome to the Space Exploration Site</h1>\n        </header>\n        <div class=\"content\">\n            <h2>Our Universe</h2>\n            <p>Space is vast and has always been a subject of mystery and intrigue. The universe is filled with wonders like stars, planets, and galaxies.</p>\n            <img src=\"images/universe.jpg\" alt=\"Universe\">\n        </div>\n        <div class=\"content\">\n            <h2>Space Missions</h2>\n            <p>Humanity has embarked on numerous space missions to explore the unknown. From the Apollo moon landings to the Mars rovers, each mission has expanded our understanding of the cosmos.</p>\n            <img src=\"images/space-mission.jpg\" alt=\"Space Mission\">\n        </div>\n    </div>\n</body>\n</html>"
}];

let currentSelectedTab = 0;

// DOM Elements
const elements = {
    allTabs: document.getElementById('allTabs'),
    addTab: document.getElementById('addTab'),
    codeBox: document.getElementById('codeBox'),
    codeContainer: document.querySelector('.code-container'),
    viewCodeButton: document.getElementById('viewCodeButton'),
    previewCodeButton: document.getElementById('previewCodeButton'),
    viewLogsButton: document.getElementById('viewLogsButton'),
    editCodeButton: document.getElementById('editCodeButton'),
    saveCodeEditsButton: document.getElementById('saveCodeEditsButton'),
    cancelCodeEditsButton: document.getElementById('cancelCodeEditsButton'),
    viewCodeBox: document.getElementById('viewCodeBox'),
    editCodeBox: document.getElementById('editCodeBox'),
    editCodeTextArea: document.getElementById('editCodeTextArea'),
    previewRenderCodeBox: document.getElementById('previewRenderCodeBox'),
    previewCodeIframe: document.getElementById('previewCodeIframe'),
    submitUserRequestButton: document.getElementById('submitUserRequestButton'),
    userRequestInputBox: document.getElementById('userRequestInputBox'),
    fileSelect: document.getElementById('fileSelect'),
    saveSelectedFileButton: document.getElementById('saveSelectedFileButton'),
    executeCodeButton: document.getElementById('executeCodeButton')
};

// Helper functions
const extractFileExtension = fileName => fileName.split('.').pop();
const mapFileExtensionToPrismLanguage = extension => LANGUAGE_MAP[extension] || '';
const highlightCodeWithPrism = (fileName, fileContents) => {
    const extension = extractFileExtension(fileName);
    const language = mapFileExtensionToPrismLanguage(extension);
    elements.codeBox.className = `language-${language}`;
    elements.codeBox.innerHTML = Prism.highlight(fileContents, Prism.languages[language], language);
}

// Event handlers
const handleTabClick = (event) => {
    const index = event.target.getAttribute('data-index');
    displayFileContentInTab(index);
    elements.viewCodeButton.click();
    elements.editCodeButton.style.display = 'inline-block';
    const fileName = fileDataArray[index].fileName;
    showExecuteCodeButton(fileName);
};

const handleCloseClick = (event) => {
    event.stopPropagation();
    const index = event.target.getAttribute('data-index');
    removeTabAndFileData(index);
};

const handleAddClick = () => {
    const fileName = prompt("Enter file name:");
    const fileExists = fileDataArray.some(file => file.fileName === fileName);
    if (fileExists) {
        alert('File name already exists. Please choose another file name');
    } else if (fileName) {
        const newFile = { fileName, fileContents: '' };
        fileDataArray.push(newFile);
        generateAllFileTabElements();
        displayFileContentInTab(fileDataArray.length - 1);
        showExecuteCodeButton(fileName);
    }
};

const handlePreviewClick = () => {
    const {fileContents} = fileDataArray[currentSelectedTab];
    elements.previewCodeIframe.srcdoc = fileContents;
    elements.previewRenderCodeBox.style.display = 'block';
    elements.viewCodeBox.style.display = 'none';
    highlightSelectedButton('previewCodeButton');
};

// Main functions
const generateFileTabElement = (fileName, index) => {
    const tab = document.createElement('div');
    tab.className = 'tab flex items-center'; // Add flex and items-center for alignment
    tab.textContent = fileName;
    tab.setAttribute('data-index', index);
    tab.addEventListener('click', handleTabClick);

    // Create an SVG element for the close icon
    const svgNS = "http://www.w3.org/2000/svg";
    const closeIcon = document.createElementNS(svgNS, "svg");
    closeIcon.setAttributeNS(null, "viewBox", "0 0 20 20");
    closeIcon.setAttributeNS(null, "fill", "currentColor");
    closeIcon.classList.add("w-5", "h-5", "ml-2"); // Add margin-left for spacing

    // Create a path element for the SVG
    const path = document.createElementNS(svgNS, "path");
    path.setAttributeNS(null, "d", "M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z");

    // Append the path to the SVG, and the SVG to the close button container
    closeIcon.appendChild(path);

    // Create a container for the close button
    const close = document.createElement('div');
    close.className = 'close cursor-pointer'; // Add cursor-pointer for better UX
    close.setAttribute('data-index', index);
    close.addEventListener('click', handleCloseClick);

    // Append the SVG icon to the close button container
    close.appendChild(closeIcon);

    // Append the file name and close button to the tab
    tab.appendChild(close);
    elements.allTabs.appendChild(tab);
};

const generateAllFileTabElements = () => {
    elements.allTabs.innerHTML = '';
    fileDataArray.forEach(({fileName}, index) => {
        generateFileTabElement(fileName, index);
    });
};

const displayFileContentInTab = index => {
    currentSelectedTab = index;
    const {fileName, fileContents} = fileDataArray[index];
    highlightCodeWithPrism(fileName, fileContents);
    toggleViewButtonsBasedOnFileType(fileName);
    elements.viewCodeButton.click();
    highlightSelectedTab(index);
    resetEditCodeBox();
    elements.previewRenderCodeBox.style.display = 'none';
};

const removeTabAndFileData = index => {
    fileDataArray.splice(index, 1);
    generateAllFileTabElements();
    if (fileDataArray.length > 0) {
        displayFileContentInTab(0);
    }
};

const toggleViewButtonsBasedOnFileType = (fileName) => {
    const extension = extractFileExtension(fileName);
    if (extension === 'html') {
        elements.previewCodeButton.style.display = 'inline-block';
        elements.viewLogsButton.style.display = 'inline-block';
        elements.executeCodeButton.style.display = 'none'; // Hide execute button
    } else if (extension === 'py') {
        elements.previewCodeButton.style.display = 'none';
        elements.viewLogsButton.style.display = 'inline-block';
        elements.executeCodeButton.style.display = 'inline-block'; // Show execute button
    } else {
        elements.previewCodeButton.style.display = 'none';
        elements.viewLogsButton.style.display = 'none';
        elements.executeCodeButton.style.display = 'none'; // Hide execute button
    }
}

const highlightSelectedTab = (index) => {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.style.fontWeight = 'normal');
    tabs[index].style.fontWeight = 'bold';
}

const highlightSelectedButton = (selectedButtonId) => {
    const buttons = document.querySelectorAll('.codeBoxOptionsContainer button');
    buttons.forEach(button => {
        if (button.id === selectedButtonId) {
            button.style.fontWeight = 'bold';
        } else {
            button.style.fontWeight = 'normal';
        }
    });
}

const showOrHideCodeBox = (selectedButtonId) => {
    if (selectedButtonId === 'viewCodeButton') {
        elements.codeContainer.style.display = 'block';
    } else {
        elements.codeContainer.style.display = 'none';
    }
}

const resetEditCodeBox = () => {
    elements.editCodeButton.style.display = 'inline-block';
    elements.saveCodeEditsButton.style.display = 'none';
    elements.cancelCodeEditsButton.style.display = 'none';
    elements.executeCodeButton.style.display = 'none'; // Hide execute button
    elements.viewCodeBox.style.display = 'block';
    elements.editCodeBox.style.display = 'none';
}

const showExecuteCodeButton = (fileName) => {
    const extension = extractFileExtension(fileName);
    if (extension === 'py') {
        elements.executeCodeButton.style.display = 'inline-block'; // Show execute button
    } else {
        elements.executeCodeButton.style.display = 'none'; // Hide execute button
    }
};

// Add the executeCode function
const executeCode = () => {
    const apiUrl = "https://4x3ubnjm4rwzbwaucrcn2trn3m0vvsqp.lambda-url.us-west-2.on.aws/";
    const currentFile = fileDataArray[currentSelectedTab];
    const codeExecutionData = {
        'filePath': currentFile.fileName,
        'ec2InstanceId': 'i-09a3e0707ffcfdfdb', // You might want to make this dynamic
        'code': currentFile.fileContents,
        'uId': uId,
        'projectId': projectId
    };
    
    // Indicate that the code execution is in progress
    elements.executeCodeButton.textContent = 'Running...';
    elements.executeCodeButton.disabled = true;

    // Send the POST request using Axios
    axios.post(apiUrl, codeExecutionData, {
        headers: {
            'Content-type': 'application/json'
        }
    })
    .then(response => {
        // Display the output from the response
        const { StandardOutputContent, StandardErrorContent } = response.data;
        alert(`Standard Output: ${StandardOutputContent}\nStandard Error: ${StandardErrorContent}`);
    })
    .catch(error => {
        // Display the error
        alert(`Error: ${error}`);
    })
    .finally(() => {
        // Reset the button state after execution
        elements.executeCodeButton.textContent = 'Run Code';
        elements.executeCodeButton.disabled = false;
    });
};

// Event listeners
elements.viewCodeButton.addEventListener('click', () => {
    highlightSelectedButton('viewCodeButton');
    elements.viewCodeBox.style.display = 'block';
    elements.previewRenderCodeBox.style.display = 'none'; 
    elements.editCodeBox.style.display = 'none';
    elements.editCodeButton.style.display = 'inline-block'; 
});

elements.viewLogsButton.addEventListener('click', () => {
    highlightSelectedButton('viewLogsButton');
    showOrHideCodeBox('viewLogsButton');
    elements.previewRenderCodeBox.style.display = 'none'; 
    elements.editCodeButton.style.display = 'inline-block';
    elements.saveCodeEditsButton.style.display = 'none';
    elements.cancelCodeEditsButton.style.display = 'none';
    elements.editCodeBox.style.display = 'none'; // Add this line
});

elements.previewCodeButton.addEventListener('click', () => {
    highlightSelectedButton('previewCodeButton');
    elements.viewCodeBox.style.display = 'none';
    elements.previewRenderCodeBox.style.display = 'block'; 
    elements.editCodeBox.style.display = 'none';
    elements.editCodeButton.style.display = 'inline-block';
    handlePreviewClick();
});

elements.editCodeButton.addEventListener('click', () => {
    elements.editCodeButton.style.display = 'none';
    elements.saveCodeEditsButton.style.display = 'inline-block';
    elements.cancelCodeEditsButton.style.display = 'inline-block';
    elements.viewCodeBox.style.display = 'none';
    elements.previewRenderCodeBox.style.display = 'none';
    elements.editCodeBox.style.display = 'block';
    elements.editCodeTextArea.value = fileDataArray[currentSelectedTab].fileContents;
});
elements.saveCodeEditsButton.addEventListener('click', () => {
    fileDataArray[currentSelectedTab].fileContents = elements.editCodeTextArea.value;
    resetEditCodeBox();
    displayFileContentInTab(currentSelectedTab);
});
elements.cancelCodeEditsButton.addEventListener('click', resetEditCodeBox);
elements.previewCodeButton.addEventListener('click', handlePreviewClick);

elements.saveSelectedFileButton.addEventListener('click', () => {
    const currentFile = fileDataArray[currentSelectedTab];
    console.log(uId,'uId')
    console.log(projectId,'projectId')
    console.log(currentFile,'currentFile')
    axios.post('https://3xe2jl5kc5ypwyvu4om4nrsoxa0ykhxh.lambda-url.us-west-2.on.aws/', {
        'requestType': 'COMMIT_FILE',
        'fileContents': currentFile.fileContents,
        'fileName': currentFile.fileName,
        'uId': uId,
        'projectId': projectId
    })
    .then(function (response) {
        console.log(response);
    })
    .catch(function (error) {
        console.log(error);
    });
});

elements.submitUserRequestButton.addEventListener('click', () => {
    const currentFile = fileDataArray[currentSelectedTab];
    const userRequest = elements.userRequestInputBox.value;
    
    axios.post('https://mse2nh3pjqhy5qwkenzfeds7dq0ulcfy.lambda-url.us-west-2.on.aws/', {
        fileName: currentFile.fileName,
        request: userRequest,
        code: currentFile.fileContents,
        uId: uId
    })
    .then(function (response) {
        alert(response);
        const newCode = response.data.newCode;
        const fileName = response.data.fileName;
        
        const fileToUpdate = fileDataArray.find(file => file.fileName === fileName);
        if (fileToUpdate) {
            fileToUpdate.fileContents = newCode;
            const updatedFileIndex = fileDataArray.indexOf(fileToUpdate);
            displayFileContentInTab(updatedFileIndex);
            elements.viewCodeButton.click();
        }
    })
    .catch(function (error) {
               console.log(error);
    });

    elements.userRequestInputBox.value = '';
});

elements.addTab.addEventListener('click', handleAddClick);

// Add the event listener to the "Run Code" button
elements.executeCodeButton.addEventListener('click', executeCode);

window.onload = function() {
    extractuIdFromUrl();
    extractprojectIdFromUrl();

    axios.post('https://3xe2jl5kc5ypwyvu4om4nrsoxa0ykhxh.lambda-url.us-west-2.on.aws/', {
        'uId': uId,
        'projectId': projectId,
        'requestType': 'fetchAllProjectFiles'
    })
    .then(function (response) {
        if(response.status === 200) {
            const projectFilesArray = response.data;
            const select = document.getElementById('fileSelect');
            projectFilesArray.forEach((filePath, index) => {
                const option = document.createElement('option');
                option.value = filePath;
                option.text = filePath;
                select.appendChild(option);
            });
        }
    })
    .catch(function (error) {
        console.log(error);
    });
};

function fetchFileContents(fileName) {
    axios.post('https://3xe2jl5kc5ypwyvu4om4nrsoxa0ykhxh.lambda-url.us-west-2.on.aws/', {
        'uId': uId,
        'projectId': projectId,
        'requestType': 'fetchFileContents',
        'filePath': fileName
    })
    .then(function (response) {
        if(response.status === 200) {
            const fileData = {
                'fileName': response.data.fileName,
                'fileContents': response.data.fileContents
            };
            fileDataArray.push(fileData);
            generateAllFileTabElements();
            displayFileContentInTab(fileDataArray.length - 1);
            showExecuteCodeButton(fileName);
        }
    })
    .catch(function (error) {
        console.log(error);
    });
}
function extractuIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const uId = urlParams.get('uId');
    return uId;
}
function extractprojectIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');
    return projectId;
}
let uId = extractuIdFromUrl();
let projectId = extractprojectIdFromUrl();

// Initialize
generateAllFileTabElements();
displayFileContentInTab(0);
</script>
</body>
</html>
