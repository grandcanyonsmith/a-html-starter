<!DOCTYPE html>
<html>
<head>
    <title>File Contents</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" rel="stylesheet">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<style>

    .tabsContainer, .codeBoxOptionsContainer {
        display: flex;
        align-items: center;
    }
    .tab {
        display: inline-block;
        padding: 10px;
        padding-right: 20px; /* Add some padding to the right */
        border: 1px solid #ccc;
        margin-right: 5px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: 250px;
        position: relative;
        font-size: 12px;
        cursor: pointer;
    }
    .close {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        color: lightgray;
        cursor: pointer;
    }
    .add {
        display: inline-block;
        padding: 10px;
        border: 1px solid #ccc;
        margin-left: 5px;
        cursor: pointer;
    }
/* Remove or comment out styles that use absolute positioning */
#editCodeButton {
    /* position: absolute; */
    /* right: 0; */
    /* top: 60px; */
}


/* Add a container for the header elements */
.header-container {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    width: 100%;
}

/* Adjust the main container to be a flex container */
/* Adjust the main container to be a flex container */
/* Adjust the main container to be a flex container */
body {
    display: flex;
    flex-direction: column;
    height: 100vh;
    margin: 0;
    padding-bottom: 60px; /* Adjust this value based on the height of your user request container */

}



.code-container {
    flex-grow: 1; /* This will allow the container to expand */
    width: 100%;
    overflow: auto;
    display: flex; /* Make sure this is a flex container */
    flex-direction: column; /* Stack children vertically */
}

/* Ensure #previewRenderCodeBox takes up all available space */
/* Ensure both #previewRenderCodeBox and #editCodeBox take up all available space */
#previewRenderCodeBox, #editCodeBox {
    flex-grow: 1; /* Allow these boxes to grow and fill available space */
    width: 100%; /* Full width */
}
#previewCodeIframe {
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    border: none; /* Remove border */
}
    #editCodeBox {
        height: 500px; /* Add this line */
    }
/* Style for the user request container */
/* Style for the user request container */
#userRequestContainer {
    position: fixed; /* Make the container fixed position */
    bottom: 0; /* Stick it to the bottom */
    left: 0; /* Align it to the left */
    right: 0; /* Align it to the right */
    z-index: 1000; /* Ensure it's above other elements */
    background: #f9f9f9; /* Different background to distinguish the area */
    border-top: 1px solid #ccc; /* Add a border at the top */
    padding: 10px; /* Add some padding */
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); /* Optional: add shadow for better separation */
}

/* Style for the textarea inside the edit code box */
#editCodeTextArea {
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    border: none; /* Remove border */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

</style>
</head>
<body>
<!-- Add a new div with class header-container to wrap header elements -->
<div class="header-container">
    <select id="fileSelect" onchange="fetchFileContents(this.value)">
        <option>Select File</option>
    </select>
    <button id="executeCodeButton" style="position: absolute; right: 0; display: none;">Run Code</button>
    <div class="codeBoxOptionsContainer">
        <button id="viewCodeButton">View Code</button>
        <button id="previewCodeButton">Preview Code</button>
        <button id="viewLogsButton">View Logs</button>
    </div>
    <div class="tabsContainer">
        <div id="allTabs"></div>
        <div class="add" id="addTab">+</div>
    </div>
    <div style="position: absolute; left: 0;">
        <button id="saveSelectedFileButton">Save File</button>
        <button id="saveAllFilesButton">Save All Files</button>
    </div>
    <button id="editCodeButton">Edit Code</button>
    <button id="saveCodeEditsButton" style="display: none;">Save</button>
    <button id="cancelCodeEditsButton" style="display: none;">Cancel</button>
</div>
    <div class="code-container" id="viewCodeBox">
        <pre><code id="codeBox"></code></pre>
    </div>
    <div class="code-container" style="display: none;" id="editCodeBox">
        <textarea id="editCodeTextArea" style="width: 100%; height: 100%;"></textarea>
    </div>
<!-- Code container for the preview box -->
<div class="code-container" id="previewRenderCodeBox">
    <iframe id="previewCodeIframe"></iframe>
</div>

<!-- Container for the user request input and buttons -->
<div id="userRequestContainer">
    <input type="text" id="userRequestInputBox" placeholder="Enter your request here">
    <button id="submitUserRequestButton">Submit</button>
    <button id="addReferenceButton">Add Reference File</button>
</div>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-markup.min.js"></script>
<script>
// Constants
const LANGUAGE_MAP = {
    'py': 'python',
    'js': 'javascript',
    'css': 'css',
    'html': 'markup'
};

// File data
let fileDataArray = [
{
    "fileName": "index.html",
    "fileContents": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Explore Space</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #000; color: #fff; }\n        .container { width: 80%; margin: auto; }\n        header { text-align: center; padding: 2rem 0; }\n        h1 { margin: 0; }\n        .content { margin: 2rem 0; }\n        img { max-width: 100%; height: auto; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <header>\n            <h1>Welcome to the Space Exploration Site</h1>\n        </header>\n        <div class=\"content\">\n            <h2>Our Universe</h2>\n            <p>Space is vast and has always been a subject of mystery and intrigue. The universe is filled with wonders like stars, planets, and galaxies.</p>\n            <img src=\"images/universe.jpg\" alt=\"Universe\">\n        </div>\n        <div class=\"content\">\n            <h2>Space Missions</h2>\n            <p>Humanity has embarked on numerous space missions to explore the unknown. From the Apollo moon landings to the Mars rovers, each mission has expanded our understanding of the cosmos.</p>\n            <img src=\"images/space-mission.jpg\" alt=\"Space Mission\">\n        </div>\n    </div>\n</body>\n</html>"
}];

let currentSelectedTab = 0;

// DOM Elements
const elements = {
    allTabs: document.getElementById('allTabs'),
    addTab: document.getElementById('addTab'),
    codeBox: document.getElementById('codeBox'),
    codeContainer: document.querySelector('.code-container'),
    viewCodeButton: document.getElementById('viewCodeButton'),
    previewCodeButton: document.getElementById('previewCodeButton'),
    viewLogsButton: document.getElementById('viewLogsButton'),
    editCodeButton: document.getElementById('editCodeButton'),
    saveCodeEditsButton: document.getElementById('saveCodeEditsButton'),
    cancelCodeEditsButton: document.getElementById('cancelCodeEditsButton'),
    viewCodeBox: document.getElementById('viewCodeBox'),
    editCodeBox: document.getElementById('editCodeBox'),
    editCodeTextArea: document.getElementById('editCodeTextArea'),
    previewRenderCodeBox: document.getElementById('previewRenderCodeBox'),
    previewCodeIframe: document.getElementById('previewCodeIframe'),
    submitUserRequestButton: document.getElementById('submitUserRequestButton'),
    userRequestInputBox: document.getElementById('userRequestInputBox'),
    fileSelect: document.getElementById('fileSelect'),
    saveSelectedFileButton: document.getElementById('saveSelectedFileButton'),
    executeCodeButton: document.getElementById('executeCodeButton')
};

// Helper functions
const extractFileExtension = fileName => fileName.split('.').pop();
const mapFileExtensionToPrismLanguage = extension => LANGUAGE_MAP[extension] || '';
const highlightCodeWithPrism = (fileName, fileContents) => {
    const extension = extractFileExtension(fileName);
    const language = mapFileExtensionToPrismLanguage(extension);
    elements.codeBox.className = `language-${language}`;
    elements.codeBox.innerHTML = Prism.highlight(fileContents, Prism.languages[language], language);
}

// Event handlers
const handleTabClick = (event) => {
    const index = event.target.getAttribute('data-index');
    displayFileContentInTab(index);
    elements.viewCodeButton.click();
    elements.editCodeButton.style.display = 'inline-block';
    const fileName = fileDataArray[index].fileName;
    showExecuteCodeButton(fileName);
};

const handleCloseClick = (event) => {
    event.stopPropagation();
    const index = event.target.getAttribute('data-index');
    removeTabAndFileData(index);
};

const handleAddClick = () => {
    const fileName = prompt("Enter file name:");
    const fileExists = fileDataArray.some(file => file.fileName === fileName);
    if (fileExists) {
        alert('File name already exists. Please choose another file name');
    } else if (fileName) {
        const newFile = { fileName, fileContents: '' };
        fileDataArray.push(newFile);
        generateAllFileTabElements();
        displayFileContentInTab(fileDataArray.length - 1);
        showExecuteCodeButton(fileName);
    }
};

const handlePreviewClick = () => {
    const {fileContents} = fileDataArray[currentSelectedTab];
    elements.previewCodeIframe.srcdoc = fileContents;
    elements.previewRenderCodeBox.style.display = 'block';
    highlightSelectedButton('previewCodeButton');
};

// Main functions
const generateFileTabElement = (fileName, index) => {
    const tab = document.createElement('div');
    tab.className = 'tab';
    tab.textContent = fileName;
    tab.setAttribute('data-index', index);
    tab.addEventListener('click', handleTabClick);

    const close = document.createElement('span');
    close.className = 'close';
    close.textContent = 'x';
    close.setAttribute('data-index', index);
    close.addEventListener('click', handleCloseClick);

    tab.appendChild(close);
    elements.allTabs.appendChild(tab);
};

const generateAllFileTabElements = () => {
    elements.allTabs.innerHTML = '';
    fileDataArray.forEach(({fileName}, index) => {
        generateFileTabElement(fileName, index);
    });
};

const displayFileContentInTab = index => {
    currentSelectedTab = index;
    const {fileName, fileContents} = fileDataArray[index];
    highlightCodeWithPrism(fileName, fileContents);
    toggleViewButtonsBasedOnFileType(fileName);
    elements.viewCodeButton.click();
    highlightSelectedTab(index);
    resetEditCodeBox();
    elements.previewRenderCodeBox.style.display = 'none';
};

const removeTabAndFileData = index => {
    fileDataArray.splice(index, 1);
    generateAllFileTabElements();
    if (fileDataArray.length > 0) {
        displayFileContentInTab(0);
    }
};

const toggleViewButtonsBasedOnFileType = (fileName) => {
    const extension = extractFileExtension(fileName);
    if (extension === 'html') {
        elements.previewCodeButton.style.display = 'inline-block';
        elements.viewLogsButton.style.display = 'inline-block';
        elements.executeCodeButton.style.display = 'none'; // Hide execute button
    } else if (extension === 'py') {
        elements.previewCodeButton.style.display = 'none';
        elements.viewLogsButton.style.display = 'inline-block';
        elements.executeCodeButton.style.display = 'inline-block'; // Show execute button
    } else {
        elements.previewCodeButton.style.display = 'none';
        elements.viewLogsButton.style.display = 'none';
        elements.executeCodeButton.style.display = 'none'; // Hide execute button
    }
}

const highlightSelectedTab = (index) => {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.style.fontWeight = 'normal');
    tabs[index].style.fontWeight = 'bold';
}

const highlightSelectedButton = (selectedButtonId) => {
    const buttons = document.querySelectorAll('.codeBoxOptionsContainer button');
    buttons.forEach(button => {
        if (button.id === selectedButtonId) {
            button.style.fontWeight = 'bold';
        } else {
            button.style.fontWeight = 'normal';
        }
    });
}

const showOrHideCodeBox = (selectedButtonId) => {
    if (selectedButtonId === 'viewCodeButton') {
        elements.codeContainer.style.display = 'block';
    } else {
        elements.codeContainer.style.display = 'none';
    }
}

const resetEditCodeBox = () => {
    elements.editCodeButton.style.display = 'inline-block';
    elements.saveCodeEditsButton.style.display = 'none';
    elements.cancelCodeEditsButton.style.display = 'none';
    elements.executeCodeButton.style.display = 'none'; // Hide execute button
    elements.viewCodeBox.style.display = 'block';
    elements.editCodeBox.style.display = 'none';
}

const showExecuteCodeButton = (fileName) => {
    const extension = extractFileExtension(fileName);
    if (extension === 'py') {
        elements.executeCodeButton.style.display = 'inline-block'; // Show execute button
    } else {
        elements.executeCodeButton.style.display = 'none'; // Hide execute button
    }
};

// Event listeners
elements.addTab.addEventListener('click', handleAddClick);
elements.viewCodeButton.addEventListener('click', () => {
    highlightSelectedButton('viewCodeButton');
    showOrHideCodeBox('viewCodeButton');
    elements.previewRenderCodeBox.style.display = 'none'; 
    elements.editCodeButton.style.display = 'inline-block'; // Add this line
});
elements.viewLogsButton.addEventListener('click', () => {
    highlightSelectedButton('viewLogsButton');
    showOrHideCodeBox('viewLogsButton');
    elements.previewRenderCodeBox.style.display = 'none'; 
    elements.editCodeButton.style.display = 'inline-block';
    elements.saveCodeEditsButton.style.display = 'none';
    elements.cancelCodeEditsButton.style.display = 'none';
    elements.editCodeBox.style.display = 'none'; // Add this line
});

elements.previewCodeButton.addEventListener('click', () => {
    highlightSelectedButton('previewCodeButton');
    showOrHideCodeBox('previewCodeButton');
    elements.editCodeButton.style.display = 'inline-block';
    elements.saveCodeEditsButton.style.display = 'none';
    elements.cancelCodeEditsButton.style.display = 'none';
    elements.editCodeBox.style.display = 'none'; // Add this line
    handlePreviewClick();
});

elements.editCodeButton.addEventListener('click', () => {
    elements.editCodeButton.style.display = 'none';
    elements.saveCodeEditsButton.style.display = 'inline-block';
    elements.cancelCodeEditsButton.style.display = 'inline-block';
    elements.viewCodeBox.style.display = 'none';
    elements.editCodeBox.style.display = 'block';
    elements.editCodeTextArea.value = fileDataArray[currentSelectedTab].fileContents;
});
elements.saveCodeEditsButton.addEventListener('click', () => {
    fileDataArray[currentSelectedTab].fileContents = elements.editCodeTextArea.value;
    resetEditCodeBox();
    displayFileContentInTab(currentSelectedTab);
});
elements.cancelCodeEditsButton.addEventListener('click', resetEditCodeBox);
elements.previewCodeButton.addEventListener('click', handlePreviewClick);

elements.saveSelectedFileButton.addEventListener('click', () => {
    const currentFile = fileDataArray[currentSelectedTab];
    console.log(uId,'uId')
    console.log(projectId,'projectId')
    console.log(currentFile,'currentFile')
    axios.post('https://3xe2jl5kc5ypwyvu4om4nrsoxa0ykhxh.lambda-url.us-west-2.on.aws/', {
        'requestType': 'COMMIT_FILE',
        'fileContents': currentFile.fileContents,
        'fileName': currentFile.fileName,
        'uId': uId,
        'projectId': projectId
    })
    .then(function (response) {
        console.log(response);
    })
    .catch(function (error) {
        console.log(error);
    });
});

elements.submitUserRequestButton.addEventListener('click', () => {
    const currentFile = fileDataArray[currentSelectedTab];
    const userRequest = elements.userRequestInputBox.value;
    
    axios.post('https://mse2nh3pjqhy5qwkenzfeds7dq0ulcfy.lambda-url.us-west-2.on.aws/', {
        fileName: currentFile.fileName,
        request: userRequest,
        code: currentFile.fileContents,
        uId: uId
    })
    .then(function (response) {
        alert(response);
        const newCode = response.data.newCode;
        const fileName = response.data.fileName;
        
        const fileToUpdate = fileDataArray.find(file => file.fileName === fileName);
        if (fileToUpdate) {
            fileToUpdate.fileContents = newCode;
            const updatedFileIndex = fileDataArray.indexOf(fileToUpdate);
            displayFileContentInTab(updatedFileIndex);
            elements.viewCodeButton.click();
        }
    })
    .catch(function (error) {
               console.log(error);
    });

    elements.userRequestInputBox.value = '';
});

elements.executeCodeButton.addEventListener('click', () => {
    // Add your code execution logic here
});

window.onload = function() {
    extractuIdFromUrl();
    extractprojectIdFromUrl();

    axios.post('https://3xe2jl5kc5ypwyvu4om4nrsoxa0ykhxh.lambda-url.us-west-2.on.aws/', {
        'uId': uId,
        'projectId': projectId,
        'requestType': 'fetchAllProjectFiles'
    })
    .then(function (response) {
        if(response.status === 200) {
            const projectFilesArray = response.data;
            const select = document.getElementById('fileSelect');
            projectFilesArray.forEach((filePath, index) => {
                const option = document.createElement('option');
                option.value = filePath;
                option.text = filePath;
                select.appendChild(option);
            });
        }
    })
    .catch(function (error) {
        console.log(error);
    });
};

function fetchFileContents(fileName) {
    axios.post('https://3xe2jl5kc5ypwyvu4om4nrsoxa0ykhxh.lambda-url.us-west-2.on.aws/', {
        'uId': uId,
        'projectId': projectId,
        'requestType': 'fetchFileContents',
        'filePath': fileName
    })
    .then(function (response) {
        if(response.status === 200) {
            const fileData = {
                'fileName': response.data.fileName,
                'fileContents': response.data.fileContents
            };
            fileDataArray.push(fileData);
            generateAllFileTabElements();
            displayFileContentInTab(fileDataArray.length - 1);
            showExecuteCodeButton(fileName);
        }
    })
    .catch(function (error) {
        console.log(error);
    });
}
function extractuIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const uId = urlParams.get('uId');
    return uId;
}
function extractprojectIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectId');
    return projectId;
}
let uId = extractuIdFromUrl();

// Initialize
generateAllFileTabElements();
displayFileContentInTab(0);
</script>
</body>
</html>
