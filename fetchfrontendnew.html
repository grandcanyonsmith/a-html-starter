<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub File and Lambda Function Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind CSS Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-background': '#1a202c',
                    }
                }
            }
        };
    </script>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/base16-light.min.css">

    <!-- Dark Mode Toggle Styles -->
    <style>
        /* Custom CSS for dark mode transition */
        .transition-colors {
            transition: background-color 0.3s, color 0.3s;
        }
        /* CodeMirror Height Fix */
        .CodeMirror {
            height: 600px;
        }
        /* Loading Spinner Styles */
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 transition-colors" x-data="{ darkMode: false, mobileMenuOpen: false }" :class="{ 'bg-gray-900 text-white': darkMode, 'bg-gray-100 text-gray-900': !darkMode }">

    <!-- Navbar -->
    <nav class="bg-gray-900 text-white fixed w-full top-0 z-50 transition-colors" :class="{ 'bg-gray-800': darkMode }" aria-label="Main Navigation">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <a href="#" class="text-xl font-bold">App Name</a>
            <div class="flex items-center space-x-4">
                <!-- Hamburger Menu Button -->
                <button class="sm:hidden focus:outline-none focus:ring-2 focus:ring-blue-500" @click="mobileMenuOpen = !mobileMenuOpen" aria-label="Toggle Menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path x-show="!mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        <path x-show="mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <!-- Navigation Links -->
                <div class="hidden sm:flex items-center space-x-4">
                    <a href="https://html-starter-coral.vercel.app/fullstack-generator.html" class="hover:bg-gray-800 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">Create Full Stack</a>
                    <a href="https://html-starter-coral.vercel.app/show-lambda-funcs.html" class="hover:bg-gray-800 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">Lambda Functions</a>
                    <a href="https://html-starter-coral.vercel.app/lookup-lambda-functions-in-webpage-url.html" class="hover:bg-gray-800 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">Lookup Lambdas</a>
                    <a href="https://html-starter-coral.vercel.app/fetch-frontend-code.html" class="bg-gray-800 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">Lookup Frontend</a>
                </div>
                <!-- Dark Mode Toggle -->
                <button id="darkModeToggle" class="ml-4 flex items-center px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Dark Mode">
                    <svg id="darkModeIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <!-- Icon will change based on mode -->
                    </svg>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div x-show="mobileMenuOpen" class="sm:hidden bg-gray-800">
            <a href="https://html-starter-coral.vercel.app/fullstack-generator.html" class="block px-4 py-2 hover:bg-gray-700">Create Full Stack</a>
            <a href="https://html-starter-coral.vercel.app/show-lambda-funcs.html" class="block px-4 py-2 hover:bg-gray-700">Lambda Functions</a>
            <a href="https://html-starter-coral.vercel.app/lookup-lambda-functions-in-webpage-url.html" class="block px-4 py-2 hover:bg-gray-700">Lookup Lambdas</a>
            <a href="https://html-starter-coral.vercel.app/fetch-frontend-code.html" class="block px-4 py-2 hover:bg-gray-700">Lookup Frontend</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-24">
        <h1 class="text-3xl font-bold mb-8 text-center">GitHub File and Lambda Function Viewer</h1>

        <!-- URL Input Form -->
        <form id="fetchForm" class="mb-12 max-w-2xl mx-auto" aria-label="Fetch GitHub File">
            <label for="url" class="block mb-2 font-medium">Enter GitHub File URL:</label>
            <div class="flex flex-col sm:flex-row">
                <input type="url" id="url" name="url" placeholder="https://github.com/user/repo/blob/main/file.html" required class="flex-1 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 sm:mb-0 sm:rounded-r-none" aria-label="GitHub File URL">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md sm:rounded-l-none focus:outline-none focus:ring-2 focus:ring-blue-500">Fetch Content</button>
            </div>
        </form>

        <!-- Results Section -->
        <div id="result" class="hidden">
            <!-- Frontend Content -->
            <div class="mb-12">
                <h2 class="text-2xl font-semibold mb-6">Frontend</h2>
                <!-- Tab Buttons -->
                <div class="flex border-b mb-4">
                    <button id="toggleRendered" class="px-4 py-2 text-gray-600 border-b-2 border-blue-600 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">Rendered Content</button>
                    <button id="toggleCode" class="px-4 py-2 text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Code</button>
                </div>
                <!-- Rendered Content -->
                <div id="renderedContent">
                    <iframe id="contentFrame" class="w-full h-96 border rounded-md" aria-label="Rendered Content"></iframe>
                </div>
                <!-- Code Content -->
                <div id="codeContent" class="hidden">
                    <textarea id="codeBox"></textarea>
                </div>

                <!-- User Request and Actions -->
                <div class="mt-8">
                    <label for="frontendUserRequest" class="block mb-2 font-medium">User Request:</label>
                    <textarea id="frontendUserRequest" rows="3" placeholder="Describe the changes you'd like to make..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Frontend User Request"></textarea>
                    <div class="flex flex-col sm:flex-row sm:space-x-2 mt-4">
                        <button id="updateFrontendButton" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md mb-2 sm:mb-0 focus:outline-none focus:ring-2 focus:ring-green-500">Update</button>
                        <button id="rewriteFrontendButton" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">Rewrite HTML</button>
                    </div>
                </div>

                <!-- Version History -->
                <div id="versionHistory" class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">Version History</h3>
                    <ul id="versionList" class="list-disc list-inside space-y-2">
                        <!-- Versions will be dynamically added here -->
                    </ul>
                </div>

                <!-- Improvement Suggestions -->
                <div id="suggestions" class="mt-8 hidden">
                    <!-- Suggestions will be dynamically added here -->
                </div>
            </div>

            <!-- Backend Content -->
            <div>
                <h2 class="text-2xl font-semibold mb-6">Backend</h2>
                <div id="lambdaFunctions">
                    <!-- Lambda Functions will be dynamically added here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-20 w-20"></div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-md shadow-md hidden">
        <span id="notificationMessage">Copied to clipboard!</span>
    </div>

    <!-- External Scripts -->
    <!-- Include Alpine.js for reactivity -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.12.0/cdn.min.js" defer></script>

    <!-- CodeMirror Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <!-- CodeMirror Modes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.min.js"></script>
    <!-- CodeMirror Autocomplete -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/javascript-hint.min.js"></script>
    <!-- CodeMirror Linting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/javascript-lint.min.js"></script>
    <!-- Include JSHint for JavaScript linting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.4/jshint.min.js"></script>

    <!-- Main Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fetchForm = document.getElementById('fetchForm');
            const urlInput = document.getElementById('url');
            const resultSection = document.getElementById('result');
            const contentFrame = document.getElementById('contentFrame');
            const codeBox = document.getElementById('codeBox');
            const toggleRendered = document.getElementById('toggleRendered');
            const toggleCode = document.getElementById('toggleCode');
            const renderedContent = document.getElementById('renderedContent');
            const codeContent = document.getElementById('codeContent');
            const updateFrontendButton = document.getElementById('updateFrontendButton');
            const rewriteFrontendButton = document.getElementById('rewriteFrontendButton');
            const frontendUserRequest = document.getElementById('frontendUserRequest');
            const lambdaFunctionsDiv = document.getElementById('lambdaFunctions');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const darkModeIcon = document.getElementById('darkModeIcon');
            let darkMode = false;
            let fetchedContent = '';
            let frontendVersions = [];

            // Initialize CodeMirror Editor
            const codeEditor = CodeMirror.fromTextArea(codeBox, {
                mode: 'htmlmixed',
                theme: 'base16-light',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                lint: true,
                extraKeys: { "Ctrl-Space": "autocomplete" },
            });

            // Toggle Dark Mode
            function updateDarkModeIcon() {
                if (darkMode) {
                    darkModeIcon.innerHTML = '<path d="M10 2a8 8 0 1 0 8 8 8.009 8.009 0 0 0-8-8zm0 14a6.007 6.007 0 0 1 0-12V16z"></path>';
                } else {
                    darkModeIcon.innerHTML = '<path d="M17.657 6.343A8 8 0 1 1 6.343 17.657 8 8 0 1 0 17.657 6.343z"></path>';
                }
            }
            darkModeToggle.addEventListener('click', () => {
                darkMode = !darkMode;
                document.documentElement.classList.toggle('dark', darkMode);
                codeEditor.setOption('theme', darkMode ? 'dracula' : 'base16-light');
                updateDarkModeIcon();
                console.log('Dark mode toggled:', darkMode);
            });
            updateDarkModeIcon();

            // Event Listeners
            fetchForm.addEventListener('submit', handleFetchFormSubmit);
            toggleRendered.addEventListener('click', showRenderedContent);
            toggleCode.addEventListener('click', showCodeContent);
            updateFrontendButton.addEventListener('click', handleUpdateFrontend);
            rewriteFrontendButton.addEventListener('click', handleRewriteFrontend);

            // Handle Fetch Form Submit
            async function handleFetchFormSubmit(event) {
                event.preventDefault();
                const url = urlInput.value.trim();
                if (!url) return;

                // Reset Content
                resultSection.classList.add('hidden');
                contentFrame.srcdoc = '';
                codeEditor.setValue('');
                lambdaFunctionsDiv.innerHTML = '';
                frontendVersions = [];
                displayVersionHistory();
                console.log('Fetching content from GitHub URL:', url);

                showLoading(true);

                try {
                    // Fetch GitHub File Content
                    const fileResponse = await fetch('https://7jgnzaokec66xxo4t3v2ixeqxm0rvzov.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    const fileData = await fileResponse.json();
                    if (fileResponse.ok && fileData.content) {
                        fetchedContent = fileData.content;
                        contentFrame.srcdoc = fetchedContent;
                        codeEditor.setValue(fetchedContent);
                        resultSection.classList.remove('hidden');
                        showNotification('Content fetched successfully!', 'success');
                        // Save initial fetched content as version 1
                        frontendVersions = []; // Reset version history
                        saveCurrentVersion();
                        displayVersionHistory();
                    } else {
                        throw new Error(fileData.message || 'Failed to fetch file content');
                    }

                    // Fetch Related Lambda Functions
                    await fetchRelatedLambdaFunctions(url);
                } catch (error) {
                    console.error(error);
                    showNotification('Error: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Show or Hide Loading Spinner
            function showLoading(show) {
                if (show) {
                    loadingSpinner.classList.remove('hidden');
                } else {
                    loadingSpinner.classList.add('hidden');
                }
            }

            // Fetch Related Lambda Functions
            async function fetchRelatedLambdaFunctions(url) {
                console.log('Fetching related Lambda functions for URL:', url);
                try {
                    const lambdaResponse = await fetch('https://7t6svygyp2c5nnxcvq5ofpn7xa0xhcks.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    const lambdaData = await lambdaResponse.json();
                    if (lambdaResponse.ok && lambdaData.lambda_functions && Object.keys(lambdaData.lambda_functions).length > 0) {
                        displayLambdaFunctions(lambdaData.lambda_functions);
                    } else {
                        lambdaFunctionsDiv.innerHTML = '<p class="text-gray-600">No Lambda functions found.</p>';
                    }
                } catch (error) {
                    console.error(error);
                    showNotification('Error fetching Lambda functions: ' + error.message, 'error');
                }
            }

            // Display Lambda Functions
            function displayLambdaFunctions(lambdaFunctions) {
                lambdaFunctionsDiv.innerHTML = '';
                Object.entries(lambdaFunctions).forEach(([lambdaUrl, functionName]) => {
                    const functionItem = document.createElement('div');
                    functionItem.classList.add('border', 'border-gray-300', 'rounded-md', 'mb-6', 'p-4', 'bg-white', 'dark:bg-gray-800');
                    functionItem.innerHTML = `
                        <div class="flex justify-between items-center cursor-pointer">
                            <div>
                                <h3 class="text-lg font-semibold">${functionName}</h3>
                                <p class="text-sm text-gray-500">${lambdaUrl}</p>
                            </div>
                            <button class="toggle-details focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Details">
                                <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="details mt-4 hidden">
                            <p class="text-gray-600">Loading function details...</p>
                        </div>
                    `;
                    lambdaFunctionsDiv.appendChild(functionItem);

                    const toggleButton = functionItem.querySelector('.toggle-details');
                    const detailsDiv = functionItem.querySelector('.details');
                    toggleButton.addEventListener('click', () => {
                        if (detailsDiv.classList.contains('hidden')) {
                            detailsDiv.classList.remove('hidden');
                            toggleButton.querySelector('svg').classList.add('rotate-180');
                            if (!detailsDiv.dataset.loaded) {
                                loadFunctionDetails(functionName, detailsDiv);
                            }
                            console.log('Showing details for function:', functionName);
                        } else {
                            detailsDiv.classList.add('hidden');
                            toggleButton.querySelector('svg').classList.remove('rotate-180');
                            console.log('Hiding details for function:', functionName);
                        }
                    });
                });
            }

            // Load Function Details
            async function loadFunctionDetails(functionName, detailsDiv) {
                console.log('Loading details for function:', functionName);
                detailsDiv.innerHTML = `<p class="text-gray-600">Loading function details...</p>`;
                try {
                    const functionResponse = await fetch('https://qklalf7lnzfjghjwubqq232bj40llolc.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName })
                    });
                    const functionData = await functionResponse.json();
                    if (functionResponse.ok) {
                        detailsDiv.innerHTML = `
                            <h4 class="text-md font-semibold mb-2">Function Code:</h4>
                            <textarea class="function-code w-full h-64 border border-gray-300 rounded-md p-3"></textarea>
                            <label for="userRequest-${functionName}" class="block mt-4 mb-2 font-medium">User Request:</label>
                            <textarea id="userRequest-${functionName}" rows="2" placeholder="Describe changes to the function..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="flex flex-col sm:flex-row sm:space-x-2 mt-4">
                                <button class="update-function-button bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md mb-2 sm:mb-0 focus:outline-none focus:ring-2 focus:ring-green-500" data-function-name="${functionName}">Update Function</button>
                                <button class="rewrite-function-button bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" data-function-name="${functionName}">Rewrite Function</button>
                            </div>
                        `;
                        const functionCodeArea = detailsDiv.querySelector('.function-code');
                        functionCodeArea.value = functionData.code || 'No code available';

                        // Initialize CodeMirror for function code
                        const functionCodeEditor = CodeMirror.fromTextArea(functionCodeArea, {
                            mode: 'javascript',
                            theme: darkMode ? 'dracula' : 'base16-light',
                            lineNumbers: true,
                            autoCloseBrackets: true,
                            matchBrackets: true,
                            lint: true,
                            extraKeys: { "Ctrl-Space": "autocomplete" },
                        });

                        // Add Event Listeners for Update and Rewrite Buttons
                        const updateButton = detailsDiv.querySelector('.update-function-button');
                        const rewriteButton = detailsDiv.querySelector('.rewrite-function-button');
                        updateButton.addEventListener('click', (e) => handleUpdateFunction(e, functionCodeEditor, updateButton));
                        rewriteButton.addEventListener('click', (e) => handleRewriteFunction(e, functionCodeEditor, rewriteButton));

                        detailsDiv.dataset.loaded = true;
                    } else {
                        throw new Error(functionData.message || 'Failed to fetch function details');
                    }
                } catch (error) {
                    console.error(error);
                    detailsDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            }

            // Handle Update Function
            async function handleUpdateFunction(event, functionCodeEditor, button) {
                const functionName = event.target.getAttribute('data-function-name');
                const detailsDiv = event.target.closest('.details');
                const code = functionCodeEditor.getValue();
                console.log(`Updating function ${functionName} with new code.`);
                const originalText = button.textContent;
                button.textContent = 'Updating...';
                button.disabled = true;

                try {
                    // Call API to update function code
                    const response = await fetch('https://qklalf7lnzfjghjwubqq232bj40llolc.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName, updatedCode: code })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showNotification('Function updated successfully!', 'success');
                        console.log('Function updated successfully.');
                    } else {
                        throw new Error(data.message || 'Failed to update function');
                    }
                } catch (error) {
                    console.error(error);
                    showNotification('Error updating function: ' + error.message, 'error');
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }

            // Handle Rewrite Function
            async function handleRewriteFunction(event, functionCodeEditor, button) {
                const functionName = event.target.getAttribute('data-function-name');
                const detailsDiv = event.target.closest('.details');
                const code = functionCodeEditor.getValue();
                const userRequest = detailsDiv.querySelector(`#userRequest-${functionName}`).value.trim();
                if (!userRequest) {
                    showNotification('Please enter a user request.', 'warning');
                    return;
                }
                console.log(`Rewriting function ${functionName} based on user request: ${userRequest}`);
                const originalText = button.textContent;
                button.textContent = 'Rewriting...';
                button.disabled = true;

                try {
                    // Call API to rewrite function code
                    const response = await fetch('https://xmakkpe5oox6hvkaei4tomxsty0bqsqn.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userRequest, existingCode: code })
                    });
                    const data = await response.json();
                    if (response.ok && data.updatedCode) {
                        functionCodeEditor.setValue(data.updatedCode);
                        showNotification('Function rewritten successfully!', 'success');
                        console.log('Function rewritten successfully.');
                    } else {
                        throw new Error(data.message || 'Failed to rewrite function');
                    }
                } catch (error) {
                    console.error(error);
                    showNotification('Error rewriting function: ' + error.message, 'error');
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }

            // Show Rendered Content
            function showRenderedContent() {
                toggleRendered.classList.add('border-blue-600', 'font-medium');
                toggleCode.classList.remove('border-blue-600', 'font-medium');
                renderedContent.classList.remove('hidden');
                codeContent.classList.add('hidden');
                console.log('Showing rendered content.');
            }

            // Show Code Content
            function showCodeContent() {
                toggleCode.classList.add('border-blue-600', 'font-medium');
                toggleRendered.classList.remove('border-blue-600', 'font-medium');
                codeContent.classList.remove('hidden');
                renderedContent.classList.add('hidden');
                codeEditor.refresh();
                console.log('Showing code content.');
            }

            // Save Current Version
            function saveCurrentVersion() {
                const currentCode = codeEditor.getValue();
                const timestamp = new Date();
                // Save code and timestamp
                frontendVersions.push({
                    code: currentCode,
                    timestamp: timestamp.toLocaleString()
                });
                console.log('Version saved at', timestamp.toLocaleString());
            }

            // Display Version History
            function displayVersionHistory() {
                const versionList = document.getElementById('versionList');
                versionList.innerHTML = '';
                frontendVersions.forEach((version, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('flex', 'justify-between', 'items-center');
                    listItem.innerHTML = `
                        <span>Version ${index + 1} - ${version.timestamp}</span>
                        <button class="restore-button bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-index="${index}">Restore</button>
                    `;
                    versionList.appendChild(listItem);
                });

                // Add event listeners to restore buttons
                const restoreButtons = versionList.querySelectorAll('.restore-button');
                restoreButtons.forEach(button => {
                    button.addEventListener('click', handleRestoreVersion);
                });
            }

            // Handle Restore Version
            function handleRestoreVersion(event) {
                const index = event.target.getAttribute('data-index');
                const version = frontendVersions[index];
                if (version) {
                    codeEditor.setValue(version.code);
                    contentFrame.srcdoc = version.code;
                    showNotification(`Restored version ${parseInt(index) + 1}`, 'success');
                    console.log(`Restored version ${parseInt(index) + 1}`);
                } else {
                    showNotification('Failed to restore version.', 'error');
                    console.error('Failed to restore version. Invalid index:', index);
                }
            }

            // Handle Update Frontend
            async function handleUpdateFrontend() {
                const updatedCode = codeEditor.getValue();
                const githubUrl = urlInput.value.trim();
                if (!updatedCode || !githubUrl) return;

                // Save current code to version history before updating
                saveCurrentVersion();

                const originalText = updateFrontendButton.textContent;
                updateFrontendButton.textContent = 'Updating...';
                updateFrontendButton.disabled = true;
                console.log('Updating frontend code for URL:', githubUrl);

                try {
                    const response = await fetch('https://e4dtiiwk2mn5k6z6s4vwpmluvi0kavve.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: githubUrl, updatedCode })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showNotification('Frontend updated successfully!', 'success');
                        console.log('Frontend updated successfully.');
                        // Update the rendered content
                        contentFrame.srcdoc = updatedCode;
                        // Update version history UI
                        displayVersionHistory();
                    } else {
                        throw new Error(data.message || 'Failed to update frontend');
                    }
                } catch (error) {
                    console.error(error);
                    showNotification('Error: ' + error.message, 'error');
                } finally {
                    updateFrontendButton.textContent = originalText;
                    updateFrontendButton.disabled = false;
                }
            }

            // Handle Rewrite Frontend
            async function handleRewriteFrontend() {
                const userRequest = frontendUserRequest.value.trim();
                const existingCode = codeEditor.getValue();
                if (!userRequest || !existingCode) return;

                // Save current code to version history before rewriting
                saveCurrentVersion();

                const originalText = rewriteFrontendButton.textContent;
                rewriteFrontendButton.textContent = 'Rewriting...';
                rewriteFrontendButton.disabled = true;
                console.log('Rewriting frontend based on user request:', userRequest);

                try {
                    const response = await fetch('https://pphvmloxbpolihsjuelbfoieqm0zzvgq.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userRequest, existingCode })
                    });
                    const data = await response.json();
                    if (response.ok && data.html_code) {
                        codeEditor.setValue(data.html_code);
                        contentFrame.srcdoc = data.html_code;
                        // Display Improvement Suggestions
                        displaySuggestions(data.suggestions);
                        // Update version history UI
                        displayVersionHistory();
                        showNotification('Frontend rewritten successfully!', 'success');
                        console.log('Frontend rewritten successfully.');
                    } else {
                        throw new Error(data.message || 'Failed to rewrite frontend');
                    }
                } catch (error) {
                    console.error(error);
                    showNotification('Error: ' + error.message, 'error');
                } finally {
                    rewriteFrontendButton.textContent = originalText;
                    rewriteFrontendButton.disabled = false;
                }
            }

            // Display Improvement Suggestions
            function displaySuggestions(suggestions) {
                if (!suggestions || !Array.isArray(suggestions)) return;
                console.log('Displaying improvement suggestions.');
                let suggestionsContainer = document.getElementById('suggestions');
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.classList.remove('hidden');
                const suggestionsTitle = document.createElement('h3');
                suggestionsTitle.classList.add('text-xl', 'font-semibold', 'mb-4');
                suggestionsTitle.textContent = 'Improvement Suggestions';
                const suggestionsList = document.createElement('ul');
                suggestionsList.classList.add('list-disc', 'list-inside', 'space-y-2');
                suggestions.forEach(suggestion => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<strong>${suggestion.title}</strong>: ${suggestion.details}`;
                    suggestionsList.appendChild(listItem);
                });
                suggestionsContainer.appendChild(suggestionsTitle);
                suggestionsContainer.appendChild(suggestionsList);
            }

            // Show Notification
            function showNotification(message, type = 'info') {
                notificationMessage.textContent = message;
                notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-md shadow-md';
                if (type === 'success') {
                    notification.classList.add('bg-green-500', 'text-white');
                } else if (type === 'error') {
                    notification.classList.add('bg-red-500', 'text-white');
                } else if (type === 'warning') {
                    notification.classList.add('bg-yellow-500', 'text-white');
                } else {
                    notification.classList.add('bg-blue-500', 'text-white');
                }
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 4000);
                console.log('Notification:', message);
            }
        });
    </script>
</body>
</html>