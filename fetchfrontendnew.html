<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub File and Lambda Function Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror Theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">

    <!-- Custom Styles -->
    <style>
        /* CodeMirror Height Fix */
        .CodeMirror {
            height: 600px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-gray-900 text-white fixed w-full top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="https://html-starter-coral.vercel.app/fullstack-generator.html" class="hover:bg-gray-800 px-3 py-2 rounded">Create Full Stack</a>
                <a href="https://html-starter-coral.vercel.app/show-lambda-funcs.html" class="hover:bg-gray-800 px-3 py-2 rounded">Lambda Functions</a>
                <a href="https://html-starter-coral.vercel.app/lookup-lambda-functions-in-webpage-url.html" class="hover:bg-gray-800 px-3 py-2 rounded">Lookup Lambdas</a>
                <a href="https://html-starter-coral.vercel.app/fetch-frontend-code.html" class="bg-gray-800 px-3 py-2 rounded">Lookup Frontend</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-16">
        <h1 class="text-3xl font-bold mb-8 text-center">GitHub File and Lambda Function Viewer</h1>

        <!-- URL Input Form -->
        <form id="fetchForm" class="mb-12 max-w-2xl mx-auto">
            <label for="url" class="block mb-2 font-medium">Enter GitHub File URL:</label>
            <div class="flex">
                <input type="url" id="url" name="url" placeholder="https://github.com/user/repo/blob/main/file.html" required class="flex-1 p-3 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-r-md">Fetch Content</button>
            </div>
        </form>

        <!-- Results Section -->
        <div id="result" class="hidden">
            <!-- Frontend Content -->
            <div class="mb-12">
                <h2 class="text-2xl font-semibold mb-6">Frontend</h2>
                <!-- Tab Buttons -->
                <div class="flex border-b mb-4">
                    <button id="toggleRendered" class="px-4 py-2 text-gray-600 border-b-2 border-blue-600 font-medium">Rendered Content</button>
                    <button id="toggleCode" class="px-4 py-2 text-gray-600">Code</button>
                </div>
                <!-- Rendered Content -->
                <div id="renderedContent">
                    <iframe id="contentFrame" class="w-full h-96 border rounded-md"></iframe>
                </div>
                <!-- Code Content -->
                <div id="codeContent" class="hidden">
                    <textarea id="codeBox"></textarea>
                </div>

                <!-- User Request and Actions -->
                <div class="mt-8">
                    <label for="frontendUserRequest" class="block mb-2 font-medium">User Request:</label>
                    <textarea id="frontendUserRequest" rows="3" placeholder="Describe the changes you'd like to make..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <div class="flex space-x-2 mt-4">
                        <button id="updateFrontendButton" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md">Update</button>
                        <button id="rewriteFrontendButton" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-md">Rewrite HTML</button>
                    </div>
                </div>
            </div>

            <!-- Backend Content -->
            <div>
                <h2 class="text-2xl font-semibold mb-6">Backend</h2>
                <div id="lambdaFunctions">
                    <!-- Lambda Functions will be dynamically added here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-md shadow-md hidden">
        Copied to clipboard!
    </div>

    <!-- External Scripts -->
    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <!-- CodeMirror Modes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.min.js"></script>

    <!-- Main Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fetchForm = document.getElementById('fetchForm');
            const urlInput = document.getElementById('url');
            const resultSection = document.getElementById('result');
            const contentFrame = document.getElementById('contentFrame');
            const codeBox = document.getElementById('codeBox');
            const toggleRendered = document.getElementById('toggleRendered');
            const toggleCode = document.getElementById('toggleCode');
            const renderedContent = document.getElementById('renderedContent');
            const codeContent = document.getElementById('codeContent');
            const updateFrontendButton = document.getElementById('updateFrontendButton');
            const rewriteFrontendButton = document.getElementById('rewriteFrontendButton');
            const frontendUserRequest = document.getElementById('frontendUserRequest');
            const lambdaFunctionsDiv = document.getElementById('lambdaFunctions');
            const notification = document.getElementById('notification');
            let fetchedContent = '';

            // Initialize CodeMirror Editor
            const codeEditor = CodeMirror.fromTextArea(codeBox, {
                mode: 'htmlmixed',
                theme: 'dracula',
                lineNumbers: true,
                autoCloseBrackets: true,
            });

            // Event Listeners
            fetchForm.addEventListener('submit', handleFetchFormSubmit);
            toggleRendered.addEventListener('click', showRenderedContent);
            toggleCode.addEventListener('click', showCodeContent);
            updateFrontendButton.addEventListener('click', handleUpdateFrontend);
            rewriteFrontendButton.addEventListener('click', handleRewriteFrontend);

            // Handle Fetch Form Submit
            async function handleFetchFormSubmit(event) {
                event.preventDefault();
                const url = urlInput.value.trim();
                if (!url) return;

                // Reset Content
                resultSection.classList.add('hidden');
                contentFrame.srcdoc = '';
                codeEditor.setValue('');
                lambdaFunctionsDiv.innerHTML = '';
                console.log('Fetching content from GitHub URL:', url);

                try {
                    // Fetch GitHub File Content
                    const fileResponse = await fetch('https://your-api-endpoint.com/fetch-file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    const fileData = await fileResponse.json();
                    if (fileResponse.ok && fileData.content) {
                        fetchedContent = fileData.content;
                        contentFrame.srcdoc = fetchedContent;
                        codeEditor.setValue(fetchedContent);
                        resultSection.classList.remove('hidden');
                    } else {
                        throw new Error(fileData.message || 'Failed to fetch file content');
                    }

                    // Fetch Related Lambda Functions
                    await fetchRelatedLambdaFunctions(url);
                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                }
            }

            // Fetch Related Lambda Functions
            async function fetchRelatedLambdaFunctions(url) {
                console.log('Fetching related Lambda functions for URL:', url);
                try {
                    const lambdaResponse = await fetch('https://your-api-endpoint.com/fetch-lambda-functions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    const lambdaData = await lambdaResponse.json();
                    if (lambdaResponse.ok && lambdaData.lambda_functions && Object.keys(lambdaData.lambda_functions).length > 0) {
                        displayLambdaFunctions(lambdaData.lambda_functions);
                    } else {
                        lambdaFunctionsDiv.innerHTML = '<p class="text-gray-600">No Lambda functions found.</p>';
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error fetching Lambda functions: ' + error.message);
                }
            }

            // Display Lambda Functions
            function displayLambdaFunctions(lambdaFunctions) {
                lambdaFunctionsDiv.innerHTML = '';
                Object.entries(lambdaFunctions).forEach(([lambdaUrl, functionName]) => {
                    const functionItem = document.createElement('div');
                    functionItem.classList.add('border', 'border-gray-300', 'rounded-md', 'mb-6', 'p-4', 'bg-white');
                    functionItem.innerHTML = `
                        <div class="flex justify-between items-center cursor-pointer">
                            <div>
                                <h3 class="text-lg font-semibold">${functionName}</h3>
                                <p class="text-sm text-gray-500">${lambdaUrl}</p>
                            </div>
                            <button class="toggle-details focus:outline-none">
                                <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="details mt-4 hidden">
                            <p class="text-gray-600">Loading function details...</p>
                        </div>
                    `;
                    lambdaFunctionsDiv.appendChild(functionItem);

                    const toggleButton = functionItem.querySelector('.toggle-details');
                    const detailsDiv = functionItem.querySelector('.details');
                    toggleButton.addEventListener('click', () => {
                        if (detailsDiv.classList.contains('hidden')) {
                            detailsDiv.classList.remove('hidden');
                            toggleButton.querySelector('svg').classList.add('rotate-180');
                            if (!detailsDiv.dataset.loaded) {
                                loadFunctionDetails(functionName, detailsDiv);
                            }
                        } else {
                            detailsDiv.classList.add('hidden');
                            toggleButton.querySelector('svg').classList.remove('rotate-180');
                        }
                    });
                });
            }

            // Load Function Details
            async function loadFunctionDetails(functionName, detailsDiv) {
                console.log('Loading details for function:', functionName);
                try {
                    const functionResponse = await fetch('https://your-api-endpoint.com/get-function-details', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName })
                    });
                    const functionData = await functionResponse.json();
                    if (functionResponse.ok) {
                        detailsDiv.innerHTML = `
                            <h4 class="text-md font-semibold mb-2">Function Code:</h4>
                            <textarea class="function-code w-full h-64 border border-gray-300 rounded-md p-3"></textarea>
                            <label for="userRequest-${functionName}" class="block mt-4 mb-2 font-medium">User Request:</label>
                            <textarea id="userRequest-${functionName}" rows="2" placeholder="Describe changes to the function..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="flex space-x-2 mt-4">
                                <button class="update-function-button bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md" data-function-name="${functionName}">Update Function</button>
                                <button class="rewrite-function-button bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md" data-function-name="${functionName}">Rewrite Function</button>
                            </div>
                        `;
                        const functionCodeArea = detailsDiv.querySelector('.function-code');
                        functionCodeArea.value = functionData.code || 'No code available';

                        // Initialize CodeMirror for function code
                        CodeMirror.fromTextArea(functionCodeArea, {
                            mode: 'javascript',
                            theme: 'dracula',
                            lineNumbers: true,
                            autoCloseBrackets: true,
                        });

                        // Add Event Listeners for Update and Rewrite Buttons
                        const updateButton = detailsDiv.querySelector('.update-function-button');
                        const rewriteButton = detailsDiv.querySelector('.rewrite-function-button');
                        updateButton.addEventListener('click', handleUpdateFunction);
                        rewriteButton.addEventListener('click', handleRewriteFunction);
                        detailsDiv.dataset.loaded = true;
                    } else {
                        throw new Error(functionData.message || 'Failed to fetch function details');
                    }
                } catch (error) {
                    console.error(error);
                    detailsDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            }

            // Handle Update Function
            async function handleUpdateFunction(event) {
                const functionName = event.target.getAttribute('data-function-name');
                const detailsDiv = event.target.closest('.details');
                const codeMirrorInstance = detailsDiv.querySelector('.CodeMirror').CodeMirror;
                const code = codeMirrorInstance.getValue();
                console.log(`Updating function ${functionName} with new code.`);
                event.target.textContent = 'Updating...';
                event.target.disabled = true;

                try {
                    // Call API to update function code
                    const response = await fetch('https://your-api-endpoint.com/update-lambda-function', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName, updatedCode: code })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Function updated successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to update function');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error updating function: ' + error.message);
                } finally {
                    event.target.textContent = 'Update Function';
                    event.target.disabled = false;
                }
            }

            // Handle Rewrite Function
            async function handleRewriteFunction(event) {
                const functionName = event.target.getAttribute('data-function-name');
                const detailsDiv = event.target.closest('.details');
                const codeMirrorInstance = detailsDiv.querySelector('.CodeMirror').CodeMirror;
                const code = codeMirrorInstance.getValue();
                const userRequest = detailsDiv.querySelector(`#userRequest-${functionName}`).value.trim();
                if (!userRequest) {
                    alert('Please enter a user request.');
                    return;
                }
                console.log(`Rewriting function ${functionName} based on user request: ${userRequest}`);
                event.target.textContent = 'Rewriting...';
                event.target.disabled = true;

                try {
                    // Call API to rewrite function code
                    const response = await fetch('https://your-api-endpoint.com/rewrite-lambda-function', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName, existingCode: code, userRequest })
                    });
                    const data = await response.json();
                    if (response.ok && data.updatedCode) {
                        codeMirrorInstance.setValue(data.updatedCode);
                        alert('Function rewritten successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to rewrite function');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error rewriting function: ' + error.message);
                } finally {
                    event.target.textContent = 'Rewrite Function';
                    event.target.disabled = false;
                }
            }

            // Show Rendered Content
            function showRenderedContent() {
                toggleRendered.classList.add('border-blue-600', 'font-medium');
                toggleCode.classList.remove('border-blue-600', 'font-medium');
                renderedContent.classList.remove('hidden');
                codeContent.classList.add('hidden');
                console.log('Showing rendered content.');
            }

            // Show Code Content
            function showCodeContent() {
                toggleCode.classList.add('border-blue-600', 'font-medium');
                toggleRendered.classList.remove('border-blue-600', 'font-medium');
                codeContent.classList.remove('hidden');
                renderedContent.classList.add('hidden');
                codeEditor.refresh();
                console.log('Showing code content.');
            }

            // Handle Update Frontend
            async function handleUpdateFrontend() {
                const updatedCode = codeEditor.getValue();
                const githubUrl = urlInput.value.trim();
                if (!updatedCode || !githubUrl) return;

                updateFrontendButton.textContent = 'Updating...';
                updateFrontendButton.disabled = true;
                console.log('Updating frontend code for URL:', githubUrl);

                try {
                    const response = await fetch('https://your-api-endpoint.com/update-frontend-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: githubUrl, updatedCode })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Frontend updated successfully!');
                        console.log('Frontend updated successfully.');
                    } else {
                        throw new Error(data.message || 'Failed to update frontend');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                } finally {
                    updateFrontendButton.textContent = 'Update';
                    updateFrontendButton.disabled = false;
                }
            }

            // Handle Rewrite Frontend
            async function handleRewriteFrontend() {
                const userRequest = frontendUserRequest.value.trim();
                const existingCode = codeEditor.getValue();
                if (!userRequest || !existingCode) return;

                rewriteFrontendButton.textContent = 'Rewriting...';
                rewriteFrontendButton.disabled = true;
                console.log('Rewriting frontend based on user request:', userRequest);

                try {
                    const response = await fetch('https://your-api-endpoint.com/rewrite-frontend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userRequest, existingCode })
                    });
                    const data = await response.json();
                    if (response.ok && data.html_code) {
                        codeEditor.setValue(data.html_code);
                        contentFrame.srcdoc = data.html_code;

                        // Display Improvement Suggestions
                        displaySuggestions(data.suggestions);
                        console.log('Frontend rewritten successfully.');
                    } else {
                        throw new Error(data.message || 'Failed to rewrite frontend');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                } finally {
                    rewriteFrontendButton.textContent = 'Rewrite HTML';
                    rewriteFrontendButton.disabled = false;
                }
            }

            // Display Improvement Suggestions
            function displaySuggestions(suggestions) {
                if (!suggestions || !Array.isArray(suggestions)) return;
                console.log('Displaying improvement suggestions.');
                // Remove existing suggestions
                let suggestionsContainer = document.getElementById('suggestions');
                if (suggestionsContainer) {
                    suggestionsContainer.remove();
                }
                suggestionsContainer = document.createElement('div');
                suggestionsContainer.id = 'suggestions';
                suggestionsContainer.classList.add('mt-8', 'bg-white', 'p-6', 'rounded-md', 'shadow-md');
                const suggestionsTitle = document.createElement('h3');
                suggestionsTitle.classList.add('text-xl', 'font-semibold', 'mb-4');
                suggestionsTitle.textContent = 'Improvement Suggestions';
                const suggestionsList = document.createElement('ul');
                suggestionsList.classList.add('list-disc', 'list-inside', 'space-y-2');
                suggestions.forEach(suggestion => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<strong>${suggestion.title}</strong>: ${suggestion.details}`;
                    suggestionsList.appendChild(listItem);
                });
                suggestionsContainer.appendChild(suggestionsTitle);
                suggestionsContainer.appendChild(suggestionsList);
                resultSection.appendChild(suggestionsContainer);
            }

            // Show Notification
            function showNotification(message) {
                notification.textContent = message;
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 4000);
                console.log('Notification:', message);
            }
        });
    </script>
</body>
</html>