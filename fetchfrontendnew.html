<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub File and Lambda Function Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror Theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">

    <!-- Additional CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css">

    <!-- Custom Styles -->
    <style>
        /* Navbar Styles */
        .navbar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1rem;
            background-color: #1a202c; /* Tailwind Gray-900 */
            color: #fff;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        .navbar a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }
        .navbar a:hover {
            background-color: #2d3748; /* Tailwind Gray-800 */
            border-radius: 0.25rem;
        }
        .navbar a.active {
            background-color: #4a5568; /* Tailwind Gray-700 */
            border-radius: 0.25rem;
        }

        /* Main Content */
        .content {
            margin-top: 6rem; /* Adjust for fixed navbar */
            padding: 1rem;
        }

        /* Form Styles */
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input[type="url"],
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0; /* Tailwind Gray-400 */
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        input[type="url"]:focus,
        textarea:focus {
            outline: none;
            border-color: #3182ce; /* Tailwind Blue-600 */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* Tailwind Blue-500 */
        }
        button {
            padding: 0.75rem 1.5rem;
            background-color: #3182ce; /* Tailwind Blue-600 */
            color: #fff;
            border: none;
            border-radius: 0.25rem;
            font-size: 1rem;
            cursor: pointer;
        }
        button:hover {
            background-color: #2b6cb0; /* Tailwind Blue-700 */
        }
        button:disabled {
            background-color: #a0aec0; /* Tailwind Gray-500 */
            cursor: not-allowed;
        }
        /* Tab Styles */
        .tab-buttons {
            display: flex;
            margin-bottom: 1rem;
        }
        .tab-buttons button {
            flex: 1;
            padding: 0.75rem;
            background-color: #e2e8f0; /* Tailwind Gray-200 */
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }
        .tab-buttons button.active {
            background-color: #edf2f7; /* Tailwind Gray-100 */
            border-bottom: 2px solid #3182ce; /* Tailwind Blue-600 */
        }

        /* Code Editor and Output */
        .code-editor, .iframe-content {
            width: 100%;
            height: 600px;
            border: 1px solid #cbd5e0; /* Tailwind Gray-400 */
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }

        /* Function Item Styles */
        .function-item {
            border: 1px solid #cbd5e0;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #fff;
        }
        .function-item .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .function-item .details {
            display: none;
            margin-top: 1rem;
        }
        .function-item.active .details {
            display: block;
        }
        .function-item .chevron {
            transition: transform 0.3s;
        }
        .function-item.active .chevron {
            transform: rotate(180deg);
        }

        /* Notification Styles */
        #notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #48bb78; /* Tailwind Green-500 */
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 0.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1001;
            animation: fadeInOut 4s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="navbar">
        <a href="https://html-starter-coral.vercel.app/fullstack-generator.html">Create Full Stack</a>
        <a href="https://html-starter-coral.vercel.app/show-lambda-funcs.html">Lambda Functions</a>
        <a href="https://html-starter-coral.vercel.app/lookup-lambda-functions-in-webpage-url.html">Lookup Lambdas</a>
        <a href="https://html-starter-coral.vercel.app/fetch-frontend-code.html" class="active">Lookup Frontend</a>
    </nav>

    <!-- Main Content -->
    <main class="content">
        <h1 class="text-2xl font-bold mb-6">GitHub File and Lambda Function Viewer</h1>

        <!-- URL Input Form -->
        <form id="fetchForm" class="mb-8">
            <label for="url">Enter GitHub File URL:</label>
            <input type="url" id="url" name="url" placeholder="https://github.com/user/repo/blob/main/file.html" required>
            <button type="submit">Fetch Content</button>
        </form>

        <!-- Results Section -->
        <div id="result" class="hidden">
            <!-- Frontend Content -->
            <div class="mb-12">
                <h2 class="text-xl font-semibold mb-4">Frontend</h2>
                <!-- Tab Buttons -->
                <div class="tab-buttons">
                    <button id="toggleRendered" class="active">Rendered Content</button>
                    <button id="toggleCode">Code</button>
                </div>
                <!-- Rendered Content -->
                <div id="renderedContent">
                    <iframe id="contentFrame" class="iframe-content"></iframe>
                </div>
                <!-- Code Content -->
                <div id="codeContent" class="hidden">
                    <textarea id="codeBox"></textarea>
                </div>

                <!-- User Request and Actions -->
                <div class="mt-6">
                    <label for="frontendUserRequest">User Request:</label>
                    <textarea id="frontendUserRequest" rows="3" placeholder="Describe the changes you'd like to make..."></textarea>
                    <div class="flex space-x-2 mt-4">
                        <button id="updateFrontendButton">Update</button>
                        <button id="rewriteFrontendButton">Rewrite HTML</button>
                    </div>
                </div>
            </div>

            <!-- Backend Content -->
            <div>
                <h2 class="text-xl font-semibold mb-4">Backend</h2>
                <div id="lambdaFunctions">
                    <!-- Lambda Functions will be dynamically added here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification">Copied to clipboard!</div>

    <!-- External Scripts -->
    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <!-- CodeMirror Modes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.min.js"></script>

    <!-- Main Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fetchForm = document.getElementById('fetchForm');
            const urlInput = document.getElementById('url');
            const resultSection = document.getElementById('result');
            const contentFrame = document.getElementById('contentFrame');
            const codeBox = document.getElementById('codeBox');
            const toggleRendered = document.getElementById('toggleRendered');
            const toggleCode = document.getElementById('toggleCode');
            const renderedContent = document.getElementById('renderedContent');
            const codeContent = document.getElementById('codeContent');
            const updateFrontendButton = document.getElementById('updateFrontendButton');
            const rewriteFrontendButton = document.getElementById('rewriteFrontendButton');
            const frontendUserRequest = document.getElementById('frontendUserRequest');
            const lambdaFunctionsDiv = document.getElementById('lambdaFunctions');
            const notification = document.getElementById('notification');
            let fetchedContent = '';

            // Initialize CodeMirror Editor
            const codeEditor = CodeMirror.fromTextArea(codeBox, {
                mode: 'htmlmixed',
                theme: 'dracula',
                lineNumbers: true,
                autoCloseBrackets: true,
            });

            // Event Listeners
            fetchForm.addEventListener('submit', handleFetchFormSubmit);
            toggleRendered.addEventListener('click', showRenderedContent);
            toggleCode.addEventListener('click', showCodeContent);
            updateFrontendButton.addEventListener('click', handleUpdateFrontend);
            rewriteFrontendButton.addEventListener('click', handleRewriteFrontend);

            // Handle Fetch Form Submit
            async function handleFetchFormSubmit(event) {
                event.preventDefault();
                const url = urlInput.value.trim();
                if (!url) return;

                // Reset Content
                resultSection.classList.add('hidden');
                contentFrame.srcdoc = '';
                codeEditor.setValue('');
                lambdaFunctionsDiv.innerHTML = '';

                try {
                    // Fetch GitHub File Content
                    const fileResponse = await fetch('https://7jgnzaokec66xxo4t3v2ixeqxm0rvzov.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    const fileData = await fileResponse.json();
                    if (fileResponse.ok && fileData.content) {
                        fetchedContent = fileData.content;
                        contentFrame.srcdoc = fetchedContent;
                        codeEditor.setValue(fetchedContent);
                        resultSection.classList.remove('hidden');
                    } else {
                        throw new Error(fileData.message || 'Failed to fetch file content');
                    }

                    // Fetch Related Lambda Functions
                    await fetchRelatedLambdaFunctions(url);
                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                }
            }

            // Fetch Related Lambda Functions
            async function fetchRelatedLambdaFunctions(url) {
                try {
                    const lambdaResponse = await fetch('https://7t6svygyp2c5nnxcvq5ofpn7xa0xhcks.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    const lambdaData = await lambdaResponse.json();
                    if (lambdaResponse.ok && lambdaData.lambda_functions && Object.keys(lambdaData.lambda_functions).length > 0) {
                        displayLambdaFunctions(lambdaData.lambda_functions);
                    } else {
                        lambdaFunctionsDiv.innerHTML = '<p>No Lambda functions found.</p>';
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error fetching Lambda functions: ' + error.message);
                }
            }

            // Display Lambda Functions
            function displayLambdaFunctions(lambdaFunctions) {
                lambdaFunctionsDiv.innerHTML = '';
                Object.entries(lambdaFunctions).forEach(([lambdaUrl, functionName]) => {
                    const functionItem = document.createElement('div');
                    functionItem.classList.add('function-item');
                    functionItem.innerHTML = `
                        <div class="header">
                            <div>
                                <h3 class="text-lg font-semibold">${functionName}</h3>
                                <p class="text-sm text-gray-500">${lambdaUrl}</p>
                            </div>
                            <div>
                                <button class="toggle-details">â–¼</button>
                            </div>
                        </div>
                        <div class="details">
                            <p>Loading function details...</p>
                        </div>
                    `;
                    lambdaFunctionsDiv.appendChild(functionItem);

                    const toggleButton = functionItem.querySelector('.toggle-details');
                    const detailsDiv = functionItem.querySelector('.details');
                    toggleButton.addEventListener('click', () => {
                        if (functionItem.classList.contains('active')) {
                            functionItem.classList.remove('active');
                        } else {
                            functionItem.classList.add('active');
                            if (!detailsDiv.dataset.loaded) {
                                loadFunctionDetails(functionName, detailsDiv);
                            }
                        }
                    });
                });
            }

            // Load Function Details
            async function loadFunctionDetails(functionName, detailsDiv) {
                try {
                    const functionResponse = await fetch('https://8qfyzi5f1msnmjmbdawr6r7qdq0yswce.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName })
                    });
                    const functionData = await functionResponse.json();
                    if (functionResponse.ok) {
                        detailsDiv.innerHTML = `
                            <h4 class="text-md font-semibold mb-2">Function Code:</h4>
                            <pre class="code-editor">${functionData.code || 'No code available'}</pre>
                            <label for="userRequest-${functionName}">User Request:</label>
                            <textarea id="userRequest-${functionName}" rows="2" placeholder="Describe changes to the function..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button class="update-function-button" data-function-name="${functionName}">Update Function</button>
                                <button class="rewrite-function-button" data-function-name="${functionName}">Rewrite Function</button>
                            </div>
                        `;
                        // Add Event Listeners for Update and Rewrite Buttons
                        const updateButton = detailsDiv.querySelector('.update-function-button');
                        const rewriteButton = detailsDiv.querySelector('.rewrite-function-button');
                        updateButton.addEventListener('click', handleUpdateFunction);
                        rewriteButton.addEventListener('click', handleRewriteFunction);
                        detailsDiv.dataset.loaded = true;
                    } else {
                        throw new Error(functionData.message || 'Failed to fetch function details');
                    }
                } catch (error) {
                    console.error(error);
                    detailsDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            }

            // Handle Update Function
            async function handleUpdateFunction(event) {
                const functionName = event.target.getAttribute('data-function-name');
                const detailsDiv = event.target.closest('.details');
                const code = detailsDiv.querySelector('.code-editor').textContent;
                try {
                    // Call API to update function code
                    const response = await fetch('https://qklalf7lnzfjghjwubqq232bj40llolc.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName, updatedCode: code })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Function updated successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to update function');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error updating function: ' + error.message);
                }
            }

            // Handle Rewrite Function
            async function handleRewriteFunction(event) {
                const functionName = event.target.getAttribute('data-function-name');
                const detailsDiv = event.target.closest('.details');
                const code = detailsDiv.querySelector('.code-editor').textContent;
                const userRequest = detailsDiv.querySelector(`#userRequest-${functionName}`).value.trim();
                if (!userRequest) {
                    alert('Please enter a user request.');
                    return;
                }
                event.target.textContent = 'Rewriting...';
                event.target.disabled = true;

                try {
                    // Call API to rewrite function code
                    const response = await fetch('https://xmakkpe5oox6hvkaei4tomxsty0bqsqn.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ functionName, existingCode: code, userRequest })
                    });
                    const data = await response.json();
                    if (response.ok && data.updatedCode) {
                        detailsDiv.querySelector('.code-editor').textContent = data.updatedCode;
                        alert('Function rewritten successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to rewrite function');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error rewriting function: ' + error.message);
                } finally {
                    event.target.textContent = 'Rewrite Function';
                    event.target.disabled = false;
                }
            }

            // Show Rendered Content
            function showRenderedContent() {
                toggleRendered.classList.add('active');
                toggleCode.classList.remove('active');
                renderedContent.classList.remove('hidden');
                codeContent.classList.add('hidden');
            }

            // Show Code Content
            function showCodeContent() {
                toggleCode.classList.add('active');
                toggleRendered.classList.remove('active');
                codeContent.classList.remove('hidden');
                renderedContent.classList.add('hidden');
                codeEditor.refresh();
            }

            // Handle Update Frontend
            async function handleUpdateFrontend() {
                const updatedCode = codeEditor.getValue();
                const githubUrl = urlInput.value.trim();
                if (!updatedCode || !githubUrl) return;

                updateFrontendButton.textContent = 'Updating...';
                updateFrontendButton.disabled = true;

                try {
                    const response = await fetch('https://e4dtiiwk2mn5k6z6s4vwpmluvi0kavve.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: githubUrl, updatedCode })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Frontend updated successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to update frontend');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                } finally {
                    updateFrontendButton.textContent = 'Update';
                    updateFrontendButton.disabled = false;
                }
            }

            // Handle Rewrite Frontend
            async function handleRewriteFrontend() {
                const userRequest = frontendUserRequest.value.trim();
                const existingCode = codeEditor.getValue();
                if (!userRequest || !existingCode) return;

                rewriteFrontendButton.textContent = 'Rewriting...';
                rewriteFrontendButton.disabled = true;

                try {
                    const response = await fetch('https://pphvmloxbpolihsjuelbfoieqm0zzvgq.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userRequest, existingCode })
                    });
                    const data = await response.json();
                    if (response.ok && data.html_code) {
                        codeEditor.setValue(data.html_code);
                        contentFrame.srcdoc = data.html_code;

                        // Display Improvement Suggestions
                        displaySuggestions(data.suggestions);
                    } else {
                        throw new Error(data.message || 'Failed to rewrite frontend');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                } finally {
                    rewriteFrontendButton.textContent = 'Rewrite HTML';
                    rewriteFrontendButton.disabled = false;
                }
            }

            // Display Improvement Suggestions
            function displaySuggestions(suggestions) {
                if (!suggestions || !Array.isArray(suggestions)) return;
                // Remove existing suggestions
                let suggestionsContainer = document.getElementById('suggestions');
                if (suggestionsContainer) {
                    suggestionsContainer.remove();
                }
                suggestionsContainer = document.createElement('div');
                suggestionsContainer.id = 'suggestions';
                suggestionsContainer.classList.add('mt-6', 'bg-white', 'p-4', 'rounded', 'shadow');
                const suggestionsTitle = document.createElement('h3');
                suggestionsTitle.classList.add('text-lg', 'font-semibold', 'mb-2');
                suggestionsTitle.textContent = 'Improvement Suggestions';
                const suggestionsList = document.createElement('ul');
                suggestionsList.classList.add('list-disc', 'list-inside');
                suggestions.forEach(suggestion => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<strong>${suggestion.title}</strong>: ${suggestion.details}`;
                    suggestionsList.appendChild(listItem);
                });
                suggestionsContainer.appendChild(suggestionsTitle);
                suggestionsContainer.appendChild(suggestionsList);
                resultSection.appendChild(suggestionsContainer);
            }

            // Show Notification
            function showNotification(message) {
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 4000);
            }
        });
    </script>
</body>
</html>
