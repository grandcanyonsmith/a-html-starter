<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Metadata and styles -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Lambda Function Viewer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" integrity="sha512-L3dDupTKu5DGZXhlZEdpcPrTZUR6L0kJYf7UBD1gZlGsS6tulnfkpVFuUtyma4sYBCsyJs42HVRwD0ecg3m0pA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css" integrity="sha512-JzE3MFdU2Rmqj9S3i68riggTVTuD9ZxOsNbDP2Y443K989/FiWH5G6pyclAcULWLB+CFzfFqBhWuId9i4APSEg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js" integrity="sha512-Cxe1J5PgRpMUZCaaQbd3mgbQRO0Lg1FkCmsu9Flu4b0WJqJEwvP2dIfGUb9G0cckVx+e9D10eIqkMf0wVUHD/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="bg-gray-50">
    <!-- Content -->
    <div class="container mx-auto p-6">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-4xl font-bold text-gray-800">AWS Lambda Function Viewer</h1>
            <button id="refreshFunctions" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Refresh Functions</button>
        </header>
        <div id="functionList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Lambda functions will be displayed here -->
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full z-50">
            <div class="px-6 py-4">
                <div class="flex items-center">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <!-- Warning Icon -->
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75M3.3 16.4c-.87 1.5.22 3.36 1.95 3.36h14.5c1.73 0 2.8-1.87 1.95-3.36L13.95 3.36c-.87-1.5-3.03-1.5-3.9 0L3.3 16.4zM12 15.75h.01v.01H12v-.01z" />
                        </svg>
                    </div>
                    <div class="ml-4 text-center sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Delete Lambda Function</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="modal-message">Are you sure you want to delete this function?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 flex justify-end">
                <button id="cancelDelete" type="button" class="mr-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-50 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">Cancel</button>
                <button id="confirmDelete" type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Delete</button>
            </div>
        </div>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js" integrity="sha512-x3612rjkvx5EqZTW2SqsK6Z1fsOhsqjdHNcqOtgqI85Czsnldigz4A68LN1TRD+Yxrvn80V67GES0HZPjtjfQg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- CodeMirror Python Mode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js" integrity="sha512-Cm/e9JB0c98oj4gyGDUDdQS5gR+n8r0qV/CEK+Haw3S28bZ6H4BcYIvQYgLiEGlZsoD2DA8VPBzaZDOZZ7+iuQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Main JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing function list');
            const functionList = document.getElementById('functionList');
            const refreshButton = document.getElementById('refreshFunctions');

            // Function to fetch and display Lambda functions
            async function loadFunctions() {
                functionList.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-9 w-9 border-t-2 border-b-2 border-blue-500"></div></div>';

                try {
                    const response = await fetch('https://j6uh5lxq4xjbm3k253olur2joy0bpebl.lambda-url.us-west-2.on.aws/');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    console.log('Lambda Functions:', data);

                    functionList.innerHTML = '';
                    data.forEach(func => {
                        const funcCard = document.createElement('div');
                        funcCard.className = 'bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow duration-200 relative flex flex-col';
                        funcCard.setAttribute('data-function-arn', func.FunctionArn);

                        // Create a string to hold the formatted code files
                        let codeFilesContent = '';
                        for (const [fileName, fileContent] of Object.entries(func.CodeFiles)) {
                            codeFilesContent += `
                                <div class="mt-4">
                                    <h3 class="text-lg font-semibold mb-2">${fileName}</h3>
                                    <textarea id="code-${func.FunctionName}-${fileName}" class="code-editor">${fileContent}</textarea>
                                </div>
                            `;
                        }

                        const lastModifiedRelative = moment(func.LastModified).fromNow();

                        funcCard.innerHTML = `
                            <div class="flex-1">
                                <h2 class="text-xl font-bold text-gray-800 cursor-pointer hover:underline" data-function-name="${func.FunctionName}">${func.FunctionName}</h2>
                                <p class="text-sm text-gray-500 mt-1">Last Modified: ${lastModifiedRelative}</p>
                            </div>
                            <div class="absolute top-4 right-4 flex space-x-2">
                                <button class="edit-button" data-function-name="${func.FunctionName}" title="Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 hover:text-gray-800 transition duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l3.536 3.536m-1.768-1.768L5.232 15.232m0 0L3 21l5.768-2.232m0 0L15.232 9m0 0L21 3l-5.768 2.232z" />
                                    </svg>
                                </button>
                                <button class="delete-button" data-function-name="${func.FunctionName}" data-function-arn="${func.FunctionArn}" title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 hover:text-red-800 transition duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-4">
                                <button class="view-logs-button bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 transition duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50" data-function-arn="${func.FunctionArn}">View Logs</button>
                            </div>
                            <div class="code-container hidden mt-4" id="code-${func.FunctionName}">
                                ${codeFilesContent}
                                <textarea id="userRequest-${func.FunctionName}" class="mt-4 p-2 w-full border rounded" placeholder="Enter user request..."></textarea>
                                <div class="flex space-x-2 mt-4">
                                    <button class="update-button bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" data-function-arn="${func.FunctionArn}">Update</button>
                                    <button class="rewrite-button bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" data-function-name="${func.FunctionName}">Rewrite Code</button>
                                </div>
                            </div>
                            <div class="logs-container hidden mt-4" id="logs-${func.FunctionName}">
                                <!-- Logs content will be injected here -->
                            </div>
                        `;

                        functionList.appendChild(funcCard);
                    });

                    // Initialize CodeMirror editors after elements are added to the DOM
                    data.forEach(func => {
                        for (const fileName of Object.keys(func.CodeFiles)) {
                            const textArea = document.getElementById(`code-${func.FunctionName}-${fileName}`);
                            if (textArea) {
                                const editor = CodeMirror.fromTextArea(textArea, {
                                    lineNumbers: true,
                                    mode: 'python',
                                    theme: 'dracula',
                                    readOnly: false
                                });
                                // Add Tailwind classes to the CodeMirror wrapper element
                                editor.getWrapperElement().classList.add('border', 'border-gray-300', 'rounded-md', 'h-auto', 'w-full', 'overflow-y-auto', 'max-h-96');
                            } else {
                                console.error(`Textarea not found for ${func.FunctionName}-${fileName}`);
                            }
                        }
                    });

                    // Event handlers
                    addEventHandlers();

                } catch (error) {
                    console.error('Error fetching Lambda functions:', error);
                    functionList.innerHTML = '<p class="text-red-500">Error fetching Lambda functions. Please try again later.</p>';
                }
            }

            // Load functions on page load
            loadFunctions();

            // Refresh button handler
            refreshButton.addEventListener('click', () => {
                console.log('Refresh button clicked');
                refreshButton.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>';
                refreshButton.disabled = true;
                loadFunctions().then(() => {
                    refreshButton.textContent = 'Refresh Functions';
                    refreshButton.disabled = false;
                });
            });

            // Function to add event handlers
            function addEventHandlers() {
                // Toggle code container
                document.querySelectorAll('[data-function-name]').forEach(title => {
                    title.addEventListener('click', (event) => {
                        const functionName = event.currentTarget.getAttribute('data-function-name');
                        toggleCodeContainer(functionName);
                        console.log(`Function ${functionName} clicked`);
                    });
                });

                // Edit button
                document.querySelectorAll('.edit-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const functionName = event.currentTarget.getAttribute('data-function-name');
                        toggleCodeContainer(functionName);
                        console.log(`Edit button clicked for function: ${functionName}`);
                    });
                });

                // Delete button
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const functionName = event.currentTarget.getAttribute('data-function-name');
                        const functionArn = event.currentTarget.getAttribute('data-function-arn');
                        console.log(`Delete button clicked for function: ${functionName}`);
                        document.getElementById('modal-message').textContent = `Are you sure you want to delete the function "${functionName}"?`;
                        document.getElementById('deleteModal').classList.remove('hidden');
                        document.getElementById('confirmDelete').setAttribute('data-function-arn', functionArn);
                        document.getElementById('confirmDelete').setAttribute('data-function-name', functionName);
                    });
                });

                // Confirm delete
                document.getElementById('confirmDelete').addEventListener('click', async (event) => {
                    const functionArn = event.currentTarget.getAttribute('data-function-arn');
                    const functionName = event.currentTarget.getAttribute('data-function-name');
                    const deleteButton = event.currentTarget;
                    console.log(`Confirm delete clicked for function: ${functionName}`);
                    deleteButton.textContent = 'Deleting...';
                    deleteButton.disabled = true;

                    try {
                        const response = await fetch('https://4g64lwaoh6whewppdclrtfgw340phswd.lambda-url.us-west-2.on.aws/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ functionArn: functionArn })
                        });

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const result = await response.json();
                        console.log('Delete result:', result);

                        // Remove the function from the list
                        const functionElement = document.querySelector(`[data-function-arn="${functionArn}"]`);
                        if (functionElement) {
                            functionElement.remove();
                        }

                        // Close modal
                        document.getElementById('deleteModal').classList.add('hidden');
                        alert(`Function "${functionName}" deleted successfully.`);
                    } catch (error) {
                        console.error('Error deleting Lambda function:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        deleteButton.textContent = 'Delete';
                        deleteButton.disabled = false;
                    }
                });

                // Cancel delete
                document.getElementById('cancelDelete').addEventListener('click', () => {
                    console.log('Cancel delete clicked');
                    document.getElementById('deleteModal').classList.add('hidden');
                });

                // Update button
                document.querySelectorAll('.update-button').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const functionArn = event.currentTarget.getAttribute('data-function-arn');
                        const functionName = functionArn.split(':').pop();
                        const codeEditors = document.querySelectorAll(`#code-${functionName} .CodeMirror`);
                        let updatedCode = '';
                        codeEditors.forEach(editor => {
                            updatedCode += editor.CodeMirror.getValue();
                        });
                        console.log(`Update button clicked for function: ${functionName}`);

                        const updateButton = event.currentTarget;
                        updateButton.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>';
                        updateButton.disabled = true;

                        try {
                            const response = await fetch('https://qklalf7lnzfjghjwubqq232bj40llolc.lambda-url.us-west-2.on.aws/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    arn: functionArn,
                                    updatedCode: updatedCode
                                })
                            });
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            const result = await response.json();
                            console.log('Update result:', result);
                            alert(`Function "${functionName}" updated successfully.`);
                        } catch (error) {
                            console.error('Error updating Lambda function:', error);
                            alert('Error: ' + error.message);
                        } finally {
                            updateButton.textContent = 'Update';
                            updateButton.disabled = false;
                        }
                    });
                });

                // Rewrite button
                document.querySelectorAll('.rewrite-button').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const functionName = event.currentTarget.getAttribute('data-function-name');
                        const userRequest = document.getElementById(`userRequest-${functionName}`).value;
                        const codeEditors = document.querySelectorAll(`#code-${functionName} .CodeMirror`);
                        let existingCode = '';
                        codeEditors.forEach(editor => {
                            existingCode += editor.CodeMirror.getValue();
                        });

                        console.log(`Rewrite button clicked for function: ${functionName}`);

                        if (!userRequest || !existingCode) {
                            alert('Please ensure both user request and existing code are provided.');
                            return;
                        }

                        const rewriteButton = event.currentTarget;
                        rewriteButton.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>';
                        rewriteButton.disabled = true;

                        try {
                            const response = await fetch('https://xmakkpe5oox6hvkaei4tomxsty0bqsqn.lambda-url.us-west-2.on.aws/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    userRequest: userRequest,
                                    existingCode: existingCode
                                })
                            });

                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }

                            const data = await response.json();
                            codeEditors.forEach(editor => {
                                editor.CodeMirror.setValue(data.updatedCode);
                            });
                            alert(`Code rewritten successfully for function "${functionName}".`);
                        } catch (error) {
                            console.error('Error rewriting code:', error);
                            alert('Error: ' + error.message);
                        } finally {
                            rewriteButton.textContent = 'Rewrite Code';
                            rewriteButton.disabled = false;
                        }
                    });
                });

                // View Logs button
                document.querySelectorAll('.view-logs-button').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const functionArn = event.currentTarget.getAttribute('data-function-arn');
                        const functionName = functionArn.split(':').pop();
                        const logsDiv = document.getElementById(`logs-${functionName}`);
                        console.log(`View Logs button clicked for function: ${functionName}`);

                        if (logsDiv.classList.contains('hidden')) {
                            logsDiv.classList.remove('hidden');
                            logsDiv.classList.add('block');
                        } else {
                            logsDiv.classList.remove('block');
                            logsDiv.classList.add('hidden');
                            return;
                        }

                        logsDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-9 w-9 border-t-2 border-b-2 border-yellow-500"></div></div>';

                        try {
                            const response = await fetch('https://dk4wzehdht64hx5gsye2njddzq0oxwow.lambda-url.us-west-2.on.aws/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ requestType: 'fetchLogStreams', functionArn: functionArn })
                            });

                            if (response.ok) {
                                const logStreams = await response.json();
                                console.log('Log Streams:', logStreams);

                                if (logStreams.length === 0) {
                                    logsDiv.innerHTML = '<p class="text-gray-600">No log streams found.</p>';
                                    return;
                                }

                                const logStreamsContainer = document.createElement('div');
                                logStreamsContainer.className = 'mt-4';

                                logStreams.forEach(stream => {
                                    const streamElement = document.createElement('div');
                                    streamElement.className = 'bg-gray-100 p-3 mb-2 rounded cursor-pointer hover:bg-gray-200 transition duration-200';
                                    streamElement.textContent = `Log Stream: ${stream.logStreamName} (Last Event: ${new Date(stream.lastEventTimestamp).toLocaleString()})`;
                                    streamElement.addEventListener('click', () => fetchLogEvents(functionArn, stream.logStreamName, logsDiv));
                                    logStreamsContainer.appendChild(streamElement);
                                });

                                logsDiv.innerHTML = '';
                                logsDiv.appendChild(logStreamsContainer);

                            } else {
                                throw new Error('Failed to fetch log streams');
                            }
                        } catch (error) {
                            console.error('Error fetching log streams:', error);
                            logsDiv.innerHTML = '<p class="text-red-500">Error fetching log streams. Please try again later.</p>';
                        }
                    });
                });
            }

            async function fetchLogEvents(functionArn, logStreamName, logsDiv) {
                console.log(`Fetching log events for: ${logStreamName}`);
                logsDiv.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-9 w-9 border-t-2 border-b-2 border-yellow-500"></div></div>';

                try {
                    const response = await fetch('https://dk4wzehdht64hx5gsye2njddzq0oxwow.lambda-url.us-west-2.on.aws/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ requestType: 'fetchLogs', logGroupName: `/aws/lambda/${functionArn.split(':').pop()}`, logStreamName: logStreamName })
                    });

                    if (response.ok) {
                        const logEvents = await response.json();
                        console.log('Log Events:', logEvents);

                        if (logEvents.length === 0) {
                            logsDiv.innerHTML = '<p class="text-gray-600">No log events found.</p>';
                            return;
                        }

                        const logEventsContainer = document.createElement('div');
                        logEventsContainer.className = 'mt-4';

                        logEvents.forEach(event => {
                            const eventElement = document.createElement('div');
                            eventElement.className = 'bg-gray-800 text-white p-3 mb-2 rounded overflow-x-auto';
                            eventElement.innerHTML = `
                                <p class="text-sm font-semibold">${new Date(event.timestamp).toLocaleString()}</p>
                                <pre class="mt-2 whitespace-pre-wrap">${event.message}</pre>
                            `;
                            logEventsContainer.appendChild(eventElement);
                        });

                        logsDiv.innerHTML = '';
                        logsDiv.appendChild(logEventsContainer);
                    } else {
                        throw new Error('Failed to fetch log events');
                    }
                } catch (error) {
                    console.error('Error fetching log events:', error);
                    logsDiv.innerHTML = '<p class="text-red-500">Error fetching log events. Please try again later.</p>';
                }
            }

            function toggleCodeContainer(functionName) {
                const codeDiv = document.getElementById(`code-${functionName}`);
                if (codeDiv.classList.contains('hidden')) {
                    codeDiv.classList.remove('hidden');
                    codeDiv.classList.add('block');
                } else {
                    codeDiv.classList.remove('block');
                    codeDiv.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>