<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transcriptions Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4">
    <!-- Header -->
    <header class="text-center mb-4">
        <h1 class="text-3xl font-bold">Transcriptions Manager</h1>
    </header>

    <!-- All Transcriptions -->
    <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-2">All Transcriptions</h2>
        <div class="overflow-x-auto bg-white p-4 rounded shadow">
            <table id="transcriptions-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">TranscriptionId</th>
                        <th class="py-2 px-4 border-b">Title</th>
                        <th class="py-2 px-4 border-b">Type</th>
                        <th class="py-2 px-4 border-b">Subtype</th>
                        <th class="py-2 px-4 border-b">Department</th>
                        <th class="py-2 px-4 border-b">Status</th>
                        <th class="py-2 px-4 border-b">CreatedAt</th>
                        <th class="py-2 px-4 border-b text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="transcriptions-table-body">
                    <!-- Table rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Modals -->
    <!-- Transcription View Modal -->
    <div id="transcription-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 opacity-75"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
                <div class="bg-white p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="transcription-modal-title" class="text-xl font-semibold"></h3>
                        <button id="close-transcription-modal" class="text-gray-600 hover:text-gray-800">&times;</button>
                    </div>
                    <div id="transcription-text" class="mb-4 whitespace-pre-wrap text-gray-800"></div>
                    <button id="copy-button" class="bg-blue-500 text-white px-4 py-2 rounded">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transcription Modal -->
    <div id="edit-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 opacity-75"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="bg-white p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Edit Transcription</h3>
                        <button id="close-edit-modal" class="text-gray-600 hover:text-gray-800">&times;</button>
                    </div>
                    <form id="edit-form">
                        <!-- Fields to edit -->
                        <input type="hidden" id="edit-transcription-id">
                        <div class="mb-4">
                            <label for="edit-title" class="block text-gray-700">Title</label>
                            <input type="text" id="edit-title" class="w-full border border-gray-300 p-2 rounded" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-type" class="block text-gray-700">Type</label>
                            <input type="text" id="edit-type" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <div class="mb-4">
                            <label for="edit-subtype" class="block text-gray-700">Subtype</label>
                            <input type="text" id="edit-subtype" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <div class="mb-4">
                            <label for="edit-department" class="block text-gray-700">Department</label>
                            <input type="text" id="edit-department" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <!-- Add other fields as necessary -->
                        <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const functionUrl = 'https://olklpvaby2iyjc4glpjazbhzum0whraj.lambda-url.us-west-2.on.aws/';

        document.addEventListener('DOMContentLoaded', function() {
            fetchAllTranscriptions();
        });

        function fetchAllTranscriptions() {
            console.log('Fetching all transcriptions');
            const data = {
                operation: 'read_all',
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Read All Response:', data);
                const tbody = document.getElementById('transcriptions-table-body');
                tbody.innerHTML = ''; // Clear existing rows
                if (data.error) {
                    console.error('Error fetching transcriptions:', data.error);
                    alert('Error fetching transcriptions');
                } else {
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = 'cursor-pointer hover:bg-gray-100';

                        // Add click event to show transcription
                        tr.addEventListener('click', function(event) {
                            // Prevent event from triggering when clicking on the action menu
                            if (event.target.closest('.action-button')) return;
                            showTranscription(item.TranscriptionId, item.Title);
                        });

                        const tdTranscriptionId = document.createElement('td');
                        tdTranscriptionId.className = 'py-2 px-4 border-b';
                        tdTranscriptionId.textContent = item.TranscriptionId || '';
                        tr.appendChild(tdTranscriptionId);

                        const tdTitle = document.createElement('td');
                        tdTitle.className = 'py-2 px-4 border-b';
                        tdTitle.textContent = item.Title || '';
                        tr.appendChild(tdTitle);

                        const tdType = document.createElement('td');
                        tdType.className = 'py-2 px-4 border-b';
                        tdType.textContent = item.Type || '';
                        tr.appendChild(tdType);

                        const tdSubtype = document.createElement('td');
                        tdSubtype.className = 'py-2 px-4 border-b';
                        tdSubtype.textContent = item.Subtype || '';
                        tr.appendChild(tdSubtype);

                        const tdDepartment = document.createElement('td');
                        tdDepartment.className = 'py-2 px-4 border-b';
                        tdDepartment.textContent = item.Department || '';
                        tr.appendChild(tdDepartment);

                        const tdStatus = document.createElement('td');
                        tdStatus.className = 'py-2 px-4 border-b';
                        tdStatus.textContent = item.Status || '';
                        tr.appendChild(tdStatus);

                        const tdCreatedAt = document.createElement('td');
                        tdCreatedAt.className = 'py-2 px-4 border-b';
                        tdCreatedAt.textContent = item.CreatedAt || '';
                        tr.appendChild(tdCreatedAt);

                        // Actions Column
                        const tdActions = document.createElement('td');
                        tdActions.className = 'py-2 px-4 border-b text-center relative';

                        // Action Button (Three Dots)
                        const actionButton = document.createElement('button');
                        actionButton.className = 'action-button text-gray-600 hover:text-gray-800 focus:outline-none';
                        actionButton.innerHTML = '&#x22EE;'; // Vertical three dots
                        actionButton.addEventListener('click', function(event) {
                            event.stopPropagation(); // Prevent triggering the row click event
                            toggleActionMenu(actionMenu);
                        });
                        tdActions.appendChild(actionButton);

                        // Action Menu
                        const actionMenu = document.createElement('div');
                        actionMenu.className = 'action-menu absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded shadow-lg hidden';

                        const editOption = document.createElement('a');
                        editOption.href = '#';
                        editOption.className = 'block px-4 py-2 text-gray-700 hover:bg-gray-100';
                        editOption.textContent = 'Edit';
                        editOption.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            toggleActionMenu(actionMenu);
                            openEditModal(item);
                        });
                        actionMenu.appendChild(editOption);

                        const deleteOption = document.createElement('a');
                        deleteOption.href = '#';
                        deleteOption.className = 'block px-4 py-2 text-gray-700 hover:bg-gray-100';
                        deleteOption.textContent = 'Delete';
                        deleteOption.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            toggleActionMenu(actionMenu);
                            if (confirm('Are you sure you want to delete this transcription?')) {
                                deleteTranscription(item.TranscriptionId);
                            }
                        });
                        actionMenu.appendChild(deleteOption);

                        tdActions.appendChild(actionMenu);
                        tr.appendChild(tdActions);

                        tbody.appendChild(tr);
                    });

                    // Close any open action menus when clicking outside
                    document.addEventListener('click', closeAllActionMenus);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching all transcriptions');
            });
        }

        function toggleActionMenu(menu) {
            closeAllActionMenus();
            menu.classList.toggle('hidden');
        }

        function closeAllActionMenus() {
            const menus = document.querySelectorAll('.action-menu');
            menus.forEach(menu => menu.classList.add('hidden'));
        }

        function showTranscription(transcriptionId, title) {
            console.log('Showing transcription:', transcriptionId);
            const data = {
                operation: 'read',
                TranscriptionId: transcriptionId,
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Read Response:', data);
                if (data.error) {
                    alert('Error fetching transcription: ' + data.error);
                } else {
                    const modal = document.getElementById('transcription-modal');
                    document.getElementById('transcription-modal-title').textContent = title || 'Transcription';
                    document.getElementById('transcription-text').textContent = data.TranscriptionText || 'No transcription text available.';
                    modal.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching transcription');
            });
        }

        // Close Transcription Modal
        document.getElementById('close-transcription-modal').addEventListener('click', function() {
            document.getElementById('transcription-modal').classList.add('hidden');
        });

        // Copy to Clipboard
        document.getElementById('copy-button').addEventListener('click', function() {
            const transcriptionText = document.getElementById('transcription-text').textContent;
            navigator.clipboard.writeText(transcriptionText)
                .then(() => {
                    alert('Transcription copied to clipboard');
                })
                .catch(err => {
                    console.error('Error copying text: ', err);
                    alert('Error copying transcription');
                });
        });

        function openEditModal(item) {
            console.log('Editing transcription:', item.TranscriptionId);
            document.getElementById('edit-transcription-id').value = item.TranscriptionId;
            document.getElementById('edit-title').value = item.Title || '';
            document.getElementById('edit-type').value = item.Type || '';
            document.getElementById('edit-subtype').value = item.Subtype || '';
            document.getElementById('edit-department').value = item.Department || '';
            // Add other fields as necessary
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        // Close Edit Modal
        document.getElementById('close-edit-modal').addEventListener('click', function() {
            document.getElementById('edit-modal').classList.add('hidden');
        });

        // Handle Edit Form Submission
        document.getElementById('edit-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const transcriptionId = document.getElementById('edit-transcription-id').value;
            const data = {
                operation: 'update',
                TranscriptionId: transcriptionId,
                Title: document.getElementById('edit-title').value,
                Type: document.getElementById('edit-type').value,
                Subtype: document.getElementById('edit-subtype').value,
                Department: document.getElementById('edit-department').value,
                // Add other fields as necessary
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Update Response:', data);
                if (data.error) {
                    alert('Error updating transcription: ' + data.error);
                } else {
                    alert('Transcription updated successfully');
                    document.getElementById('edit-modal').classList.add('hidden');
                    fetchAllTranscriptions();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating transcription');
            });
        });

        function deleteTranscription(transcriptionId) {
            console.log('Deleting transcription:', transcriptionId);
            const data = {
                operation: 'delete',
                TranscriptionId: transcriptionId,
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Delete Response:', data);
                if (data.error) {
                    alert('Error deleting transcription: ' + data.error);
                } else {
                    alert('Transcription deleted successfully');
                    fetchAllTranscriptions();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting transcription');
            });
        }

        // Close action menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.action-button')) {
                closeAllActionMenus();
            }
        });
    </script>
</body>
</html>
