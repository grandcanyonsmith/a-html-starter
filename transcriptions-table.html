<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transcriptions Manager</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4">
    <!-- Header -->
    <header class="text-center mb-4">
        <h1 class="text-3xl font-bold">Transcriptions Manager</h1>
    </header>

    <!-- Search and Filter -->
    <section class="mb-4">
        <div class="flex justify-between items-center">
            <!-- Search Input -->
            <div class="relative">
                <input type="text" id="search-input" class="border border-gray-300 rounded pl-8 pr-4 py-2" placeholder="Search...">
                <span class="absolute left-0 top-0 mt-2 ml-2 text-gray-400">
                    <!-- Search Icon (SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
            </div>
            <!-- Add any additional filters or actions here -->
        </div>
    </section>

    <!-- All Transcriptions -->
    <section class="mb-8">
        <div class="overflow-x-auto bg-white p-4 rounded shadow">
            <table id="transcriptions-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th data-key="CreatedAt" class="py-2 px-4 border-b cursor-pointer sort-header">CreatedAt <span class="sort-indicator"></span></th>
                        <th data-key="Title" class="py-2 px-4 border-b cursor-pointer sort-header">Title <span class="sort-indicator"></span></th>
                        <th data-key="Type" class="py-2 px-4 border-b cursor-pointer sort-header">Type <span class="sort-indicator"></span></th>
                        <th data-key="Subtype" class="py-2 px-4 border-b cursor-pointer sort-header">Subtype <span class="sort-indicator"></span></th>
                        <th data-key="Department" class="py-2 px-4 border-b cursor-pointer sort-header">Department <span class="sort-indicator"></span></th>
                        <th data-key="Status" class="py-2 px-4 border-b cursor-pointer sort-header">Status <span class="sort-indicator"></span></th>
                        <th class="py-2 px-4 border-b text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="transcriptions-table-body">
                    <!-- Table rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Modals -->
    <!-- Transcription View Modal -->
    <div id="transcription-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeModal('transcription-modal')"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
                <div class="bg-white p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="transcription-modal-title" class="text-xl font-semibold"></h3>
                        <button onclick="closeModal('transcription-modal')" class="text-gray-600 hover:text-gray-800 focus:outline-none text-2xl">&times;</button>
                    </div>
                    <div id="transcription-text" class="mb-4 whitespace-pre-wrap text-gray-800 max-h-96 overflow-y-auto"></div>
                    <button id="copy-button" class="bg-blue-500 text-white px-4 py-2 rounded">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transcription Modal -->
    <div id="edit-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeModal('edit-modal')"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="bg-white p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Edit Transcription</h3>
                        <button onclick="closeModal('edit-modal')" class="text-gray-600 hover:text-gray-800 focus:outline-none text-2xl">&times;</button>
                    </div>
                    <form id="edit-form">
                        <!-- Fields to edit -->
                        <input type="hidden" id="edit-transcription-id">
                        <div class="mb-4">
                            <label for="edit-title" class="block text-gray-700">Title</label>
                            <input type="text" id="edit-title" class="w-full border border-gray-300 p-2 rounded" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-type" class="block text-gray-700">Type</label>
                            <input type="text" id="edit-type" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <div class="mb-4">
                            <label for="edit-subtype" class="block text-gray-700">Subtype</label>
                            <input type="text" id="edit-subtype" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <div class="mb-4">
                            <label for="edit-department" class="block text-gray-700">Department</label>
                            <input type="text" id="edit-department" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <!-- Add other fields as necessary -->
                        <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const functionUrl = 'https://olklpvaby2iyjc4glpjazbhzum0whraj.lambda-url.us-west-2.on.aws/'; // Replace with your actual function URL

        document.addEventListener('DOMContentLoaded', function() {
            fetchAllTranscriptions();
            // Add event listener for search input
            document.getElementById('search-input').addEventListener('input', handleSearch);
            // Close action menus when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.action-button')) {
                    closeAllActionMenus();
                }
            });
        });

        let transcriptions = []; // Store all transcriptions globally
        let sortDirection = {}; // Keep track of sort direction for each column

        function fetchAllTranscriptions() {
            console.log('Fetching all transcriptions');
            const data = {
                operation: 'read_all',
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Read All Response:', data);
                if (data.error) {
                    console.error('Error fetching transcriptions:', data.error);
                    alert('Error fetching transcriptions');
                } else {
                    transcriptions = data;
                    renderTranscriptionsTable(transcriptions);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching all transcriptions');
            });
        }

        function renderTranscriptionsTable(data) {
            const tbody = document.getElementById('transcriptions-table-body');
            tbody.innerHTML = ''; // Clear existing rows

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100';

                // Add click event to show transcription
                tr.addEventListener('click', function(event) {
                    // Prevent event from triggering when clicking on the action menu
                    if (event.target.closest('.action-button') || event.target.closest('.action-menu')) return;
                    showTranscription(item.TranscriptionId, item.Title);
                });

                // Format the CreatedAt date
                const formattedDate = formatDate(item.CreatedAt);

                addTableCell(tr, formattedDate);
                addTableCell(tr, item.Title || '');
                addTableCell(tr, item.Type || '');
                addTableCell(tr, item.Subtype || '');
                addTableCell(tr, item.Department || '');
                addTableCell(tr, item.Status || '');

                // Actions Column
                const tdActions = document.createElement('td');
                tdActions.className = 'py-2 px-4 border-b text-center relative';

                // Action Button (Three Dots)
                const actionButton = document.createElement('button');
                actionButton.className = 'action-button text-gray-600 hover:text-gray-800 focus:outline-none';
                // Use inline SVG for the three-dot icon
                actionButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm0 5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm0 5a1.5 1.5 0 110 3 1.5 1.5 0 010-3z"/>
                    </svg>
                `;
                actionButton.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent triggering the row click event
                    toggleActionMenu(actionMenu);
                });
                tdActions.appendChild(actionButton);

                // Action Menu
                const actionMenu = document.createElement('div');
                actionMenu.className = 'action-menu absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded shadow-lg hidden z-20';

                const editOption = document.createElement('a');
                editOption.href = '#';
                editOption.className = 'block px-4 py-2 text-gray-700 hover:bg-gray-100';
                editOption.textContent = 'Edit';
                editOption.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleActionMenu(actionMenu);
                    openEditModal(item);
                });
                actionMenu.appendChild(editOption);

                const deleteOption = document.createElement('a');
                deleteOption.href = '#';
                deleteOption.className = 'block px-4 py-2 text-gray-700 hover:bg-gray-100';
                deleteOption.textContent = 'Delete';
                deleteOption.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleActionMenu(actionMenu);
                    if (confirm('Are you sure you want to delete this transcription?')) {
                        deleteTranscription(item.TranscriptionId);
                    }
                });
                actionMenu.appendChild(deleteOption);

                tdActions.appendChild(actionMenu);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });

            // Attach sorting event listeners
            const headers = document.querySelectorAll('.sort-header');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    sortTableByKey(key);
                });
            });
        }

        function addTableCell(tr, textContent) {
            const td = document.createElement('td');
            td.className = 'py-2 px-4 border-b';
            td.textContent = textContent;
            tr.appendChild(td);
        }

        function toggleActionMenu(menu) {
            closeAllActionMenus();
            menu.classList.toggle('hidden');
        }

        function closeAllActionMenus() {
            const menus = document.querySelectorAll('.action-menu');
            menus.forEach(menu => menu.classList.add('hidden'));
        }

        function showTranscription(transcriptionId, title) {
            console.log('Showing transcription:', transcriptionId);
            const data = {
                operation: 'read',
                TranscriptionId: transcriptionId,
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Read Response:', data);
                if (data.error) {
                    alert('Error fetching transcription: ' + data.error);
                } else {
                    const modal = document.getElementById('transcription-modal');
                    document.getElementById('transcription-modal-title').textContent = title || 'Transcription';
                    document.getElementById('transcription-text').textContent = data.TranscriptionText || 'No transcription text available.';
                    modal.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching transcription');
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Copy to Clipboard
        document.getElementById('copy-button').addEventListener('click', function() {
            const transcriptionText = document.getElementById('transcription-text').textContent;
            navigator.clipboard.writeText(transcriptionText)
                .then(() => {
                    alert('Transcription copied to clipboard');
                })
                .catch(err => {
                    console.error('Error copying text: ', err);
                    alert('Error copying transcription');
                });
        });

        function openEditModal(item) {
            console.log('Editing transcription:', item.TranscriptionId);
            document.getElementById('edit-transcription-id').value = item.TranscriptionId;
            document.getElementById('edit-title').value = item.Title || '';
            document.getElementById('edit-type').value = item.Type || '';
            document.getElementById('edit-subtype').value = item.Subtype || '';
            document.getElementById('edit-department').value = item.Department || '';
            // Add other fields as necessary
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        // Handle Edit Form Submission
        document.getElementById('edit-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const transcriptionId = document.getElementById('edit-transcription-id').value;
            const data = {
                operation: 'update',
                TranscriptionId: transcriptionId,
                Title: document.getElementById('edit-title').value,
                Type: document.getElementById('edit-type').value,
                Subtype: document.getElementById('edit-subtype').value,
                Department: document.getElementById('edit-department').value,
                // Add other fields as necessary
            };

            // Disable the submit button and change text to "Saving..."
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = 'Saving...';

            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Update Response:', data);
                if (data.error) {
                    alert('Error updating transcription: ' + data.error);
                } else {
                    alert('Transcription updated successfully');
                    closeModal('edit-modal');
                    fetchAllTranscriptions();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating transcription');
            })
            .finally(() => {
                // Re-enable the submit button and restore its text
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            });
        });

        function deleteTranscription(transcriptionId) {
            console.log('Deleting transcription:', transcriptionId);
            const data = {
                operation: 'delete',
                TranscriptionId: transcriptionId,
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Delete Response:', data);
                if (data.error) {
                    alert('Error deleting transcription: ' + data.error);
                } else {
                    alert('Transcription deleted successfully');
                    fetchAllTranscriptions();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting transcription');
            });
        }

        // Sorting Functionality
        function sortTableByKey(key) {
            const direction = sortDirection[key] === 'asc' ? 'desc' : 'asc';
            sortDirection[key] = direction;
            transcriptions.sort((a, b) => {
                let valA = a[key] || '';
                let valB = b[key] || '';
                if (key === 'CreatedAt') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else {
                    valA = valA.toString().toLowerCase();
                    valB = valB.toString().toLowerCase();
                }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            updateSortIndicators(key, direction);
            renderTranscriptionsTable(transcriptions);
        }

        function updateSortIndicators(activeKey, direction) {
            const headers = document.querySelectorAll('.sort-header');
            headers.forEach(header => {
                const key = header.getAttribute('data-key');
                const indicator = header.querySelector('.sort-indicator');
                if (key === activeKey) {
                    indicator.innerHTML = direction === 'asc' ? '&uarr;' : '&darr;';
                } else {
                    indicator.innerHTML = '';
                }
            });
        }

        // Search (Filtering) Functionality
        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            const filteredTranscriptions = transcriptions.filter(item => {
                return (
                    (item.Title && item.Title.toLowerCase().includes(searchTerm)) ||
                    (item.Type && item.Type.toLowerCase().includes(searchTerm)) ||
                    (item.Subtype && item.Subtype.toLowerCase().includes(searchTerm)) ||
                    (item.Department && item.Department.toLowerCase().includes(searchTerm))
                );
            });
            renderTranscriptionsTable(filteredTranscriptions);
        }

        // Format date to human-readable format
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return dateString; // Return original if invalid date
            return date.toISOString().split('.')[0] + 'Z'; // Format as 'YYYY-MM-DDTHH:mm:ssZ'
        }

    </script>
</body>
</html>