<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transcriptions Manager</title>
    <!-- Tailwind CSS -->
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico">
    <!-- Custom Styles -->
    <style>
        /* Customize the scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 9999px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <!-- Header -->
    <header class="text-center mb-4">
        <h1 class="text-3xl font-bold">Transcriptions Manager</h1>
    </header>

    <!-- Search and Filter -->
    <section class="mb-4">
        <div class="flex justify-between items-center">
            <!-- Search Input -->
            <div class="relative">
                <input type="text" id="search-input" class="border border-gray-300 rounded pl-8 pr-4 py-2" placeholder="Search...">
                <span class="absolute left-0 top-0 mt-2 ml-2 text-gray-400">
                    <!-- Search Icon (SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
            </div>
            <!-- "+" Button -->
            <button id="add-transcription-button" class="bg-blue-500 text-white px-4 py-2 rounded flex items-center">
                <!-- Plus Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Transcription
            </button>
        </div>
    </section>

    <!-- All Transcriptions -->
    <section class="mb-8">
        <div class="overflow-x-auto bg-white p-4 rounded shadow">
            <table id="transcriptions-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th data-key="CreatedAt" class="py-2 px-4 border-b cursor-pointer sort-header">CreatedAt <span class="sort-indicator"></span></th>
                        <th data-key="Title" class="py-2 px-4 border-b cursor-pointer sort-header">Title <span class="sort-indicator"></span></th>
                        <th data-key="Type" class="py-2 px-4 border-b cursor-pointer sort-header">Type <span class="sort-indicator"></span></th>
                        <th data-key="Subtype" class="py-2 px-4 border-b cursor-pointer sort-header">Subtype <span class="sort-indicator"></span></th>
                        <th data-key="Department" class="py-2 px-4 border-b cursor-pointer sort-header">Department <span class="sort-indicator"></span></th>
                        <th data-key="Status" class="py-2 px-4 border-b cursor-pointer sort-header">Status <span class="sort-indicator"></span></th>
                        <th class="py-2 px-4 border-b text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="transcriptions-table-body">
                    <!-- Table rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Modals -->
    <!-- Transcription View Modal -->
    <div id="transcription-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeModal('transcription-modal')"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
                <div class="bg-white p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="transcription-modal-title" class="text-xl font-semibold"></h3>
                        <button onclick="closeModal('transcription-modal')" class="text-gray-600 hover:text-gray-800 focus:outline-none text-2xl">&times;</button>
                    </div>
                    <div id="transcription-text" class="mb-4 whitespace-pre-wrap text-gray-800 max-h-96 overflow-y-auto"></div>
                    <button id="copy-button" class="bg-blue-500 text-white px-4 py-2 rounded">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transcription Modal -->
    <div id="edit-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeModal('edit-modal')"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="bg-white p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Edit Transcription</h3>
                        <button onclick="closeModal('edit-modal')" class="text-gray-600 hover:text-gray-800 focus:outline-none text-2xl">&times;</button>
                    </div>
                    <form id="edit-form">
                        <!-- Fields to edit -->
                        <input type="hidden" id="edit-transcription-id">
                        <div class="mb-4">
                            <label for="edit-title" class="block text-gray-700">Title</label>
                            <input type="text" id="edit-title" class="w-full border border-gray-300 p-2 rounded" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-type" class="block text-gray-700">Type</label>
                            <input type="text" id="edit-type" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <div class="mb-4">
                            <label for="edit-subtype" class="block text-gray-700">Subtype</label>
                            <input type="text" id="edit-subtype" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <div class="mb-4">
                            <label for="edit-department" class="block text-gray-700">Department</label>
                            <input type="text" id="edit-department" class="w-full border border-gray-300 p-2 rounded">
                        </div>
                        <!-- Add other fields as necessary -->
                        <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Transcription Modal -->
    <div id="add-transcription-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeModal('add-transcription-modal')"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
                <!-- Transcription Interface -->
                <div class="bg-white p-6">
                    <!-- Close button -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Add Transcription</h2>
                        <button onclick="closeModal('add-transcription-modal')" class="text-gray-600 hover:text-gray-800 focus:outline-none text-2xl">&times;</button>
                    </div>
                    <!-- Form Section -->
                    <section>
                        <form id="transcriptionForm" class="space-y-8" aria-label="Audio Transcription Form">
                            <!-- Audio URL Input -->
                            <div>
                                <label for="audioUrl" class="block text-sm font-semibold text-gray-700">Audio URL</label>
                                <input type="url" id="audioUrl" name="audioUrl" class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm p-3 bg-white text-gray-900 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter audio URL" aria-label="Audio URL">
                                <p id="audioUrlError" class="mt-2 text-sm text-red-600 hidden"></p>
                            </div>
                            <!-- Drag and Drop File Upload -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Upload Audio File</label>
                                <div id="fileUploadArea" class="flex flex-col justify-center items-center px-6 pt-5 pb-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer transition hover:border-blue-500">
                                    <div class="space-y-1 text-center" id="fileUploadContent">
                                        <!-- Upload Icon -->
                                        <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 16.5V18.75A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12 12 16.5M12 16.5 7.5 12M12 16.5V3" />
                                        </svg>
                                        <div class="flex text-sm text-gray-600">
                                            <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                                <span>Upload a file</span>
                                                <input id="fileInput" name="fileInput" type="file" accept=".mp3, .wav, .ogg, .mp4, .mov" class="sr-only" aria-label="File Input">
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500">MP3, WAV, OGG, MP4, MOV up to 2GB</p>
                                    </div>
                                </div>
                                <!-- Audio Player for File Preview -->
                                <div id="fileAudioPreview" class="mt-4 hidden">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Audio Preview</label>
                                    <audio id="fileAudioPlayer" controls class="w-full">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            </div>
                            <!-- Audio Player for URL Preview -->
                            <div id="urlAudioPreview" class="mt-4 hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Audio Preview</label>
                                <audio id="urlAudioPlayer" controls class="w-full">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                            <!-- Submit and Cancel Buttons -->
                            <div class="flex space-x-4">
                                <button type="submit" id="submitButton" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-offset-2 transition disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Transcribe Button" disabled>
                                    Transcribe
                                </button>
                                <button type="button" id="cancelButton" class="flex-1 bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-400 focus:ring-offset-2 transition disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Cancel Button" disabled>
                                    Cancel
                                </button>
                            </div>
                            <!-- Progress bar -->
                            <div id="uploadProgressContainer" class="w-full hidden flex-col items-center">
                                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                                    <div id="progressBar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Uploading file...</p>
                            </div>
                        </form>
                    </section>
                    <!-- Loader and Timer -->
                    <div id="loader" class="mt-8 hidden">
                        <div class="flex justify-center items-center">
                            <!-- Spinner -->
                            <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-label="Loading">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8h8a8 8 0 01-8 8V12H4z"></path>
                            </svg>
                            <!-- Timer -->
                            <p id="transcriptionTimer" class="text-sm text-gray-500 ml-4">Elapsed Time: 00:00</p>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 text-center">Transcription in progress...</p>
                        <!-- Transcription Progress -->
                        <div id="transcriptionProgressContainer" class="w-full flex-col items-center mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="transcriptionProgressBar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p id="transcriptionProgressText" class="text-sm text-gray-500 mt-2">Starting transcription...</p>
                        </div>
                    </div>
                    <!-- Transcription Result -->
                    <section id="result" class="mt-8 hidden">
                        <h2 class="text-2xl font-bold mb-4 text-gray-900">Transcription Result</h2>
                        <div class="relative">
                            <pre id="transcriptionText" class="bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto whitespace-pre-wrap text-gray-900 text-sm leading-6 font-mono resize-y shadow-inner"></pre>
                            <!-- Copy and Download Buttons -->
                            <div class="absolute top-3 right-3 flex space-x-2">
                                <button id="copyButton" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Copy Transcription">
                                    <!-- Clipboard Copy Icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25Z" />
                                    </svg>
                                </button>
                                <button id="downloadButton" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Download Transcription">
                                    <!-- Download Icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 3v13.5m0 0L7.5 12m4.5 4.5L16.5 12" />
                                    </svg>
                                </button>
                            </div>
                            <!-- Save Transcription Button -->
                            <button id="saveTranscriptionButton" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-offset-2 transition disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                                Save Transcription
                            </button>
                        </div>
                        <!-- Character Count -->
                        <p id="characterCount" class="mt-2 text-sm text-gray-500"></p>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const functionUrl = 'https://olklpvaby2iyjc4glpjazbhzum0whraj.lambda-url.us-west-2.on.aws/'; // Replace with your actual function URL

        document.addEventListener('DOMContentLoaded', function() {
            fetchAllTranscriptions();

            // Event listener for the Add Transcription button
            document.getElementById('add-transcription-button').addEventListener('click', function() {
                openModal('add-transcription-modal');
            });

            // Add event listener for search input
            document.getElementById('search-input').addEventListener('input', handleSearch);

            // Close action menus when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.action-button')) {
                    closeAllActionMenus();
                }
            });

            // Initialize variables and set up event listeners for the transcription modal
            initializeTranscriptionModal();
        });

        let transcriptions = []; // Store all transcriptions globally
        let sortDirection = {}; // Keep track of sort direction for each column

        function fetchAllTranscriptions() {
            console.log('Fetching all transcriptions');
            const data = {
                operation: 'read_all',
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Read All Response:', data);
                if (data.error) {
                    console.error('Error fetching transcriptions:', data.error);
                    alert('Error fetching transcriptions');
                } else {
                    transcriptions = data;
                    renderTranscriptionsTable(transcriptions);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching all transcriptions');
            });
        }

        function renderTranscriptionsTable(data) {
            const tbody = document.getElementById('transcriptions-table-body');
            tbody.innerHTML = ''; // Clear existing rows

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100';

                // Add click event to show transcription
                tr.addEventListener('click', function(event) {
                    // Prevent event from triggering when clicking on the action menu
                    if (event.target.closest('.action-button') || event.target.closest('.action-menu')) return;
                    showTranscription(item.TranscriptionId, item.Title);
                });

                // Format the CreatedAt date
                const formattedDate = formatDate(item.CreatedAt);

                addTableCell(tr, formattedDate);
                addTableCell(tr, item.Title || '');
                addTableCell(tr, item.Type || '');
                addTableCell(tr, item.Subtype || '');
                addTableCell(tr, item.Department || '');
                addTableCell(tr, item.Status || '');

                // Actions Column
                const tdActions = document.createElement('td');
                tdActions.className = 'py-2 px-4 border-b text-center relative';

                // Action Button (Three Dots)
                const actionButton = document.createElement('button');
                actionButton.className = 'action-button text-gray-600 hover:text-gray-800 focus:outline-none';
                // Use inline SVG for the three-dot icon
                actionButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm0 5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm0 5a1.5 1.5 0 110 3 1.5 1.5 0 010-3z"/>
                    </svg>
                `;
                actionButton.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent triggering the row click event
                    toggleActionMenu(actionMenu);
                });
                tdActions.appendChild(actionButton);

                // Action Menu
                const actionMenu = document.createElement('div');
                actionMenu.className = 'action-menu absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded shadow-lg hidden z-20';

                const editOption = document.createElement('a');
                editOption.href = '#';
                editOption.className = 'block px-4 py-2 text-gray-700 hover:bg-gray-100';
                editOption.textContent = 'Edit';
                editOption.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleActionMenu(actionMenu);
                    openEditModal(item);
                });
                actionMenu.appendChild(editOption);

                const deleteOption = document.createElement('a');
                deleteOption.href = '#';
                deleteOption.className = 'block px-4 py-2 text-gray-700 hover:bg-gray-100';
                deleteOption.textContent = 'Delete';
                deleteOption.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleActionMenu(actionMenu);
                    if (confirm('Are you sure you want to delete this transcription?')) {
                        deleteTranscription(item.TranscriptionId);
                    }
                });
                actionMenu.appendChild(deleteOption);

                tdActions.appendChild(actionMenu);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });

            // Attach sorting event listeners
            const headers = document.querySelectorAll('.sort-header');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    sortTableByKey(key);
                });
            });
        }

        function addTableCell(tr, textContent) {
            const td = document.createElement('td');
            td.className = 'py-2 px-4 border-b';
            td.textContent = textContent;
            tr.appendChild(td);
        }

        function toggleActionMenu(menu) {
            closeAllActionMenus();
            menu.classList.toggle('hidden');
        }

        function closeAllActionMenus() {
            const menus = document.querySelectorAll('.action-menu');
            menus.forEach(menu => menu.classList.add('hidden'));
        }

        function showTranscription(transcriptionId, title) {
            console.log('Showing transcription:', transcriptionId);
            const data = {
                operation: 'read',
                TranscriptionId: transcriptionId,
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Read Response:', data);
                if (data.error) {
                    alert('Error fetching transcription: ' + data.error);
                } else {
                    const modal = document.getElementById('transcription-modal');
                    document.getElementById('transcription-modal-title').textContent = title || 'Transcription';
                    document.getElementById('transcription-text').textContent = data.TranscriptionText || 'No transcription text available.';
                    modal.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching transcription');
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Copy to Clipboard
        document.getElementById('copy-button').addEventListener('click', function() {
            const transcriptionText = document.getElementById('transcription-text').textContent;
            navigator.clipboard.writeText(transcriptionText)
                .then(() => {
                    alert('Transcription copied to clipboard');
                })
                .catch(err => {
                    console.error('Error copying text: ', err);
                    alert('Error copying transcription');
                });
        });

        function openEditModal(item) {
            console.log('Editing transcription:', item.TranscriptionId);
            document.getElementById('edit-transcription-id').value = item.TranscriptionId;
            document.getElementById('edit-title').value = item.Title || '';
            document.getElementById('edit-type').value = item.Type || '';
            document.getElementById('edit-subtype').value = item.Subtype || '';
            document.getElementById('edit-department').value = item.Department || '';
            // Add other fields as necessary
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        // Handle Edit Form Submission
        document.getElementById('edit-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const transcriptionId = document.getElementById('edit-transcription-id').value;
            const data = {
                operation: 'update',
                TranscriptionId: transcriptionId,
                Title: document.getElementById('edit-title').value,
                Type: document.getElementById('edit-type').value,
                Subtype: document.getElementById('edit-subtype').value,
                Department: document.getElementById('edit-department').value,
                // Add other fields as necessary
            };

            // Disable the submit button and change text to "Saving..."
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = 'Saving...';

            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Update Response:', data);
                if (data.error) {
                    alert('Error updating transcription: ' + data.error);
                } else {
                    alert('Transcription updated successfully');
                    closeModal('edit-modal');
                    fetchAllTranscriptions();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating transcription');
            })
            .finally(() => {
                // Re-enable the submit button and restore its text
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            });
        });

        function deleteTranscription(transcriptionId) {
            console.log('Deleting transcription:', transcriptionId);
            const data = {
                operation: 'delete',
                TranscriptionId: transcriptionId,
            };
            fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Delete Response:', data);
                if (data.error) {
                    alert('Error deleting transcription: ' + data.error);
                } else {
                    alert('Transcription deleted successfully');
                    fetchAllTranscriptions();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting transcription');
            });
        }

        // Sorting Functionality
        function sortTableByKey(key) {
            const direction = sortDirection[key] === 'asc' ? 'desc' : 'asc';
            sortDirection[key] = direction;
            transcriptions.sort((a, b) => {
                let valA = a[key] || '';
                let valB = b[key] || '';
                if (key === 'CreatedAt') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else {
                    valA = valA.toString().toLowerCase();
                    valB = valB.toString().toLowerCase();
                }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            updateSortIndicators(key, direction);
            renderTranscriptionsTable(transcriptions);
        }

        function updateSortIndicators(activeKey, direction) {
            const headers = document.querySelectorAll('.sort-header');
            headers.forEach(header => {
                const key = header.getAttribute('data-key');
                const indicator = header.querySelector('.sort-indicator');
                if (key === activeKey) {
                    indicator.innerHTML = direction === 'asc' ? '&uarr;' : '&darr;';
                } else {
                    indicator.innerHTML = '';
                }
            });
        }

        // Search (Filtering) Functionality
        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            const filteredTranscriptions = transcriptions.filter(item => {
                return (
                    (item.Title && item.Title.toLowerCase().includes(searchTerm)) ||
                    (item.Type && item.Type.toLowerCase().includes(searchTerm)) ||
                    (item.Subtype && item.Subtype.toLowerCase().includes(searchTerm)) ||
                    (item.Department && item.Department.toLowerCase().includes(searchTerm))
                );
            });
            renderTranscriptionsTable(filteredTranscriptions);
        }

        // Format date to human-readable format
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return dateString; // Return original if invalid date
            return date.toISOString().split('.')[0] + 'Z'; // Format as 'YYYY-MM-DDTHH:mm:ssZ'
        }

        // Function to open modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // Function to close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function initializeTranscriptionModal() {
            'use strict';
            // Initialize Variables
            let selectedFile = null;
            let cancelTokenSource = null;
            let transcriptionInProgress = false;
            let transcriptionStartTime = null;
            let transcriptionTimerInterval = null;

            // DOM Elements
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileUploadContent = document.getElementById('fileUploadContent');
            const transcriptionForm = document.getElementById('transcriptionForm');
            const submitButton = document.getElementById('submitButton');
            const cancelButton = document.getElementById('cancelButton');
            const loader = document.getElementById('loader');
            const resultSection = document.getElementById('result');
            const transcriptionText = document.getElementById('transcriptionText');
            const copyButton = document.getElementById('copyButton');
            const downloadButton = document.getElementById('downloadButton');
            const saveTranscriptionButton = document.getElementById('saveTranscriptionButton');
            const uploadProgressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('progressBar');
            const characterCount = document.getElementById('characterCount');
            const fileAudioPreview = document.getElementById('fileAudioPreview');
            const fileAudioPlayer = document.getElementById('fileAudioPlayer');
            const audioUrlInput = document.getElementById('audioUrl');
            const audioUrlError = document.getElementById('audioUrlError');
            const urlAudioPreview = document.getElementById('urlAudioPreview');
            const urlAudioPlayer = document.getElementById('urlAudioPlayer');
            const transcriptionTimer = document.getElementById('transcriptionTimer');
            const transcriptionProgressBar = document.getElementById('transcriptionProgressBar');
            const transcriptionProgressText = document.getElementById('transcriptionProgressText');

            // Supported audio formats
            const allowedExtensions = ['mp3', 'wav', 'ogg', 'mp4', 'mov'];

            // Handle File Input Change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                validateForm();
            });
            // Drag and Drop Events
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('border-blue-500');
            });
            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('border-blue-500');
            });
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('border-blue-500');
                handleFiles(e.dataTransfer.files);
                validateForm();
            });
            // Handle Files
            const handleFiles = (files) => {
                selectedFile = files[0];
                if (selectedFile) {
                    // Validate File Size
                    const MAX_SIZE = 2 * 1024 * 1024 * 1024; // 2GB
                    if (selectedFile.size > MAX_SIZE) {
                        alert('The file size exceeds the maximum limit of 2GB.');
                        selectedFile = null;
                        fileInput.value = '';
                        updateFileUploadArea();
                        validateForm();
                        return;
                    }
                    // Validate File Type
                    const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
                    if (!allowedExtensions.includes(fileExtension)) {
                        alert('Unsupported file format. Please upload an MP3, WAV, OGG, MP4, or MOV audio file.');
                        selectedFile = null;
                        fileInput.value = '';
                        updateFileUploadArea();
                        validateForm();
                        return;
                    }
                    getAudioDuration(selectedFile);
                }
            };

            // Get Audio Duration and preview
            const getAudioDuration = (file) => {
                const url = URL.createObjectURL(file);
                const audio = new Audio();
                audio.src = url;
                audio.addEventListener('loadedmetadata', () => {
                    const duration = audio.duration;
                    updateFileUploadArea(duration);
                    // Display audio player for preview
                    fileAudioPlayer.src = url;
                    fileAudioPreview.classList.remove('hidden');
                    audioUrlInput.disabled = true; // Disable URL input when file is selected
                    validateForm();
                });
                audio.addEventListener('error', () => {
                    alert('Failed to load audio file.');
                    selectedFile = null;
                    fileInput.value = '';
                    updateFileUploadArea();
                    fileAudioPreview.classList.add('hidden');
                    URL.revokeObjectURL(url);
                    validateForm();
                });
            };

            // Update File Upload Area
            const updateFileUploadArea = (duration = null) => {
                if (selectedFile) {
                    let durationText = '';
                    if (duration) {
                        const minutes = Math.floor(duration / 60);
                        const seconds = Math.floor(duration % 60);
                        durationText = `Duration: ${minutes}m ${seconds}s`;
                    }
                    const fileSize = formatFileSize(selectedFile.size);
                    fileUploadArea.innerHTML = `
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Selected File:</p>
                            <p class="text-sm font-medium text-gray-900">${selectedFile.name}</p>
                            <p class="text-sm text-gray-600">${durationText}</p>
                            <p class="text-sm text-gray-600">Size: ${fileSize}</p>
                        </div>
                    `;
                } else {
                    fileUploadArea.innerHTML = fileUploadContent.innerHTML;
                    fileAudioPreview.classList.add('hidden');
                    audioUrlInput.disabled = false; // Enable URL input when no file is selected
                }
            };

            // Format File Size
            const formatFileSize = (bytes) => {
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                if (bytes === 0) return '0 Byte';
                const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
            };

            // Validate Audio URL Input
            audioUrlInput.addEventListener('input', () => {
                validateAudioUrl();
                validateForm();
            });
            audioUrlInput.addEventListener('blur', () => {
                validateAudioUrl();
                validateForm();
            });
            const validateAudioUrl = () => {
                const audioUrl = audioUrlInput.value.trim();
                audioUrlError.classList.add('hidden');
                audioUrlInput.classList.remove('border-red-500', 'text-red-600');
                if (!audioUrl) {
                    urlAudioPreview.classList.add('hidden');
                    urlAudioPlayer.src = '';
                    return false;
                }
                try {
                    const url = new URL(audioUrl);
                    const extension = url.pathname.split('.').pop().toLowerCase().split('?')[0];
                    if (!allowedExtensions.includes(extension)) {
                        throw new Error('Unsupported audio file format.');
                    }
                    testAudioUrl(audioUrl);
                    fileInput.disabled = true; // Disable file input when URL is provided
                    return true;
                } catch (error) {
                    audioUrlError.textContent = 'Invalid URL or unsupported audio format.';
                    audioUrlError.classList.remove('hidden');
                    audioUrlInput.classList.add('border-red-500', 'text-red-600');
                    urlAudioPreview.classList.add('hidden');
                    urlAudioPlayer.src = '';
                    fileInput.disabled = false;
                    return false;
                }
            };
            const testAudioUrl = (url) => {
                urlAudioPlayer.src = url;
                urlAudioPreview.classList.remove('hidden');
                urlAudioPlayer.addEventListener('loadedmetadata', function onLoadMetadata() {
                    urlAudioPlayer.removeEventListener('loadedmetadata', onLoadMetadata);
                    validateForm();
                });
                urlAudioPlayer.addEventListener('error', function onError() {
                    alert('Unable to load audio from the provided URL.');
                    audioUrlError.textContent = 'Unable to load audio from the provided URL.';
                    audioUrlError.classList.remove('hidden');
                    audioUrlInput.classList.add('border-red-500', 'text-red-600');
                    urlAudioPreview.classList.add('hidden');
                    urlAudioPlayer.src = '';
                    urlAudioPlayer.removeEventListener('error', onError);
                    fileInput.disabled = false;
                    validateForm();
                }, { once: true });
            };

            // Validate Form
            const validateForm = () => {
                const isFileSelected = !!selectedFile;
                const audioUrl = audioUrlInput.value.trim();
                const isAudioUrlValid = audioUrl ? validateAudioUrl() : false;
                if (isFileSelected || isAudioUrlValid) {
                    submitButton.disabled = false;
                } else {
                    submitButton.disabled = true;
                }
            };

            // Handle Form Submission
            transcriptionForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (transcriptionInProgress) return;
                const audioUrlInputValue = audioUrlInput.value.trim();
                let audioUrl = audioUrlInputValue;
                const isAudioUrlValid = validateAudioUrl();
                const isFileSelected = !!selectedFile;
                if (!isFileSelected && !isAudioUrlValid) {
                    alert('Please select an audio file or enter a valid audio URL to transcribe.');
                    validateForm();
                    return;
                }
                transcriptionInProgress = true;
                cancelButton.disabled = false;
                submitButton.textContent = 'Transcribing...';
                submitButton.disabled = true;
                loader.classList.remove('hidden');
                resultSection.classList.add('hidden');
                transcriptionText.textContent = '';
                characterCount.textContent = '';
                transcriptionProgressBar.style.width = '0%';
                transcriptionProgressText.textContent = 'Starting transcription...';
                // Start Timer
                transcriptionStartTime = Date.now();
                updateTranscriptionTimer();
                transcriptionTimerInterval = setInterval(updateTranscriptionTimer, 1000);
                // Show upload progress bar if file is being uploaded
                if (selectedFile) {
                    uploadProgressContainer.classList.remove('hidden');
                    progressBar.style.width = '0%';
                }
                // Create cancel token for Axios
                cancelTokenSource = axios.CancelToken.source();
                try {
                    if (selectedFile) {
                        // Step 1: Request a pre-signed URL for file upload
                        const presignResponse = await axios.post('https://xgvm4vnzjnwodou462vkpdttnm0slvnk.lambda-url.us-west-2.on.aws/', {
                            filename: selectedFile.name,
                            content_type: selectedFile.type
                        }, {
                            cancelToken: cancelTokenSource.token,
                        });
                        const presignedUrl = presignResponse.data.presigned_url;
                        audioUrl = presignResponse.data.url;
                        // Step 2: Upload the file to S3 via the pre-signed URL
                        await axios.put(presignedUrl, selectedFile, {
                            headers: {
                                'Content-Type': selectedFile.type,
                            },
                            onUploadProgress: (progressEvent) => {
                                const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                                updateProgressBar(percentCompleted);
                            },
                            cancelToken: cancelTokenSource.token,
                        });
                        // Reset file input
                        selectedFile = null;
                        fileInput.value = '';
                        updateFileUploadArea();
                        fileAudioPreview.classList.add('hidden');
                        fileInput.disabled = false;
                    }
                    // Step 3: Send the audio URL to the transcription service
                    await simulateTranscriptionProgress(); // Simulate transcription progress
                    const transcriptionResponse = await axios.post('https://couztu3rsftq7h3utoskwl6sxm0jneti.lambda-url.us-west-2.on.aws/', {
                        audio_url: audioUrl
                    }, {
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        cancelToken: cancelTokenSource.token,
                    });
                    transcriptionText.textContent = transcriptionResponse.data.transcription;
                    resultSection.classList.remove('hidden');
                    const transcriptionLength = transcriptionResponse.data.transcription.length;
                    characterCount.textContent = `Character count: ${transcriptionLength}`;
                    alert('Your audio has been successfully transcribed.');
                } catch (error) {
                    if (axios.isCancel(error)) {
                        alert('The transcription process has been canceled.');
                    } else {
                        const errorMessage = error.response?.data?.message || 'An error occurred while transcribing the audio.';
                        alert(errorMessage);
                    }
                } finally {
                    transcriptionInProgress = false;
                    cancelButton.disabled = true;
                    submitButton.textContent = 'Transcribe';
                    submitButton.disabled = true;
                    loader.classList.add('hidden');
                    uploadProgressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    urlAudioPreview.classList.add('hidden');
                    urlAudioPlayer.src = '';
                    clearInterval(transcriptionTimerInterval);
                    transcriptionTimer.textContent = 'Elapsed Time: 00:00';
                    transcriptionProgressBar.style.width = '0%';
                    transcriptionProgressText.textContent = '';
                    validateForm();
                }
            });

            // Update Transcription Timer
            const updateTranscriptionTimer = () => {
                const elapsedTime = Date.now() - transcriptionStartTime;
                const minutes = Math.floor(elapsedTime / 60000);
                const seconds = Math.floor((elapsedTime % 60000) / 1000);
                transcriptionTimer.textContent = `Elapsed Time: ${padZero(minutes)}:${padZero(seconds)}`;
            };
            const padZero = (num) => {
                return num.toString().padStart(2, '0');
            };

            // Simulate Transcription Progress
            const simulateTranscriptionProgress = async () => {
                let percentCompleted = 0;
                while (percentCompleted < 100) {
                    await new Promise((resolve) => setTimeout(resolve, 1000));
                    percentCompleted += Math.floor(Math.random() * 10) + 5; // Increase by 5-15%
                    if (percentCompleted > 100) percentCompleted = 100;
                    transcriptionProgressBar.style.width = percentCompleted + '%';
                    transcriptionProgressText.textContent = `Transcription Progress: ${percentCompleted}%`;
                }
            };

            // Cancel Transcription
            cancelButton.addEventListener('click', () => {
                if (transcriptionInProgress && cancelTokenSource) {
                    cancelTokenSource.cancel('User canceled the transcription.');
                }
            });

            // Copy to Clipboard
            copyButton.addEventListener('click', () => {
                const transcriptionContent = transcriptionText.textContent;
                navigator.clipboard.writeText(transcriptionContent).then(() => {
                    alert('The transcription has been copied to your clipboard.');
                }).catch((err) => {
                    alert('Failed to copy the transcription to your clipboard.');
                });
            });

            // Download Transcription
            downloadButton.addEventListener('click', () => {
                const transcriptionContent = transcriptionText.textContent;
                const blob = new Blob([transcriptionContent], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'transcription.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // Save Transcription
            saveTranscriptionButton.addEventListener('click', () => {
                const transcriptionContent = transcriptionText.textContent;
                if (!transcriptionContent) {
                    alert('No transcription content to save.');
                    return;
                }
                // Collect additional metadata if needed
                const title = prompt('Enter a title for this transcription:', 'Untitled Transcription');
                if (title === null) {
                    // User cancelled the prompt
                    return;
                }

                // Save the transcription to the backend
                const data = {
                    operation: 'create',
                    Title: title,
                    TranscriptionText: transcriptionContent,
                    // Add any other fields as necessary
                };
                fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Create Response:', data);
                    if (data.error) {
                        alert('Error saving transcription: ' + data.error);
                    } else {
                        alert('Transcription saved successfully');
                        // Close the modal
                        closeModal('add-transcription-modal');
                        // Fetch all transcriptions to update the table
                        fetchAllTranscriptions();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving transcription');
                });
            });

            // Update Progress Bar
            const updateProgressBar = (percent) => {
                progressBar.style.width = percent + '%';
            };
        }
    </script>
</body>
</html>