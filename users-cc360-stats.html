<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Users List</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>

<body>

    <div class="px-4 sm:px-6 lg:px-8">

        <div class="flex justify-between items-center py-4">

            <div>

                <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>

                <input type="date" id="startDate" name="startDate" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">

            </div>

            <div>

                <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>

                <input type="date" id="endDate" name="endDate" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">

            </div>

            <button id="fetchData" class="ml-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Fetch Data</button>

        </div>



        <div class="flex justify-between items-center py-4">

            <div class="bg-white shadow rounded-lg p-4 w-1/2 mr-2">

                <h3 class="text-lg leading-6 font-medium text-gray-900">MailGun Connected</h3>

                <div class="mt-2 flex items-baseline text-2xl font-semibold text-indigo-600" id="mailgunPercentage">0%</div>

                <div class="text-sm text-gray-500" id="mailgunCount">0 of 0</div>

            </div>

            <div class="bg-white shadow rounded-lg p-4 w-1/2 ml-2">

                <h3 class="text-lg leading-6 font-medium text-gray-900">First Transaction Completed</h3>

                <div class="mt-2 flex items-baseline text-2xl font-semibold text-indigo-600" id="transactionPercentage">0%</div>

                <div class="text-sm text-gray-500" id="transactionCount">0 of 0</div>

            </div>

        </div>



        <div class="mt-8 flow-root">

            <div class="-mx-4 -my-2 sm:-mx-6 lg:-mx-8">

                <div class="inline-block min-w-full py-2 align-middle">

                    <table class="min-w-full border-separate border-spacing-0">

                        <thead>

                            <tr>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter sm:pl-6 lg:pl-8">Location Name</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter cursor-pointer" id="sortIncome30Days">Last 30 Day Income</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter cursor-pointer" id="sortIncome90Days">Last 90 Day Income</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter cursor-pointer" id="sortIncome7Days">Last 7 Day Income</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter cursor-pointer" id="sortIncomeAllTime">All Time Income</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter">Total Calendars</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter">Total Products</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter">Relative Created Time</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter">Relative Time to Revenue</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter cursor-pointer" id="sortFirstTransaction">First Transaction</th>

                                <th scope="col" class="sticky top-0 z-10 border-b border-gray-300 bg-white bg-opacity-75 px-3 py-3.5 text-left text-sm font-semibold text-gray-900 backdrop-blur backdrop-filter">Mailgun Connected</th>

                            </tr>

                        </thead>

                        <tbody id="usersTable">

                            <!-- Users data will be inserted here -->

                        </tbody>

                    </table>

                </div>

            </div>

        </div>

    </div>



<script>

    let users = [];

    let sortField = null;

    let sortDirection = 1; // 1: ascending, -1: descending



    document.getElementById('fetchData').addEventListener('click', function() {

        const startDate = document.getElementById('startDate').value;

        const endDate = document.getElementById('endDate').value;



        if (!startDate || !endDate) {

            alert('Please select both start and end dates.');

            return;

        }



        axios.post('https://rozduvvh2or5rxgucec3rfdp5e0hupbk.lambda-url.us-west-2.on.aws/', {

            startDate: startDate,

            endDate: endDate

        }, {

            headers: {

                'Content-Type': 'application/json'

            }

        })

        .then(function (response) {

            console.log("Sample data:", response.data[0]); // Log the first data object
            console.log(response.data)
            users = response.data.map(user => ({

                ...user,

                mailgun_connected: user.mailgun_connected === "true",

                has_had_first_transaction: user.has_had_first_transaction === "true"

            }));

            renderTable(users);

            updateCards(users);

        })

        .catch(function (error) {

            console.error('Error fetching users:', error);

        });

    });



    document.querySelectorAll('[id^="sort"]').forEach(element => {

        element.addEventListener('click', function() {

            let field = this.id.replace('sort', '').replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, ''); // Convert camelCase to snake_case

            // Adjust field names based on actual data properties

            switch (field) {

                case 'income_30_days':

                    field = 'last_thirty_day_income';

                    break;

                case 'income_90_days':

                    field = 'last_ninety_day_income';

                    break;

                case 'income_7_days':

                    field = 'last_seven_day_income';

                    break;

                case 'income_all_time':

                    field = 'income_all_time';

                    break;

            }

            console.log("Sorting by field:", field); // Debug: Check which field is being sorted



            if (sortField === field) {

                sortDirection *= -1; // Toggle the direction

            } else {

                sortField = field;

                sortDirection = -1; // Default to descending for all fields initially

            }



            users.sort((a, b) => {

                let valA = parseFloat(a[field]);

                let valB = parseFloat(b[field]);



                console.log(`Comparing ${valA} to ${valB}`); // Debug: Log values being compared



                if (isNaN(valA) || isNaN(valB)) {

                    // Fallback for non-numeric or missing data

                    return 0; // or handle differently as per requirement

                } else {

                    // Numeric sorting

                    return (valA < valB ? -1 : 1) * sortDirection;

                }

            });



            renderTable(users);

        });

    });



    function renderTable(users) {

        const tableBody = document.getElementById('usersTable');

        tableBody.innerHTML = ''; // Clear existing rows

        users.forEach(user => {

            const tr = document.createElement('tr');

            tr.innerHTML = `

                <td class="whitespace-nowrap border-b border-gray-200 py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6 lg:pl-8">${user.location_name}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm font-medium text-gray-900">${formatIncome(user.last_thirty_day_income)}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm font-medium text-gray-900">${formatIncome(user.last_ninety_day_income)}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm font-medium text-gray-900">${formatIncome(user.last_seven_day_income)}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm font-medium text-gray-900">${formatIncome(user.income_all_time)}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm text-gray-500">${user.total_calendars}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm text-gray-500">${user.total_products}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm text-gray-500">${user.relative_created_time}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm text-gray-500">${user.relative_time_to_revenue || 'N/A'}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm text-gray-500">${formatFirstTransaction(user.has_had_first_transaction)}</td>

                <td class="whitespace-nowrap border-b border-gray-200 px-3 py-4 text-sm text-gray-500">${formatMailgunConnected(user.mailgun_connected)}</td>

            `;

            tableBody.appendChild(tr);

        });

    }



    function formatMailgunConnected(isConnected) {

        if (isConnected) {

            return `<span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Yes</span>`;

        } else {

            return `<span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/20">No</span>`;

        }

    }



    function formatIncome(income) {

        if (parseFloat(income) === 0) {

            return `<span class="text-gray-500">$${parseFloat(income).toLocaleString()}</span>`;

        } else {

            return `<strong>$${parseFloat(income).toLocaleString()}</strong>`;

        }

    }



    function formatFirstTransaction(hasTransaction) {

        if (hasTransaction) {

            return `<span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Yes</span>`;

        } else {

            return `<span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/20">No</span>`;

        }

    }



    function updateCards(users) {

        const totalUsers = users.length;

        const mailgunConnectedCount = users.filter(user => user.mailgun_connected).length;

        const firstTransactionCount = users.filter(user => user.has_had_first_transaction).length;



        const mailgunPercentage = (mailgunConnectedCount / totalUsers * 100).toFixed(2);

        const transactionPercentage = (firstTransactionCount / totalUsers * 100).toFixed(2);



        document.getElementById('mailgunPercentage').innerText = `${mailgunPercentage}%`;

        document.getElementById('mailgunCount').innerText = `${mailgunConnectedCount} of ${totalUsers}`;



        document.getElementById('transactionPercentage').innerText = `${transactionPercentage}%`;

        document.getElementById('transactionCount').innerText = `${firstTransactionCount} of ${totalUsers}`;

    }

</script>

</body>

</html>
